<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ | rand0m's blog</title><meta name=keywords content="Go,Bug"><meta name=description content='Helloï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„Goè¯­è¨€å­¦ä¹ ç¬”è®°ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹Goè¯­è¨€ä¸­ä¸€äº›å¸¸è§é”™è¯¯ï¼Œä»¥åŠä¸€äº›å®¹æ˜“è¢«äººè¯¯è§£çš„åœ°æ–¹ã€‚ï¼ˆå¦å¤–ï¼Œä¹Ÿæ¬¢å¤§å®¶è¿æµè§ˆæˆ‘çš„ä¸Šä¸€ç¯‡ç¬”è®°ï¼šè¯¦è§£Go TestingğŸ˜€ï¼‰
ä¸ºäº†çªå‡ºé—®é¢˜ï¼Œä¸‹é¢ä¸¾çš„æŸäº›ä¾‹å­å¯èƒ½æ¯”è¾ƒæç«¯ï¼Œè¿˜æœ›å¤§å®¶ä¸è¦çº ç»“ä¾‹å­çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜ç™½å…¶ä¸­çš„é”™è¯¯åŸå› å³å¯ã€‚å¦å¤–ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ç¤ºä¾‹ğŸ«µã€‚
BugsğŸ
å˜é‡é®è”½ï¼ˆshadowingï¼‰ğŸ¥·ğŸ¿
åœ¨ Go ä¸­ï¼Œå˜é‡é®è”½ï¼ˆvariable shadowingï¼‰æŒ‡çš„æ˜¯åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­å£°æ˜ä¸€ä¸ªä¸å¤–éƒ¨ä½œç”¨åŸŸä¸­åŒåçš„å˜é‡ï¼Œä»è€Œè¦†ç›–äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚è¿™ç§bugæ¯”è¾ƒä½çº§ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°åœ¨æ¯”è¾ƒè´Ÿè½½çš„å‡½æ•°é‡Œï¼Œè€Œä¸”æ¯”è¾ƒéšè”½ï¼Œä¸å®¹æ˜“è¢«å‘ç°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒfindTargetä»ç»™å®šstrsä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªtargetï¼Œè¿”å›ç´¢å¼•ã€‚ä½†æ˜¯è¿™ä¸ªç®€å•çš„å‡½æ•°å­˜åœ¨å˜é‡é®è”½çš„bugï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯-1ã€‚
func findTarget(strs []string, target string) (i int) {
        i = -1
        for i := 0; i < len(strs); i++ {
                if strs[i] == target {
                        break
                }
        }
        return i
}
å±é™©çš„mapğŸ˜ˆ
æœªåˆå§‹åŒ–
Goè¯­è¨€ä¸­æœªåˆå§‹åŒ–çš„å˜é‡çš„å€¼ä¸ºæ­¤å˜é‡ç±»å‹çš„é»˜è®¤å€¼ï¼Œmapçš„é»˜è®¤å€¼ä¸ºnilï¼Œè¯»å€¼ä¸ºnilçš„mapæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹nilçš„mapè¿›è¡Œå†™æ“ä½œä¼šå¼•å‘Panicã€‚(åˆ°Go Playroundè¿è¡Œ)
func main() {
    var m map[string]int

    // read from nil map, should not panic
    println(m["a"])

    // write to nil map, panic!!!
    m["a"] = 1

    println(m["a"])
}
å¹¶è¡Œè¯»å†™map
Goè¯­è¨€çš„ç¦æ­¢å¤šä¸ªgoroutineåŒæ—¶è¯»å’Œå†™mapï¼ˆä¼šå¼•å‘Panicï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰å¹¶è¡Œæ“ä½œmapçš„éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨é”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¹¶è¡Œè¯»å†™mapçš„ç¤ºä¾‹ï¼Œç¨‹åºä¼šPanicï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚'><meta name=author content="rand0m"><link rel=canonical href=https://rand0m42195.github.io/posts/go-pitfall-guide/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://rand0m42195.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rand0m42195.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rand0m42195.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://rand0m42195.github.io/apple-touch-icon.png><link rel=mask-icon href=https://rand0m42195.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rand0m42195.github.io/posts/go-pitfall-guide/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://rand0m42195.github.io/posts/go-pitfall-guide/"><meta property="og:site_name" content="rand0m's blog"><meta property="og:title" content="Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ"><meta property="og:description" content='Helloï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„Goè¯­è¨€å­¦ä¹ ç¬”è®°ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹Goè¯­è¨€ä¸­ä¸€äº›å¸¸è§é”™è¯¯ï¼Œä»¥åŠä¸€äº›å®¹æ˜“è¢«äººè¯¯è§£çš„åœ°æ–¹ã€‚ï¼ˆå¦å¤–ï¼Œä¹Ÿæ¬¢å¤§å®¶è¿æµè§ˆæˆ‘çš„ä¸Šä¸€ç¯‡ç¬”è®°ï¼šè¯¦è§£Go TestingğŸ˜€ï¼‰
ä¸ºäº†çªå‡ºé—®é¢˜ï¼Œä¸‹é¢ä¸¾çš„æŸäº›ä¾‹å­å¯èƒ½æ¯”è¾ƒæç«¯ï¼Œè¿˜æœ›å¤§å®¶ä¸è¦çº ç»“ä¾‹å­çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜ç™½å…¶ä¸­çš„é”™è¯¯åŸå› å³å¯ã€‚å¦å¤–ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ç¤ºä¾‹ğŸ«µã€‚
BugsğŸ å˜é‡é®è”½ï¼ˆshadowingï¼‰ğŸ¥·ğŸ¿ åœ¨ Go ä¸­ï¼Œå˜é‡é®è”½ï¼ˆvariable shadowingï¼‰æŒ‡çš„æ˜¯åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­å£°æ˜ä¸€ä¸ªä¸å¤–éƒ¨ä½œç”¨åŸŸä¸­åŒåçš„å˜é‡ï¼Œä»è€Œè¦†ç›–äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚è¿™ç§bugæ¯”è¾ƒä½çº§ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°åœ¨æ¯”è¾ƒè´Ÿè½½çš„å‡½æ•°é‡Œï¼Œè€Œä¸”æ¯”è¾ƒéšè”½ï¼Œä¸å®¹æ˜“è¢«å‘ç°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒfindTargetä»ç»™å®šstrsä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªtargetï¼Œè¿”å›ç´¢å¼•ã€‚ä½†æ˜¯è¿™ä¸ªç®€å•çš„å‡½æ•°å­˜åœ¨å˜é‡é®è”½çš„bugï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯-1ã€‚
func findTarget(strs []string, target string) (i int) { i = -1 for i := 0; i < len(strs); i++ { if strs[i] == target { break } } return i } å±é™©çš„mapğŸ˜ˆ æœªåˆå§‹åŒ– Goè¯­è¨€ä¸­æœªåˆå§‹åŒ–çš„å˜é‡çš„å€¼ä¸ºæ­¤å˜é‡ç±»å‹çš„é»˜è®¤å€¼ï¼Œmapçš„é»˜è®¤å€¼ä¸ºnilï¼Œè¯»å€¼ä¸ºnilçš„mapæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹nilçš„mapè¿›è¡Œå†™æ“ä½œä¼šå¼•å‘Panicã€‚(åˆ°Go Playroundè¿è¡Œ)
func main() { var m map[string]int // read from nil map, should not panic println(m["a"]) // write to nil map, panic!!! m["a"] = 1 println(m["a"]) } å¹¶è¡Œè¯»å†™map Goè¯­è¨€çš„ç¦æ­¢å¤šä¸ªgoroutineåŒæ—¶è¯»å’Œå†™mapï¼ˆä¼šå¼•å‘Panicï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰å¹¶è¡Œæ“ä½œmapçš„éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨é”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¹¶è¡Œè¯»å†™mapçš„ç¤ºä¾‹ï¼Œç¨‹åºä¼šPanicï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚'><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-14T07:55:34+08:00"><meta property="article:modified_time" content="2025-10-14T07:55:34+08:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Bug"><meta name=twitter:card content="summary"><meta name=twitter:title content="Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ"><meta name=twitter:description content='Helloï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„Goè¯­è¨€å­¦ä¹ ç¬”è®°ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹Goè¯­è¨€ä¸­ä¸€äº›å¸¸è§é”™è¯¯ï¼Œä»¥åŠä¸€äº›å®¹æ˜“è¢«äººè¯¯è§£çš„åœ°æ–¹ã€‚ï¼ˆå¦å¤–ï¼Œä¹Ÿæ¬¢å¤§å®¶è¿æµè§ˆæˆ‘çš„ä¸Šä¸€ç¯‡ç¬”è®°ï¼šè¯¦è§£Go TestingğŸ˜€ï¼‰
ä¸ºäº†çªå‡ºé—®é¢˜ï¼Œä¸‹é¢ä¸¾çš„æŸäº›ä¾‹å­å¯èƒ½æ¯”è¾ƒæç«¯ï¼Œè¿˜æœ›å¤§å®¶ä¸è¦çº ç»“ä¾‹å­çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜ç™½å…¶ä¸­çš„é”™è¯¯åŸå› å³å¯ã€‚å¦å¤–ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ç¤ºä¾‹ğŸ«µã€‚
BugsğŸ
å˜é‡é®è”½ï¼ˆshadowingï¼‰ğŸ¥·ğŸ¿
åœ¨ Go ä¸­ï¼Œå˜é‡é®è”½ï¼ˆvariable shadowingï¼‰æŒ‡çš„æ˜¯åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­å£°æ˜ä¸€ä¸ªä¸å¤–éƒ¨ä½œç”¨åŸŸä¸­åŒåçš„å˜é‡ï¼Œä»è€Œè¦†ç›–äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚è¿™ç§bugæ¯”è¾ƒä½çº§ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°åœ¨æ¯”è¾ƒè´Ÿè½½çš„å‡½æ•°é‡Œï¼Œè€Œä¸”æ¯”è¾ƒéšè”½ï¼Œä¸å®¹æ˜“è¢«å‘ç°ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒfindTargetä»ç»™å®šstrsä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªtargetï¼Œè¿”å›ç´¢å¼•ã€‚ä½†æ˜¯è¿™ä¸ªç®€å•çš„å‡½æ•°å­˜åœ¨å˜é‡é®è”½çš„bugï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯-1ã€‚
func findTarget(strs []string, target string) (i int) {
        i = -1
        for i := 0; i < len(strs); i++ {
                if strs[i] == target {
                        break
                }
        }
        return i
}
å±é™©çš„mapğŸ˜ˆ
æœªåˆå§‹åŒ–
Goè¯­è¨€ä¸­æœªåˆå§‹åŒ–çš„å˜é‡çš„å€¼ä¸ºæ­¤å˜é‡ç±»å‹çš„é»˜è®¤å€¼ï¼Œmapçš„é»˜è®¤å€¼ä¸ºnilï¼Œè¯»å€¼ä¸ºnilçš„mapæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹nilçš„mapè¿›è¡Œå†™æ“ä½œä¼šå¼•å‘Panicã€‚(åˆ°Go Playroundè¿è¡Œ)
func main() {
    var m map[string]int

    // read from nil map, should not panic
    println(m["a"])

    // write to nil map, panic!!!
    m["a"] = 1

    println(m["a"])
}
å¹¶è¡Œè¯»å†™map
Goè¯­è¨€çš„ç¦æ­¢å¤šä¸ªgoroutineåŒæ—¶è¯»å’Œå†™mapï¼ˆä¼šå¼•å‘Panicï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰å¹¶è¡Œæ“ä½œmapçš„éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨é”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¹¶è¡Œè¯»å†™mapçš„ç¤ºä¾‹ï¼Œç¨‹åºä¼šPanicï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rand0m42195.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ","item":"https://rand0m42195.github.io/posts/go-pitfall-guide/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ","name":"Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ","description":"Helloï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„Goè¯­è¨€å­¦ä¹ ç¬”è®°ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹Goè¯­è¨€ä¸­ä¸€äº›å¸¸è§é”™è¯¯ï¼Œä»¥åŠä¸€äº›å®¹æ˜“è¢«äººè¯¯è§£çš„åœ°æ–¹ã€‚ï¼ˆå¦å¤–ï¼Œä¹Ÿæ¬¢å¤§å®¶è¿æµè§ˆæˆ‘çš„ä¸Šä¸€ç¯‡ç¬”è®°ï¼šè¯¦è§£Go TestingğŸ˜€ï¼‰\nä¸ºäº†çªå‡ºé—®é¢˜ï¼Œä¸‹é¢ä¸¾çš„æŸäº›ä¾‹å­å¯èƒ½æ¯”è¾ƒæç«¯ï¼Œè¿˜æœ›å¤§å®¶ä¸è¦çº ç»“ä¾‹å­çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜ç™½å…¶ä¸­çš„é”™è¯¯åŸå› å³å¯ã€‚å¦å¤–ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ç¤ºä¾‹ğŸ«µã€‚\nBugsğŸ å˜é‡é®è”½ï¼ˆshadowingï¼‰ğŸ¥·ğŸ¿ åœ¨ Go ä¸­ï¼Œå˜é‡é®è”½ï¼ˆvariable shadowingï¼‰æŒ‡çš„æ˜¯åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­å£°æ˜ä¸€ä¸ªä¸å¤–éƒ¨ä½œç”¨åŸŸä¸­åŒåçš„å˜é‡ï¼Œä»è€Œè¦†ç›–äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚è¿™ç§bugæ¯”è¾ƒä½çº§ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°åœ¨æ¯”è¾ƒè´Ÿè½½çš„å‡½æ•°é‡Œï¼Œè€Œä¸”æ¯”è¾ƒéšè”½ï¼Œä¸å®¹æ˜“è¢«å‘ç°ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒfindTargetä»ç»™å®šstrsä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªtargetï¼Œè¿”å›ç´¢å¼•ã€‚ä½†æ˜¯è¿™ä¸ªç®€å•çš„å‡½æ•°å­˜åœ¨å˜é‡é®è”½çš„bugï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯-1ã€‚\nfunc findTarget(strs []string, target string) (i int) { i = -1 for i := 0; i \u0026lt; len(strs); i++ { if strs[i] == target { break } } return i } å±é™©çš„mapğŸ˜ˆ æœªåˆå§‹åŒ– Goè¯­è¨€ä¸­æœªåˆå§‹åŒ–çš„å˜é‡çš„å€¼ä¸ºæ­¤å˜é‡ç±»å‹çš„é»˜è®¤å€¼ï¼Œmapçš„é»˜è®¤å€¼ä¸ºnilï¼Œè¯»å€¼ä¸ºnilçš„mapæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹nilçš„mapè¿›è¡Œå†™æ“ä½œä¼šå¼•å‘Panicã€‚(åˆ°Go Playroundè¿è¡Œ)\nfunc main() { var m map[string]int // read from nil map, should not panic println(m[\u0026#34;a\u0026#34;]) // write to nil map, panic!!! m[\u0026#34;a\u0026#34;] = 1 println(m[\u0026#34;a\u0026#34;]) } å¹¶è¡Œè¯»å†™map Goè¯­è¨€çš„ç¦æ­¢å¤šä¸ªgoroutineåŒæ—¶è¯»å’Œå†™mapï¼ˆä¼šå¼•å‘Panicï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰å¹¶è¡Œæ“ä½œmapçš„éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨é”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¹¶è¡Œè¯»å†™mapçš„ç¤ºä¾‹ï¼Œç¨‹åºä¼šPanicï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\n","keywords":["Go","Bug"],"articleBody":"Helloï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„Goè¯­è¨€å­¦ä¹ ç¬”è®°ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹Goè¯­è¨€ä¸­ä¸€äº›å¸¸è§é”™è¯¯ï¼Œä»¥åŠä¸€äº›å®¹æ˜“è¢«äººè¯¯è§£çš„åœ°æ–¹ã€‚ï¼ˆå¦å¤–ï¼Œä¹Ÿæ¬¢å¤§å®¶è¿æµè§ˆæˆ‘çš„ä¸Šä¸€ç¯‡ç¬”è®°ï¼šè¯¦è§£Go TestingğŸ˜€ï¼‰\nä¸ºäº†çªå‡ºé—®é¢˜ï¼Œä¸‹é¢ä¸¾çš„æŸäº›ä¾‹å­å¯èƒ½æ¯”è¾ƒæç«¯ï¼Œè¿˜æœ›å¤§å®¶ä¸è¦çº ç»“ä¾‹å­çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜ç™½å…¶ä¸­çš„é”™è¯¯åŸå› å³å¯ã€‚å¦å¤–ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ç¤ºä¾‹ğŸ«µã€‚\nBugsğŸ å˜é‡é®è”½ï¼ˆshadowingï¼‰ğŸ¥·ğŸ¿ åœ¨ Go ä¸­ï¼Œå˜é‡é®è”½ï¼ˆvariable shadowingï¼‰æŒ‡çš„æ˜¯åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­å£°æ˜ä¸€ä¸ªä¸å¤–éƒ¨ä½œç”¨åŸŸä¸­åŒåçš„å˜é‡ï¼Œä»è€Œè¦†ç›–äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚è¿™ç§bugæ¯”è¾ƒä½çº§ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°åœ¨æ¯”è¾ƒè´Ÿè½½çš„å‡½æ•°é‡Œï¼Œè€Œä¸”æ¯”è¾ƒéšè”½ï¼Œä¸å®¹æ˜“è¢«å‘ç°ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒfindTargetä»ç»™å®šstrsä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªtargetï¼Œè¿”å›ç´¢å¼•ã€‚ä½†æ˜¯è¿™ä¸ªç®€å•çš„å‡½æ•°å­˜åœ¨å˜é‡é®è”½çš„bugï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯-1ã€‚\nfunc findTarget(strs []string, target string) (i int) { i = -1 for i := 0; i \u003c len(strs); i++ { if strs[i] == target { break } } return i } å±é™©çš„mapğŸ˜ˆ æœªåˆå§‹åŒ– Goè¯­è¨€ä¸­æœªåˆå§‹åŒ–çš„å˜é‡çš„å€¼ä¸ºæ­¤å˜é‡ç±»å‹çš„é»˜è®¤å€¼ï¼Œmapçš„é»˜è®¤å€¼ä¸ºnilï¼Œè¯»å€¼ä¸ºnilçš„mapæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹nilçš„mapè¿›è¡Œå†™æ“ä½œä¼šå¼•å‘Panicã€‚(åˆ°Go Playroundè¿è¡Œ)\nfunc main() { var m map[string]int // read from nil map, should not panic println(m[\"a\"]) // write to nil map, panic!!! m[\"a\"] = 1 println(m[\"a\"]) } å¹¶è¡Œè¯»å†™map Goè¯­è¨€çš„ç¦æ­¢å¤šä¸ªgoroutineåŒæ—¶è¯»å’Œå†™mapï¼ˆä¼šå¼•å‘Panicï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰å¹¶è¡Œæ“ä½œmapçš„éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨é”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¹¶è¡Œè¯»å†™mapçš„ç¤ºä¾‹ï¼Œç¨‹åºä¼šPanicï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\npackage main var m = make(map[string]int) func consumer() { for i := 0; i \u003c 100000; i++{ _ = m[\"x\"] } } func producer() { for i := 0; i \u003c 100000; i++ { m[\"y\"] = i } } func main() { go consumer() go producer() select {} } ä½†æ˜¯Goå…è®¸å¤šä¸ªgoroutineå¹¶è¡Œè¯»mapï¼Œå› æ­¤åœ¨è¯»æ“ä½œçš„æ€§èƒ½è¦æ±‚è¾ƒé«˜æ—¶ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¯»å†™é”ï¼ˆsync.RWMutexï¼‰ï¼›å¯¹å†™æ“ä½œæ€§èƒ½è¾ƒé«˜æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘å†™é”ï¼ˆsync.Mutexï¼‰ã€‚å¦å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨å°è£…å¥½çš„æ”¯æŒå¹¶å‘æ“ä½œçš„mapï¼ˆå¦‚sync.Mapï¼‰ã€‚\néš¾ä»¥æ‰æ‘¸çš„forå¾ªç¯ğŸ™‰ æ„æ–™ä¹‹å¤–çš„éå†ç»“æœ ä¸‹é¢çš„ç¤ºä¾‹éå†numsï¼Œå¹¶ä¸ºæ¯ä¸ªnumåˆ›å»ºä¸€ä¸ªgoroutineæ¥æ‰“å°numçš„å€¼ã€‚æœŸæœ›çš„è¾“å‡ºæ˜¯æ‰“å°[0,10)ï¼Œè¾“å‡ºé¡ºåºä¸ç¡®å®šã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\nfunc main() { n := 10 nums := make([]int, n) for i := 0; i \u003c n; i++ { nums[i] = i } // the output is not what you expect :( for _, num := range nums { go func() { println(num) }() } select {} } å¯¹äºè¾“å‡ºç»“æœæœ‰æ²¡æœ‰æ„Ÿåˆ°æ„å¤–ï¼Ÿå¦‚æœæ„Ÿåˆ°æ„å¤–ï¼Œè¯´æ˜ä½ è‡ªå·±ä¹Ÿå¯èƒ½ä¼šå†™å‡ºç±»å‹çš„ä»£ç ã€‚è¿™æ®µä»£ç é‡Œå­˜åœ¨ä¸€ä¸ªGoè¯­è¨€çš„ç»å…¸é”™è¯¯â€”â€”å¾ªç¯å˜é‡æ•è·ã€‚åœ¨ Go ä¸­ï¼Œé—­åŒ…ï¼ˆåŒ¿åå‡½æ•°ï¼‰å¯ä»¥è®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ã€‚å½“é—­åŒ…å†…éƒ¨å¼•ç”¨äº†å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡æ—¶ï¼Œå®é™…ä¸Šæ˜¯å¯¹è¯¥å˜é‡çš„å¼•ç”¨ï¼ˆè€Œä¸æ˜¯å€¼çš„æ‹·è´ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨å¾ªç¯ä¸­åˆ›å»ºäº†å¤šä¸ªé—­åŒ…ï¼Œå¹¶ä¸”è¿™äº›é—­åŒ…å…±äº«äº†å¾ªç¯å˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬å®é™…ä¸Šä¼šå…±äº«ç›¸åŒçš„å˜é‡ï¼Œè€Œä¸æ˜¯ç‹¬ç«‹çš„å‰¯æœ¬ã€‚\nä¿®å¤ä¸Šé¢çš„bugå¾ˆç®€å•ï¼Œåªéœ€è¦è®©foré‡Œé¢çš„åŒ¿åå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°å³å¯ï¼Œè¿™æ ·å°±èƒ½é¿å…å¾ªç¯å˜é‡æ•è·é”™è¯¯äº†ğŸ˜€ã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰\nfunc main() { // ...... // the output is what you expect :) for _, num := range nums { go func(num int) { // è¿™é‡Œå£°æ˜éœ€è¦ä¸€ä¸ªå‚æ•° println(num) }(num) // ä¼ é€’for rangeéå†çš„num } // ...... } æ„æ–™ä¹‹å¤–çš„æ­»å¾ªç¯ ä¸‹é¢æ˜¯ä¸€ä¸ªä»channelè¯»å–æ•°æ®ï¼Œç„¶åå¤„ç†çš„ä¾‹å­ï¼Œå¾ˆæ˜æ˜¾è¿™æ®µä»£ç æ°¸è¿œä¸ä¼šé€€å‡ºï¼Œä½†æ˜¯å½“channelè¢«å…³é—­åï¼Œå°±ä¼šé€ æˆå¾ªç¯ä¸ä¼šé˜»å¡ã€‚å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼ˆCPUã€å†…å­˜ç­‰ï¼‰ã€‚ï¼ˆGo Playgroundå®Œæ•´ä¾‹å­ï¼‰ã€‚\nfunc consumer(c chan int) { for { select { case n := \u003c-c: println(n) // other case ...... } } } è¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯å¯¹channelçš„æ“ä½œä¸ç†Ÿæ‚‰ï¼Œè¯»ä¸€ä¸ªè¢«closedçš„channelä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯è¯»channelå¯ä»¥ç”¨ä¸¤ä¸ªå˜é‡æ¥æ¥æ”¶ç»“æœï¼Œé€šè¿‡ç¬¬äºŒä¸ªå˜é‡åˆ¤æ–­æ˜¯å¦è¯»æˆåŠŸã€‚å› æ­¤è¿™ä¸ªä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šå­˜åœ¨æ­»å¾ªç¯äº†ã€‚ï¼ˆGo Playgroundå®Œæ•´ä¾‹å­ï¼‰ã€‚\nfunc consumer(c chan int) { for { select { case i, ok := \u003c-c: if !ok { println(\"channel closed\") return } println(i) // other case ...... } } } æ„æ–™ä¹‹å¤–çš„å†…å­˜æ³„æ¼ åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸æœ‰å®šæ—¶æ‰§è¡ŒæŸä¸ªä»»åŠ¡çš„éœ€æ±‚ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå®šæ—¶æ‰§è¡Œä»»åŠ¡çš„ç¤ºä¾‹ï¼ˆworkerï¼‰ï¼Œï¼ˆå®Œæ•´ä»£ç åˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\nfunc worker1(c chan struct{}) { count := 0 timeout := 0 for { select { case \u003c-c: count++ case \u003c-time.After(1 * time.Second): timeout++ } } } è¿™æ®µä»£ç çœ‹ä¸å‡ºä»»ä½•æ¯›ç—…ï¼Œè¿è¡Œèµ·æ¥ä¹ŸOKï¼Œä¸‹é¢æ˜¯è¿™ä¸ªéœ€æ±‚çš„å¦ä¸€ä¸ªç‰ˆæœ¬ï¼ˆworker2ï¼‰ï¼Œå’Œworker1ç›¸æ¯”ï¼Œworker2ä½¿ç”¨äº†time.NewTimeråˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ã€‚\nfunc worker2(c chan struct{}) { count := 0 timeout := 0 timer := time.NewTicker(1 * time.Second) defer timer.Stop() for { select { case \u003c-c: count++ case \u003c-timer.C: timeout++ } } } è¿™é‡Œç»™å‡ºè¿™ä¸¤æ®µä»£ç çš„å®Œæ•´ç¤ºä¾‹ï¼Œåˆ†åˆ«è§work1å’Œworker2ã€‚å¦‚æœè¿è¡Œäº†worker1å’Œworker2çš„å®Œæ•´ç¤ºä¾‹ï¼Œä½ ä¼šå‘ç°è¿™ä¸¤ä¸ªä»£ç çš„å†…å­˜æ¶ˆè€—å·®åˆ«å¾ˆå¤§ï¼Œå› ä¸ºæ¯æ¬¡è°ƒç”¨time.Afteréƒ½ä¼šåˆ›å»ºä¸€ä¸ªtime.Timerå¯¹è±¡ï¼Œä¸”ä¸ä¼šè¢«GCå›æ”¶ï¼Œå¦‚æœè¿™æ®µä»£ç é•¿æ—¶é—´åœ¨çº¿ä¸Šè¿è¡Œï¼Œå°±å­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚\nè·³ä¸å‡ºçš„å¾ªç¯ Goè¯­è¨€ä¸­çš„breakç”¨äºè·³å‡ºforã€selectã€switchä½œç”¨çš„è¯­å¥å—ï¼Œå½“forå’Œselectæˆ–switchç»“åˆæ—¶ï¼Œè¦ç¡®ä¿èƒ½æŒ‰ç…§é¢„æœŸè·³å‡ºforå¾ªç¯ä½“ï¼›ï¼ˆå®Œæ•´ä¾‹å­è§Go Playgroundï¼‰\nfunc worker(stopCh chan struct{}) { println(\"worker start\") defer println(\"worker stop\") timer := time.NewTicker(1 * time.Second) defer timer.Stop() for { select { case \u003c-stopCh: println(\"stop signal received\") // just break the select! break case \u003c-timer.C: println(\"do something\") } } } å¦‚æœæƒ³è·³å‡ºå¤šé‡è¯­å¥å—ï¼Œéœ€è¦é…åˆlabelä½¿ç”¨ï¼Œä¿®æ­£åçš„ä»£ç å¦‚ä¸‹ï¼Œï¼ˆå®Œæ•´ä¾‹å­è§Go Playgroundï¼‰ã€‚\nfunc worker(stopCh chan struct{}) { println(\"worker start\") defer println(\"worker stop\") timer := time.NewTicker(1 * time.Second) defer timer.Stop() loop: for { select { case \u003c-stopCh: println(\"stop signal received\") // break the for loop break loop case \u003c-timer.C: println(\"do something\") } } } defer deferä¼ å‚ deferå…³é”®å­—ä¼šä½¿å‡½æ•°å»¶è¿Ÿæ‰§è¡Œï¼Œä½†æ˜¯å‡½æ•°çš„å‚æ•°æ˜¯åœ¨æ‰§è¡Œdeferçš„æ—¶å€™å°±è¢«ç¡®å®šçš„ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æƒ³åœ¨accumulateå‡½æ•°æ‰§è¡Œå®Œä¹‹åè®°å½•ä¸€ä¸‹sumå€¼ï¼Œä½†æ˜¯deferè®°å½•çš„sumå€¼æ°¸è¿œæ˜¯0ã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰\nfunc accumulate(nums []int) int { var sum int // log the sum defer fmt.Printf(\"sum = %d\\n\", sum) for _, num := range nums { sum += num } return sum } è¦æƒ³é€šè¿‡deferè®°å½•çœŸå®çš„sumå€¼ï¼Œéœ€è¦ç”¨åˆ°é—­åŒ…ï¼ˆåŒ¿åå‡½æ•°ï¼‰ï¼Œå› ä¸ºåœ¨é—­åŒ…ä¸­å¼•ç”¨å¤–éƒ¨å˜é‡æ—¶ï¼Œä¼šä»¥å¼•ç”¨çš„æ–¹å¼ä½¿ç”¨å¤–éƒ¨å˜é‡ã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\nfunc accumulate(nums []int) int { var sum int // log the sum defer func() { fmt.Printf(\"sum = %d\\n\", sum) }() for _, num := range nums { sum += num } return sum } å¾ªç¯ä¸­ä½¿ç”¨defer åœ¨å¾ªç¯ä¸­ä½¿ç”¨deferè¦æ…é‡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼Œåœ¨æ‰“å¼€æ–‡ä»¶ä¸å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯æ— æ³•ç»“æŸï¼Œå› æ­¤æ–‡ä»¶æè¿°ç¬¦ä¹Ÿæ— æ³•è¢«åŠæ—¶é‡Šæ”¾ã€‚\nfunc readFiles(c chan string) error { for f := range c { file, err := os.Open(f) if err != nil { return err } defer file.Close() // do something with file } return nil } ä¸¥è‚ƒå¯¹å¾…ç”Ÿäº§ç¯å¢ƒğŸ‘¨âœˆï¸ JSONåºåˆ—åŒ–ä¸ååºåˆ—åŒ– ä¸€ä¸ªå®Œæ•´çš„çº¿ä¸ŠæœåŠ¡å¯èƒ½åŒ…å«ä½¿ç”¨ä¸åŒç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç»„ä»¶ï¼Œç»„ä»¶ä¹‹é—´çš„æ•°æ®äº¤æ¢æœ‰æ—¶ä¼šç”¨åˆ°JSONï¼Œå¯¹äºå¼ºç±»å‹çš„Goè¯­è¨€ä¸å¼±ç±»å‹çš„ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚luaï¼‰ä¹‹é—´ä¼ é€’JSONæ—¶éœ€è¦æ ¼å¤–å°å¿ƒã€‚è¯¦è§ï¼šç¼–ç ä¸º array è¿˜æ˜¯ objectã€‚\nä¸‹é¢æ˜¯ä¸€æ®µç®€å•çš„luaä»£ç ï¼Œå¯¹ç©ºobjectåšencodeæ“ä½œï¼š\n=== TEST 1: empty tables as objects local cjson = require \"cjson\" print(cjson.encode({})) print(cjson.encode({dogs = {}})) å¯¹äºç©ºçš„objectï¼Œé»˜è®¤encodeç»“æœä¸º{}ã€‚\n{} {\"dogs\":{}} ä¹Ÿå¯ä»¥è®¾ç½®å°†ç©ºobjectå½“ä½œarrayå¤„ç†ï¼Œåªéœ€è¦è®¾ç½®ä¸€ä¸‹å³å¯ï¼š\n=== TEST 2: empty tables as arrays local cjson = require \"cjson\" cjson.encode_empty_table_as_object(false) print(cjson.encode({})) print(cjson.encode({dogs = {}})) è¾“å‡ºç»“ä¸ºï¼š\n[] {\"dogs\":[]} åœ¨luaä¸­ç©ºå¯¹è±¡ï¼Œæ—¢å¯ä»¥åºåˆ—åŒ–æˆobjectï¼Œä¹Ÿå¯ä»¥åºåˆ—åŒ–æˆarrayï¼Œè¿™ç§åŒä¸€ç§æ•°æ®å¯èƒ½ç”Ÿæˆä¸åŒç»“æœçš„è¡Œä¸ºä¼šè®©å¼ºç±»å‹è¯­è¨€å¾ˆéš¾åšï¼Œå› æ­¤Goè¯­è¨€é‡åˆ°è¿™ç§ä¸æœŸæœ›ç±»å‹ä¸ä¸€è‡´çš„æ•°æ®æ—¶ï¼ŒUnmarshalæ—¶ç›´æ¥è¿”å›é”™è¯¯ã€‚\nHTTP ç¡®ä¿HTTP clientçœŸæ­£ç”¨äº†keep-alive ä¸‹é¢è¿™ä¸ªdoRequestä½¿ç”¨GETæ–¹æ³•è¯·æ±‚ç»™å®šçš„urlï¼Œå¦‚æœé¢‘ç¹è¯·æ±‚åŒä¸€ä¸ªurlï¼Œå¹¶ä¸ä¼šä½¿ç”¨HTTPçš„keep- aliveç‰¹æ€§ï¼Œè¦æƒ³ä½¿ç”¨keep-aliveéœ€è¦å°†HTTPçš„å“åº”çš„Bodyè¯»å®Œå¹¶ä¸”å…³é—­ã€‚ï¼ˆå¦‚æœä¸šåŠ¡éå¸¸ç®€å•ï¼Œæ— éœ€å¤„ç†å“åº”çš„Bodyï¼Œä¹Ÿå¿…é¡»æŠŠBodyè¯»å®Œï¼Œå¯ä»¥ç”¨io.Copy(io.Discard, resp.Body)ï¼‰ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå®Œæ•´çš„ä»‹ç»æ¡ˆä¾‹ï¼šHow To Reuse Http Connections In Goã€‚\nfunc doRequest(url string) error { req, err := http.NewRequest(http.MethodGet, url, nil) if err != nil { log.Fatal(err) } resp, err := http.DefaultClient.Do(req) if err != nil { log.Fatal(err) } if resp.StatusCode != http.StatusOK { return fmt.Errorf(\"status code is not 200, got: %d\", resp.StatusCode) } return nil } http.Response.Bodyå­—æ®µçš„æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜å¦‚æœè¦å¤ç”¨HTTP1.xçš„keep-aliveåŠŸèƒ½ï¼Œéœ€è¦å°†Bodyè¯»å®Œï¼Œåˆ‡å…³é—­Bodyã€‚\nâ€‹ // The http Client and Transport guarantee that Body is always\nâ€‹ // non-nil, even on responses without a body or responses with\nâ€‹ // a zero-length body. It is the callerâ€™s responsibility to\nâ€‹ // close Body. The default HTTP clientâ€™s Transport may not\nâ€‹ // reuse HTTP/1.x â€œkeep-aliveâ€ TCP connections if the Body is\nâ€‹ // not read to completion and closed.\nä¸ä½¿ç”¨HTTPçš„é»˜è®¤é…ç½® HTTP client\nhttpåº“ä¸­é»˜è®¤çš„HTTP clientæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ŒHTTP clientä¸­çš„Timeoutå­—æ®µçš„è¶…æ—¶æ—¶é—´æ˜¯æ•´ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒåº”è¯¥è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ã€‚\nå»ºè¿æ—¶é—´ï¼› DNSè§£æï¼› TCPä¸‰æ¬¡æ¡æ‰‹ï¼› TLSæ¡æ‰‹ï¼ˆå¦‚æœæ˜¯TLSï¼‰ï¼› å‘é€è¯·æ±‚ï¼› é‡å®šå‘ï¼ˆå¦‚æœæœ‰ï¼‰ï¼› è¯»å“åº”ï¼› http.Clientçš„Timeoutå­—æ®µæºç ï¼š\ntype Client struct { // ...... // Timeout specifies a time limit for requests made by this // Client. The timeout includes connection time, any // redirects, and reading the response body. The timer remains // running after Get, Head, Post, or Do return and will // interrupt reading of the Response.Body. // // A Timeout of zero means no timeout. // // The Client cancels requests to the underlying Transport // as if the Request's Context ended. // // For compatibility, the Client will also use the deprecated // CancelRequest method on Transport if found. New // RoundTripper implementations should use the Request's Context // for cancellation instead of implementing CancelRequest. Timeout time.Duration } ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„HTTP clientçš„ç¤ºä¾‹ï¼Œè®¾ç½®äº†å„ç§è¶…æ—¶æ—¶é—´ï¼ˆå…·ä½“å‚æ•°æ ¹æ®å®é™…æƒ…å†µç¡®å®šï¼‰ï¼Œè¿˜è®¾ç½®äº†æœ€å¤§ç©ºé—²è¿æ¥æ•°ç­‰ï¼ŒHTTP clientä¸­è¿˜æœ‰å¾ˆå¤šå‚æ•°ï¼Œåœ¨ç¨‹åºè°ƒä¼˜æ—¶å¯èƒ½ä¼šç”¨åˆ°ã€‚\nclient := \u0026http.Client{ Transport: \u0026http.Transport{ DialContext: (\u0026net.Dialer{ Timeout: 5 * time.Second, // TCP å»ºè”æ—¶é—´ï¼Œé»˜è®¤3min KeepAlive: 30 * time.Second, // keep alive æ¢æµ‹æ—¶é—´é—´éš”ï¼Œé»˜è®¤15s }).DialContext, MaxIdleConns: 100, // æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼ˆå¤„äºkeep aliveï¼‰,é»˜è®¤å€¼ä¸º2 IdleConnTimeout: 90 * time.Second, // keep aliveä¿æŒæœ€é•¿æ—¶é—´ï¼Œé»˜è®¤ä¸º0ï¼ˆæ— é™åˆ¶ï¼‰ TLSHandshakeTimeout: 2 * time.Second, // TLSæ¡æ‰‹è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸è®¾ç½®è¶…æ—¶æ—¶é—´ ResponseHeaderTimeout: 2 * time.Second, // å‘é€å®Œè¯·æ±‚åˆ°æ”¶åˆ°å“åº”å¤´æ—¶é—´é—´éš”ï¼Œé»˜è®¤å€¼ä¸º0 }, Timeout: 10 * time.Second, // HTTPè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ŒåŒ…æ‹¬å»ºè¿ã€å‘é€è¯·æ±‚ã€æ¥æ”¶è¯·æ±‚ç­‰ } HTTP server\nå’ŒHTTP clientç±»ä¼¼ï¼Œé»˜è®¤çš„HTTP serverå¾ˆå¤šé»˜è®¤çš„å‚æ•°ä¹Ÿä¸é€‚åˆåœ¨çº¿ä¸Šç¯å¢ƒè¿è¡Œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„http.Serverçš„å®šä¹‰ï¼ˆå…·ä½“å‚æ•°æ ¹æ®å®é™…æƒ…å†µç¡®å®šï¼‰ï¼š\nserver := \u0026http.Server{ Addr: \"8080\", ReadTimeout: 10 * time.Second, WriteTimeout: 10 * time.Second, MaxHeaderBytes: 1 \u003c\u003c 20, } ç±»å‹æ–­è¨€ å¯¹interfaceè¿›è¡Œç±»å‹æ–­è¨€æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…å°±ä¼šè§¦å‘panicã€‚å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ç¬¬äºŒæ¬¡è°ƒç”¨fooæ—¶ä¼ é€’ä¸€ä¸ªstringç±»å‹çš„å‚æ•°å°±ä¼šå¯¼è‡´ç¨‹åºPanicã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰\nfunc foo(i interface{}) { a := i.(int) println(a) } func main() { foo(1) // ok foo(\"a\") // panic } å› æ­¤å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œåœ¨åšç±»å‹æ–­è¨€æ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨common okçš„æ–¹å¼æ¥æ¥æ”¶è¿”å›å€¼ï¼Œé€šè¿‡ç¬¬äºŒä¸ªå‚æ•°æ¥åˆ¤æ–­ç±»å‹æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ä¸‹é¢æ˜¯è°ƒæ•´è¿‡çš„fooå‡½æ•°ï¼Œæ— è®ºä¼ é€’ä»€ä¹ˆç±»å‹ï¼Œfooéƒ½ä¸ä¼šPanicã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰\nfunc foo(i interface{}) { a, ok := i.(int) if !ok { fmt.Printf(\"want type of int, got %T, %q\\n\", i, i) return } println(a) } åŒæ ·æ˜¯ç±»å‹æ–­è¨€ï¼Œæ—¢å¯ä»¥ç”¨ä¸€ä¸ªå˜é‡æ¥æ”¶ï¼Œä¹Ÿå¯ä»¥ç”¨ä¸¤ä¸ªå˜é‡æ¥æ”¶ã€‚è¿™å…¶å®æ˜¯Goæœ¬èº«æä¾›çš„è¯­æ³•ç³–ï¼Œç±»å‹æ–­è¨€æœ€ç»ˆè°ƒç”¨çš„æ˜¯runtime.getitabï¼Œruntime.getitabçš„åŸå‹å¦‚ä¸‹ï¼ŒGoç¼–è¯‘å™¨åœ¨ç¼–è¯‘æºç æ—¶æ ¹æ®æ¥æ”¶è¿”å›å€¼çš„å˜é‡æ•°é‡å†³å®šè°ƒç”¨runtime.getitabæ—¶ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯trueè¿˜æ˜¯falseï¼Œå¦‚æœç”¨ä¸€ä¸ªå‚æ•°æ¥æ”¶è¿”å›å€¼ï¼Œåˆ™canfailä¸ºtrueï¼Œå¦‚æœç±»å‹ä¸ç¬¦åˆé¢„æœŸå°±ä¼šPanicã€‚\nfunc getitab(inter *interfacetype, typ *_type, canfail bool) *itab ç¦ç”¨ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³• Goçš„TLSä½¿ç”¨çš„é»˜è®¤å¯†ç å¥—ä»¶ï¼ˆcipher suitesï¼‰åŒ…å«äº†å·²ç»è¢«è®¤ä¸ºä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼ˆä½¿ç”¨äº†DESå’Œ3DESï¼Œå…·ä½“å½±å“è§CVE-2016-2183è¯¦æƒ…ï¼‰ï¼Œå¦‚æœå¯¹å®‰å…¨è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®åŠ å¯†ç®—æ³•ç™½åå•ï¼Œç¦ç”¨åŠ å¯†ç®—æ³•DESå’Œ3DESã€‚\n// disable DES encrypt algorithm to avoid CVE-2016-2183 var CipherSuites = []uint16{ tls.TLS_RSA_WITH_RC4_128_SHA, // tls.TLS_RSA_WITH_3DES_EDE_CBC_SHA, tls.TLS_RSA_WITH_AES_128_CBC_SHA, tls.TLS_RSA_WITH_AES_256_CBC_SHA, tls.TLS_RSA_WITH_AES_128_CBC_SHA256, tls.TLS_RSA_WITH_AES_128_GCM_SHA256, tls.TLS_RSA_WITH_AES_256_GCM_SHA384, tls.TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, tls.TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, tls.TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, tls.TLS_ECDHE_RSA_WITH_RC4_128_SHA, // tls.TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, tls.TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, tls.TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, tls.TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, tls.TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, tls.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, tls.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, tls.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, tls.TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, tls.TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256, tls.TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256, // TLS 1.3 cipher suites. tls.TLS_AES_128_GCM_SHA256, tls.TLS_AES_256_GCM_SHA384, tls.TLS_CHACHA20_POLY1305_SHA256, } ç‰ˆæœ¬ä¿¡æ¯ åœ¨ä¸šåŠ¡å‘å±•çš„åˆæœŸé˜¶æ®µï¼Œè½¯ä»¶çš„CI/CDå¯èƒ½ä¸å®Œå–„ï¼Œæœ‰æ—¶å€™éœ€è¦é¢‘ç¹çš„äººå·¥æ“ä½œã€‚ä¸ºäº†èƒ½åŒºåˆ†åŒä¸€ä¸ªç¨‹åºçš„ä¸åŒç‰ˆæœ¬ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·æ¥åŒºåˆ†ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä»…ä»…å‡­ç‰ˆæœ¬å·å¹¶ä¸å®¹æ˜“åŒºåˆ†ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘å°†commit idã€build timeç­‰ä¿¡æ¯å’Œversionä¸€èµ·æ”¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œåœ¨ç¨‹åºçš„mainåŒ…ä¸­å®šä¹‰äº†versionã€commitIDã€buildTimeï¼Œ\npackage main import ( \"flag\" \"fmt\" ) var ( version string commitID string buildTime string ) func printVerbose() { fmt.Printf(\"version: %s\\n\", version) fmt.Printf(\"commit_id: %s\\n\", commitID) fmt.Printf(\"build_time: %s\\n\", buildTime) } func main() { v := flag.Bool(\"version\", false, \"print version\") flag.Parse() if *v { printVerbose() return } // .... } ç¼–è¯‘çš„å‘½ä»¤å†™åœ¨Makefileä¸­ï¼Œåœ¨éœ€è¦ç¼–è¯‘çš„æ—¶å€™åªéœ€è¦makeä¸€ä¸‹å³å¯ã€‚\nVERSION := dev DATE := $(shell date -u '+%Y-%m-%d-%H%M UTC') COMMITID := $(shell git rev-parse --short HEAD) VERSION_FLAGS := -X \"main.version=$(VERSION)\" -X \"main.buildTime=$(DATE)\" -X \"main.commitID=$(COMMITID)\" all: go build -buildvcs=false -ldflags='$(VERSION_FLAGS)' -o demo .PHONY: clean clean: rm demo å¸¸è¯†ğŸ’â™‚ï¸ å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’ Goçš„dataå¯ä»¥åˆ†ä¸ºå››ä¸ªç±»å‹ï¼šåŸºæœ¬ç±»å‹ã€ç¬¦åˆç±»å‹ã€å¼•ç”¨ç±»å‹å’Œæ¥å£ã€‚å¸¸è¯†å‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé€šè¿‡æŒ‡é’ˆä¼ é€’å‚æ•°çš„æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Œä½†æ˜¯å¯¹äºstringã€sliceã€mapã€functionè€Œè¨€ï¼Œæ²¡æœ‰å¿…è¦ä½¿ç”¨æŒ‡é’ˆä¼ é€’ã€‚ä¼ é€’structå’Œarrayå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨æŒ‡é’ˆã€‚\nstringå’Œ[]byteç›¸äº’è½¬æ¢ stringå’Œsliceå¯ä»¥ç›¸äº’è½¬æ¢ï¼Œä½†æ˜¯stringå’Œsliceä¹‹é—´çš„è½¬æ¢å¹¶ä¸æ˜¯ç®€å•çš„æŒ‡é’ˆä¹‹é—´çš„èµ‹å€¼ï¼Œè€Œæ˜¯è¦å°†åŸæ•°æ®å¤åˆ¶ä¸€ä»½åˆ°æ–°çš„å†…å­˜åœ°å€ã€‚\nstr := \"hello world\" bs := []byte(str) str2 = string(bs) string è½¬ slice\nstring è½¬ sliceçš„æºç å¦‚ä¸‹ï¼Œå¦‚æœé¢„å…ˆåˆ†é…çš„å†…å­˜å¤§å°å¤§äºæºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ™ä¼šè°ƒç”¨rawbytesliceç”³è¯·å†…å­˜ï¼Œæœ€ç»ˆå°†æºæ•°æ®å¤åˆ¶ï¼ˆcopyï¼‰åˆ°æ–°çš„å†…å­˜åœ°å€ã€‚\nfunc stringtoslicebyte(buf *tmpBuf, s string) []byte { var b []byte if buf != nil \u0026\u0026 len(s) \u003c= len(buf) { *buf = tmpBuf{} b = buf[:len(s)] } else { b = rawbyteslice(len(s)) } copy(b, s) return b } // rawbyteslice allocates a new byte slice. The byte slice is not zeroed. func rawbyteslice(size int) (b []byte) { cap := roundupsize(uintptr(size), true) p := mallocgc(cap, nil, false) if cap != uintptr(size) { memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size)) } *(*slice)(unsafe.Pointer(\u0026b)) = slice{p, size, int(cap)} return } slice è½¬ string\nsliceè½¬stringçš„æºç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¦å¤åˆ¶çš„stringçš„é•¿åº¦è¶…è¿‡äº†é¢„å…ˆåˆ†é…çš„å†…å­˜å¤§å°nï¼Œåˆ™ä¼šè°ƒç”¨mallocgcç”³è¯·å†…å­˜ã€‚æ— è®ºæ˜¯å¦éœ€è¦ç”³è¯·æ–°çš„å†…å­˜ï¼Œéƒ½ä¼šæ¶‰åŠåˆ°å°†æºæ•°æ®ï¼ˆstringæ‰€æŒ‡çš„å†…å®¹ï¼‰å¤åˆ¶ï¼ˆmemmoveï¼‰åˆ°ä¸ºsliceåˆ†é…çš„å†…å­˜ä¸­ã€‚\nfunc slicebytetostring(buf *tmpBuf, ptr *byte, n int) string { // ...... var p unsafe.Pointer if buf != nil \u0026\u0026 n \u003c= len(buf) { p = unsafe.Pointer(buf) } else { p = mallocgc(uintptr(n), nil, false) } memmove(p, unsafe.Pointer(ptr), uintptr(n)) return unsafe.String((*byte)(p), n) } Slice ä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªèƒ½ä¿å­˜1000ä¸ª[]byteçš„sliceï¼Œå¹¶ä¸ºæ¯ä¸ªå…ƒç´ ç”³è¯·å¤§å°ä¸º1MBçš„å†…å­˜ï¼Œç„¶åè°ƒç”¨keepFirstTwoElementsOnlyè·å–å‰ä¸¤ä¸ªå…ƒç´ ï¼Œï¼ˆåˆ°Go playgroundè¿è¡Œï¼‰ã€‚\npackage main import ( \"fmt\" \"runtime\" ) type Foo struct { v []byte } func printAlloc() { var m runtime.MemStats runtime.ReadMemStats(\u0026m) fmt.Printf(\"Alloc = %v KB\\n\", m.Alloc/1024) } func keepFirstTwoElementsOnly(foos []Foo) []Foo { return foos[:2] } func main() { foos := make([]Foo, 1000) printAlloc() for i := 0; i \u003c 1000; i++ { foos[i] = Foo{ v: make([]byte, 1024*1024), } } printAlloc() two := keepFirstTwoElementsOnly(foos) runtime.GC() printAlloc() runtime.KeepAlive(two) } è§£å†³æ–¹æ³•\né‡æ–°åˆ›å»ºlenå’Œcapå‡ä¸º2çš„sliceï¼ŒæŠŠå‰ä¸¤ä¸ªå…ƒç´ æ‹·è´åˆ°æ–°çš„sliceä¸­ï¼Œï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\nfunc keepFirstTwoElementsOnly(foos []Foo) []Foo { res := make([]Foo, 2) copy(res, foos) return res } Map ä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªkeyä¸ºintï¼Œvalueä¸º[128]çš„mapï¼Œsizeä¸º10241024çš„mapï¼Œç„¶åç»™[0ï½10241024)å†…çš„æ¯ä¸ªkeyåˆ›å»ºä¸€ä¸ªvalueï¼Œç„¶ååˆ é™¤æ‰€æœ‰çš„å…ƒç´ ã€‚ï¼ˆæ­¤ä»£ç ç”³è¯·çš„å†…å­˜è¾ƒå¤šï¼ŒGo Playgroundæ— æ³•æ­£å¸¸æ‰§è¡Œå®ŒğŸ˜…ï¼Œå¦‚æƒ³æŸ¥çœ‹ç»“æœï¼Œéœ€åœ¨æœ¬åœ°æ‰§è¡Œï¼‰ã€‚\npackage main import ( \"fmt\" \"runtime\" ) func printAlloc() { var m runtime.MemStats runtime.ReadMemStats(\u0026m) fmt.Printf(\"Alloc = %v KB\\n\", m.Alloc/1024) } func main() { n := 1024 * 1024 // create a map m := make(map[int][128]byte) // print the memory usage before filling the map printAlloc() // fill the map with 1024 * 1024 elements for i := 0; i \u003c n; i++ { m[i] = [128]byte{} } // print the memory usage after filling the map printAlloc() for i := 0; i \u003c n; i++ { delete(m, i) } // force GC to clear the map runtime.GC() // print the memory usage after deleting the map printAlloc() // keep the program running runtime.KeepAlive(m) } è¿è¡Œç»“æœï¼š\nAlloc = 127 KB Alloc = 464373 KB Alloc = 300477 KB å¦‚æœå°†mapçš„valueç±»å‹ä¿®æ”¹ä¸ºæŒ‡é’ˆç±»å‹ï¼Œéœ€è¦çš„å†…å­˜ä¼šå°‘å¾ˆå¤šï¼š\n// .... func main() { n := 1024 * 1024 // create a map // m := make(map[int][128]byte) m := make(map[int]*[128]byte) // ...... // fill the map with 1024 * 1024 elements for i := 0; i \u003c n; i++ { // m[i] = [128]byte{} m[i] = \u0026[128]byte{} } // ...... } è¿è¡Œç»“æœï¼š\nAlloc = 127 KB Alloc = 191634 KB Alloc = 39305 KB ä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚ï¼Ÿ Goè¯­è¨€ä½¿ç”¨UTF-8ç¼–ç ï¼Œç»å¤§éƒ¨åˆ†æ±‰å­—çš„UTF-8ç¼–ç ä¸º3ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå› æ­¤ä¸èƒ½é»˜è®¤æ‰€æœ‰æ±‰å­—çš„UTF-8ç¼–ç éƒ½æ˜¯3ä¸ªå­—èŠ‚ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±èƒ½è¯´æ˜é—®é¢˜ï¼ˆåˆ°Go Playroundè¿è¡Œï¼‰ï¼Œä¸–å’Œç•Œçš„å¤§å°éƒ½ä¸º3å­—èŠ‚ï¼Œè€Œğ œï¼ˆxiÃ nï¼‰çš„å¤§å°ä¸º4å­—èŠ‚ã€‚\npackage main func main() { str := \"ä¸–\" println(len(str)) str = \"ç•Œ\" println(len(str)) str = \"ğ œ\" println(len(str)) } PSï¼š\nUTF-8å…¨ç§°ä¸ºUnicode Transformation Format - 8-bitï¼ŒUnicode æ˜¯ä¸€ç§å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œç”¨äºè¡¨ç¤ºæ–‡å­—åœ¨è®¡ç®—æœºä¸­çš„å­—ç¬¦é›†ï¼Œå®ƒä¸ºä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰çš„ä¹¦å†™ç³»ç»Ÿä¸­çš„æ¯ä¸ªå­—ç¬¦åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„æ•°å€¼æ ‡è¯†ï¼Œç§°ä¸ºç ç‚¹ã€‚å¯ä»¥ç†è§£ä¸ºUnicodeä¸ºæ¯ä¸ªç¬¦å·åˆ†é…äº†ä¸€ä¸ªç¼–å·ã€‚è€ŒUTF-8æ˜¯Unicodeçš„ä¸€ç§å…·ä½“å®ç°æ–¹æ¡ˆï¼Œæ­¤å¤–è¿˜æœ‰UTF-16å’ŒUTF-32ç­‰å®ç°æ–¹æ¡ˆã€‚å’Œå…¶ä»–çš„ç¼–ç æ–¹å¼ç›¸æ¯”ï¼ŒUTF-8æ˜¯ä¸€ç§å…¼å®¹ASCIIï¼Œå¤„ç†æ•ˆç‡é«˜çš„ç¼–ç æ–¹å¼ï¼Œå› æ­¤åœ¨è®¡ç®—æœºç³»ç»Ÿå’Œç½‘ç»œç¯å¢ƒä¸­å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚ï¼ˆå»¶ä¼¸ï¼šASCIIï¼ŒUnicode å’Œ UTF-8ï¼‰ã€‚\næ‘†è„±ä¸äº†çš„å†…å­˜å¯¹é½ ä¸‹é¢S1å’ŒS2ä¸¤ä¸ªstructçš„æˆå‘˜ç±»å‹ä¸€æ ·ï¼Œä½†æ˜¯é¡ºåºä¸ä¸€æ ·ã€‚è¿™ä¼šå¯¼è‡´ä¸¤ä¸ªç»“æ„ä½“å ç”¨çš„å†…å­˜å¤§å°å·®ä¸€å€ã€‚å¦‚æœåœ¨å¯¹èµ„æºæ¯”è¾ƒæ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼ˆå¦‚åˆ¶å®šåè®®å­—æ®µã€å­˜å‚¨ï¼‰ï¼Œéœ€è¦è€ƒè™‘å†…å­˜å¯¹é½ã€‚ï¼ˆåˆ°Go Playgroundè¿è¡Œï¼‰ã€‚\n// 32 bytes type S1 struct { a int8 b int64 c int8 d int32 e int16 } // 16 bytes type S2 struct { a int8 c int8 e int16 d int32 b int64 } å–„ç”¨åº“ ä¸°å¯Œçš„åº“èµ„æºæ˜¯Goè¯­è¨€çš„ä¸€å¤§ä¼˜ç‚¹ï¼Œå¾ˆå¤šäº‹æƒ…å¯ä»¥ä½¿ç”¨æ ‡å‡†åº“æˆ–è€…ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“æ¥å®ç°å®Œæˆï¼Œæ²¡æœ‰å¿…è¦è‡ªå·±é‡æ–°é€ è½®å­ã€‚\nä½¿ç”¨åº“ä¸­çš„å¸¸é‡ã€å˜é‡ ä½¿ç”¨åº“ä¸­çš„å¸¸é‡ã€å˜é‡å¯ä»¥æé«˜ä»£ç çš„å¯é˜…è¯»æ€§ï¼Œå¦‚ï¼š\nä¸ä½¿ç”¨åº“ ä½¿ç”¨åº“ 200 http.StatusOK â€œ2006-01-02 15:04:05â€ time.DateTime ä½¿ç”¨æ ‡å‡†åº“å‡½æ•° åœ¨è¿›è¡Œæ–‡ä»¶è·¯å¾„æ“ä½œï¼ˆå¦‚æ‹¼æ¥è·¯å¾„ï¼Œè·å–ç›®å½•ï¼Œè·å–æ–‡ä»¶åç­‰ï¼‰ã€ç½‘ç»œåœ°å€æ“ä½œï¼ˆæ‹¼æ¥IP+Portï¼Œæ‹†åˆ†IPã€Portï¼Œåˆ¤æ–­IPæ˜¯å¦ä¸ºIPv4ç­‰ï¼‰å¯ä»¥è°ƒç”¨æ ‡å‡†åº“ï¼Œå³å®‰å…¨åˆé«˜æ•ˆã€‚\næ¨èçš„ç¬¬ä¸‰æ–¹åº“ ä¸‹é¢åˆ—ä¸¾ä¸€äº›æˆ‘è‡ªå·±ç»å¸¸ç”¨åˆ°çš„ä¸€äº›å‡†æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ï¼š\nåº“å åŠŸèƒ½ åº”ç”¨åœºæ™¯ logrus æ ¼å¼åŒ–æ—¥å¿—åº“ï¼ˆå…·æœ‰æ—¥å¿—ç­‰çº§ï¼Œæ”¯æŒå¹¶å‘è®°å½•æ—¥å¿—ï¼Œæ”¯æŒHookç­‰ï¼‰ è®°å½•æ—¥å¿— singlefly ç”¨äºåœ¨å¹¶å‘ç¯å¢ƒä¸­æ‰§è¡Œå¹‚ç­‰å‡½æ•°ã€‚ å¹¶å‘æŸ¥è¯¢æ•°æ®åº“ã€DNSè§£æ tableflip è®©è¿›ç¨‹ä¼˜é›…åœ°é‡å¯ã€‚ ç½‘ç»œç¨‹åºå¹³æ»‘å‡çº§ ttlcache å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„å†…å­˜ç¼“å­˜ã€‚ DNSç¼“å­˜ errorgroup ç”¨äºåœ¨å¹¶å‘ç¯å¢ƒä¸­å¤„ç†é”™è¯¯ã€‚å®ƒå¯ä»¥å°†å¤šä¸ªå¹¶å‘ä»»åŠ¡çš„ç»“æœèšåˆæˆä¸€ä¸ªç»“æœï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªé‡åˆ°çš„é”™è¯¯ã€‚ å¹¶å‘æ‰§è¡Œå¤šä¸ªç›¸äº’æœ‰å…³è”çš„ä»»åŠ¡çš„åœºæ™¯ å‚è€ƒ 100 Go Mistakes and How to Avoid Them (website) ","wordCount":"1651","inLanguage":"zh","datePublished":"2025-10-14T07:55:34+08:00","dateModified":"2025-10-14T07:55:34+08:00","author":{"@type":"Person","name":"rand0m"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rand0m42195.github.io/posts/go-pitfall-guide/"},"publisher":{"@type":"Organization","name":"rand0m's blog","logo":{"@type":"ImageObject","url":"https://rand0m42195.github.io/favicon.ico"}}}</script><link rel=icon href=/favicon.ico type=image/x-icon><link rel=icon href=/favicon-16x16.png type=image/png size=16x16><link rel=icon href=/favicon-32x32.png type=image/png size=32x32><link rel=icon href=/favicon-192x192.png type=image/png size=192x192><link rel=icon href=/favicon-512x512.png type=image/png size=512x512></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rand0m42195.github.io/ accesskey=h title="rand0m's blog (Alt + H)">rand0m's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rand0m42195.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://rand0m42195.github.io/about/ title=å…³äº><span>å…³äº</span></a></li><li><a href=https://github.com/rand0m42195 title=GitHub><span>GitHub</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rand0m42195.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://rand0m42195.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Goè¯­è¨€å¸¸è§é”™è¯¯åˆ†æ</h1><div class=post-meta><span title='2025-10-14 07:55:34 +0800 +0800'>åæœˆ 14, 2025</span>&nbsp;Â·&nbsp;8 åˆ†é’Ÿ&nbsp;Â·&nbsp;rand0m</div></header><div class=post-content><p>Helloï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„Goè¯­è¨€å­¦ä¹ ç¬”è®°ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹Goè¯­è¨€ä¸­ä¸€äº›å¸¸è§é”™è¯¯ï¼Œä»¥åŠä¸€äº›å®¹æ˜“è¢«äººè¯¯è§£çš„åœ°æ–¹ã€‚ï¼ˆå¦å¤–ï¼Œä¹Ÿæ¬¢å¤§å®¶è¿æµè§ˆæˆ‘çš„ä¸Šä¸€ç¯‡ç¬”è®°ï¼š<a href=https://rand0m42195.github.io/posts/go-testing/>è¯¦è§£Go Testing</a>ğŸ˜€ï¼‰</p><p>ä¸ºäº†çªå‡ºé—®é¢˜ï¼Œä¸‹é¢ä¸¾çš„æŸäº›ä¾‹å­å¯èƒ½æ¯”è¾ƒæç«¯ï¼Œè¿˜æœ›å¤§å®¶ä¸è¦çº ç»“ä¾‹å­çš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜ç™½å…¶ä¸­çš„é”™è¯¯åŸå› å³å¯ã€‚å¦å¤–ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……ç¤ºä¾‹ğŸ«µã€‚</p><h2 id=bugs>BugsğŸ<a hidden class=anchor aria-hidden=true href=#bugs>#</a></h2><h3 id=å˜é‡é®è”½shadowing>å˜é‡é®è”½ï¼ˆshadowingï¼‰ğŸ¥·ğŸ¿<a hidden class=anchor aria-hidden=true href=#å˜é‡é®è”½shadowing>#</a></h3><p>åœ¨ Go ä¸­ï¼Œå˜é‡é®è”½ï¼ˆvariable shadowingï¼‰æŒ‡çš„æ˜¯åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­å£°æ˜ä¸€ä¸ªä¸å¤–éƒ¨ä½œç”¨åŸŸä¸­åŒåçš„å˜é‡ï¼Œä»è€Œè¦†ç›–äº†å¤–éƒ¨ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚è¿™ç§bugæ¯”è¾ƒä½çº§ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°åœ¨æ¯”è¾ƒè´Ÿè½½çš„å‡½æ•°é‡Œï¼Œè€Œä¸”æ¯”è¾ƒéšè”½ï¼Œä¸å®¹æ˜“è¢«å‘ç°ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œ<code>findTarget</code>ä»ç»™å®šstrsä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªtargetï¼Œè¿”å›ç´¢å¼•ã€‚ä½†æ˜¯è¿™ä¸ªç®€å•çš„å‡½æ•°å­˜åœ¨å˜é‡é®è”½çš„bugï¼ˆåˆ°<a href=https://go.dev/play/p/qrT3Ko7w--t>Go Playground</a>è¿è¡Œï¼‰ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯-1ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>findTarget</span><span class=p>(</span><span class=nx>strs</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>strs</span><span class=p>);</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=nx>strs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=å±é™©çš„map>å±é™©çš„mapğŸ˜ˆ<a hidden class=anchor aria-hidden=true href=#å±é™©çš„map>#</a></h3><h4 id=æœªåˆå§‹åŒ–>æœªåˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#æœªåˆå§‹åŒ–>#</a></h4><p>Goè¯­è¨€ä¸­æœªåˆå§‹åŒ–çš„å˜é‡çš„å€¼ä¸ºæ­¤å˜é‡ç±»å‹çš„é»˜è®¤å€¼ï¼Œmapçš„é»˜è®¤å€¼ä¸ºnilï¼Œè¯»å€¼ä¸ºnilçš„mapæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹nilçš„mapè¿›è¡Œå†™æ“ä½œä¼šå¼•å‘Panicã€‚(åˆ°<a href="https://go.dev/play/p/oOcmtpNzOlU?v=goprev">Go Playround</a>è¿è¡Œ)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// read from nil map, should not panic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=s>&#34;a&#34;</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// write to nil map, panic!!!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>m</span><span class=p>[</span><span class=s>&#34;a&#34;</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=s>&#34;a&#34;</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=å¹¶è¡Œè¯»å†™map>å¹¶è¡Œè¯»å†™map<a hidden class=anchor aria-hidden=true href=#å¹¶è¡Œè¯»å†™map>#</a></h4><p>Goè¯­è¨€çš„<strong>ç¦æ­¢</strong>å¤šä¸ªgoroutineåŒæ—¶è¯»å’Œå†™mapï¼ˆä¼šå¼•å‘Panicï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰å¹¶è¡Œæ“ä½œmapçš„éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨é”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¹¶è¡Œè¯»å†™mapçš„ç¤ºä¾‹ï¼Œç¨‹åºä¼šPanicï¼ˆåˆ°<a href="https://go.dev/play/p/pUTxzFGMO0A?v=goprev">Go Playground</a>è¿è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>var</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>100000</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>_</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>m</span><span class=p>[</span><span class=s>&#34;x&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>100000</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>m</span><span class=p>[</span><span class=s>&#34;y&#34;</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=nf>consumer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=nf>producer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä½†æ˜¯Goå…è®¸å¤šä¸ªgoroutineå¹¶è¡Œè¯»mapï¼Œå› æ­¤åœ¨è¯»æ“ä½œçš„æ€§èƒ½è¦æ±‚è¾ƒé«˜æ—¶ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¯»å†™é”ï¼ˆ<code>sync.RWMutex</code>ï¼‰ï¼›å¯¹å†™æ“ä½œæ€§èƒ½è¾ƒé«˜æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘å†™é”ï¼ˆ<code>sync.Mutex</code>ï¼‰ã€‚å¦å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨å°è£…å¥½çš„æ”¯æŒå¹¶å‘æ“ä½œçš„mapï¼ˆå¦‚<code>sync.Map</code>ï¼‰ã€‚</p><h3 id=éš¾ä»¥æ‰æ‘¸çš„forå¾ªç¯>éš¾ä»¥æ‰æ‘¸çš„forå¾ªç¯ğŸ™‰<a hidden class=anchor aria-hidden=true href=#éš¾ä»¥æ‰æ‘¸çš„forå¾ªç¯>#</a></h3><h4 id=æ„æ–™ä¹‹å¤–çš„éå†ç»“æœ>æ„æ–™ä¹‹å¤–çš„éå†ç»“æœ<a hidden class=anchor aria-hidden=true href=#æ„æ–™ä¹‹å¤–çš„éå†ç»“æœ>#</a></h4><p>ä¸‹é¢çš„ç¤ºä¾‹éå†numsï¼Œå¹¶ä¸ºæ¯ä¸ªnumåˆ›å»ºä¸€ä¸ªgoroutineæ¥æ‰“å°numçš„å€¼ã€‚æœŸæœ›çš„è¾“å‡ºæ˜¯æ‰“å°[0,10)ï¼Œè¾“å‡ºé¡ºåºä¸ç¡®å®šã€‚ï¼ˆåˆ°<a href="https://go.dev/play/p/7BRuPZGSBjO?v=goprev">Go Playground</a>è¿è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>nums</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>n</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>nums</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// the output is not what you expect :(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>num</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>nums</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>println</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>å¯¹äºè¾“å‡ºç»“æœæœ‰æ²¡æœ‰æ„Ÿåˆ°æ„å¤–ï¼Ÿå¦‚æœæ„Ÿåˆ°æ„å¤–ï¼Œè¯´æ˜ä½ è‡ªå·±ä¹Ÿå¯èƒ½ä¼šå†™å‡ºç±»å‹çš„ä»£ç ã€‚è¿™æ®µä»£ç é‡Œå­˜åœ¨ä¸€ä¸ªGoè¯­è¨€çš„ç»å…¸é”™è¯¯â€”â€”<strong>å¾ªç¯å˜é‡æ•è·</strong>ã€‚åœ¨ Go ä¸­ï¼Œé—­åŒ…ï¼ˆåŒ¿åå‡½æ•°ï¼‰å¯ä»¥è®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ã€‚å½“é—­åŒ…å†…éƒ¨å¼•ç”¨äº†å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡æ—¶ï¼Œå®é™…ä¸Šæ˜¯å¯¹è¯¥å˜é‡çš„å¼•ç”¨ï¼ˆè€Œä¸æ˜¯å€¼çš„æ‹·è´ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨å¾ªç¯ä¸­åˆ›å»ºäº†å¤šä¸ªé—­åŒ…ï¼Œå¹¶ä¸”è¿™äº›é—­åŒ…å…±äº«äº†å¾ªç¯å˜é‡ï¼Œé‚£ä¹ˆå®ƒä»¬å®é™…ä¸Šä¼šå…±äº«ç›¸åŒçš„å˜é‡ï¼Œè€Œä¸æ˜¯ç‹¬ç«‹çš„å‰¯æœ¬ã€‚</p><p>ä¿®å¤ä¸Šé¢çš„bugå¾ˆç®€å•ï¼Œåªéœ€è¦è®©foré‡Œé¢çš„åŒ¿åå‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°å³å¯ï¼Œè¿™æ ·å°±èƒ½é¿å…å¾ªç¯å˜é‡æ•è·é”™è¯¯äº†ğŸ˜€ã€‚ï¼ˆåˆ°<a href="https://go.dev/play/p/D3hJIO6wyNW?v=goprev">Go Playground</a>è¿è¡Œï¼‰</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// the output is what you expect :)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>num</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>nums</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>num</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>    </span><span class=c1>// è¿™é‡Œå£°æ˜éœ€è¦ä¸€ä¸ªå‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>println</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}(</span><span class=nx>num</span><span class=p>)</span><span class=w>    </span><span class=c1>// ä¼ é€’for rangeéå†çš„num</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=æ„æ–™ä¹‹å¤–çš„æ­»å¾ªç¯>æ„æ–™ä¹‹å¤–çš„æ­»å¾ªç¯<a hidden class=anchor aria-hidden=true href=#æ„æ–™ä¹‹å¤–çš„æ­»å¾ªç¯>#</a></h4><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä»channelè¯»å–æ•°æ®ï¼Œç„¶åå¤„ç†çš„ä¾‹å­ï¼Œå¾ˆæ˜æ˜¾è¿™æ®µä»£ç æ°¸è¿œä¸ä¼šé€€å‡ºï¼Œä½†æ˜¯å½“channelè¢«å…³é—­åï¼Œå°±ä¼šé€ æˆå¾ªç¯ä¸ä¼šé˜»å¡ã€‚å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼ˆCPUã€å†…å­˜ç­‰ï¼‰ã€‚ï¼ˆ<a href="https://go.dev/play/p/iGkCo2YZSeu?v=goprev">Go Playground</a>å®Œæ•´ä¾‹å­ï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>consumer</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>c</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nb>println</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// other case ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯å¯¹channelçš„æ“ä½œä¸ç†Ÿæ‚‰ï¼Œè¯»ä¸€ä¸ªè¢«closedçš„channelä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯è¯»channelå¯ä»¥ç”¨ä¸¤ä¸ªå˜é‡æ¥æ¥æ”¶ç»“æœï¼Œé€šè¿‡ç¬¬äºŒä¸ªå˜é‡åˆ¤æ–­æ˜¯å¦è¯»æˆåŠŸã€‚å› æ­¤è¿™ä¸ªä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šå­˜åœ¨æ­»å¾ªç¯äº†ã€‚ï¼ˆ<a href="https://go.dev/play/p/7zoPjVQTkSI?v=goprev">Go Playground</a>å®Œæ•´ä¾‹å­ï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>consumer</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>c</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;channel closed&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nb>println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=c1>// other case ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=æ„æ–™ä¹‹å¤–çš„å†…å­˜æ³„æ¼>æ„æ–™ä¹‹å¤–çš„å†…å­˜æ³„æ¼<a hidden class=anchor aria-hidden=true href=#æ„æ–™ä¹‹å¤–çš„å†…å­˜æ³„æ¼>#</a></h4><p>åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸æœ‰å®šæ—¶æ‰§è¡ŒæŸä¸ªä»»åŠ¡çš„éœ€æ±‚ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå®šæ—¶æ‰§è¡Œä»»åŠ¡çš„ç¤ºä¾‹ï¼ˆ<code>worker</code>ï¼‰ï¼Œï¼ˆå®Œæ•´ä»£ç åˆ°<a href="https://go.dev/play/p/F2Hk8iF5Ggl?v=goprev">Go Playground</a>è¿è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>worker1</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>count</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>timeout</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>c</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>count</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>timeout</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¿™æ®µä»£ç çœ‹ä¸å‡ºä»»ä½•æ¯›ç—…ï¼Œè¿è¡Œèµ·æ¥ä¹ŸOKï¼Œä¸‹é¢æ˜¯è¿™ä¸ªéœ€æ±‚çš„å¦ä¸€ä¸ªç‰ˆæœ¬ï¼ˆ<code>worker2</code>ï¼‰ï¼Œå’Œ<code>worker1</code>ç›¸æ¯”ï¼Œ<code>worker2</code>ä½¿ç”¨äº†time.NewTimeråˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>worker2</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>count</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>timeout</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>timer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>c</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nx>count</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nx>timeout</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¿™é‡Œç»™å‡ºè¿™ä¸¤æ®µä»£ç çš„å®Œæ•´ç¤ºä¾‹ï¼Œåˆ†åˆ«è§<a href="https://go.dev/play/p/F2Hk8iF5Ggl?v=goprev">work1</a>å’Œ<a href="https://go.dev/play/p/QFvmh4QwC7n?v=goprev">worker2</a>ã€‚å¦‚æœè¿è¡Œäº†worker1å’Œworker2çš„å®Œæ•´ç¤ºä¾‹ï¼Œä½ ä¼šå‘ç°è¿™ä¸¤ä¸ªä»£ç çš„å†…å­˜æ¶ˆè€—å·®åˆ«å¾ˆå¤§ï¼Œå› ä¸ºæ¯æ¬¡è°ƒç”¨time.Afteréƒ½ä¼šåˆ›å»ºä¸€ä¸ªtime.Timerå¯¹è±¡ï¼Œä¸”ä¸ä¼šè¢«GCå›æ”¶ï¼Œå¦‚æœè¿™æ®µä»£ç é•¿æ—¶é—´åœ¨çº¿ä¸Šè¿è¡Œï¼Œå°±å­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</p><h4 id=è·³ä¸å‡ºçš„å¾ªç¯>è·³ä¸å‡ºçš„å¾ªç¯<a hidden class=anchor aria-hidden=true href=#è·³ä¸å‡ºçš„å¾ªç¯>#</a></h4><p>Goè¯­è¨€ä¸­çš„breakç”¨äºè·³å‡ºforã€selectã€switchä½œç”¨çš„è¯­å¥å—ï¼Œå½“forå’Œselectæˆ–switchç»“åˆæ—¶ï¼Œè¦ç¡®ä¿èƒ½æŒ‰ç…§é¢„æœŸè·³å‡ºforå¾ªç¯ä½“ï¼›ï¼ˆå®Œæ•´ä¾‹å­è§<a href="https://go.dev/play/p/abNayy3m_Ku?v=goprev">Go Playground</a>ï¼‰</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=nx>stopCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;worker start&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;worker stop&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>timer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>stopCh</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;stop signal received&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// just break the select!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;do something&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>å¦‚æœæƒ³è·³å‡ºå¤šé‡è¯­å¥å—ï¼Œéœ€è¦é…åˆlabelä½¿ç”¨ï¼Œä¿®æ­£åçš„ä»£ç å¦‚ä¸‹ï¼Œï¼ˆå®Œæ•´ä¾‹å­è§<a href="https://go.dev/play/p/Zzm_QJI0Gea?v=goprev">Go Playground</a>ï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=nx>stopCh</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;worker start&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;worker stop&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>timer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nx>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>stopCh</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;stop signal received&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// break the for loop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w> </span><span class=nx>loop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>println</span><span class=p>(</span><span class=s>&#34;do something&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=defer>defer<a hidden class=anchor aria-hidden=true href=#defer>#</a></h3><h4 id=deferä¼ å‚>deferä¼ å‚<a hidden class=anchor aria-hidden=true href=#deferä¼ å‚>#</a></h4><p>deferå…³é”®å­—ä¼šä½¿å‡½æ•°å»¶è¿Ÿæ‰§è¡Œï¼Œä½†æ˜¯å‡½æ•°çš„<strong>å‚æ•°æ˜¯åœ¨æ‰§è¡Œdeferçš„æ—¶å€™å°±è¢«ç¡®å®šçš„</strong>ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æƒ³åœ¨<code>accumulate</code>å‡½æ•°æ‰§è¡Œå®Œä¹‹åè®°å½•ä¸€ä¸‹<code>sum</code>å€¼ï¼Œä½†æ˜¯deferè®°å½•çš„sumå€¼æ°¸è¿œæ˜¯0ã€‚ï¼ˆåˆ°<a href=https://go.dev/play/p/a80RbEUhu84>Go Playgroundè¿è¡Œ</a>ï¼‰</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>accumulate</span><span class=p>(</span><span class=nx>nums</span><span class=w> </span><span class=p>[]</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>sum</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// log the sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;sum = %d\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>sum</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>num</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>nums</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>num</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¦æƒ³é€šè¿‡deferè®°å½•çœŸå®çš„sumå€¼ï¼Œéœ€è¦ç”¨åˆ°é—­åŒ…ï¼ˆåŒ¿åå‡½æ•°ï¼‰ï¼Œå› ä¸ºåœ¨é—­åŒ…ä¸­å¼•ç”¨å¤–éƒ¨å˜é‡æ—¶ï¼Œä¼šä»¥å¼•ç”¨çš„æ–¹å¼ä½¿ç”¨å¤–éƒ¨å˜é‡ã€‚ï¼ˆåˆ°<a href=https://go.dev/play/p/kQ23x8lW7K5>Go Playgroundè¿è¡Œ</a>ï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>accumulate</span><span class=p>(</span><span class=nx>nums</span><span class=w> </span><span class=p>[]</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>sum</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// log the sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;sum = %d\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>sum</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>num</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>nums</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>num</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=å¾ªç¯ä¸­ä½¿ç”¨defer>å¾ªç¯ä¸­ä½¿ç”¨defer<a hidden class=anchor aria-hidden=true href=#å¾ªç¯ä¸­ä½¿ç”¨defer>#</a></h4><p>åœ¨å¾ªç¯ä¸­ä½¿ç”¨deferè¦æ…é‡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼Œåœ¨æ‰“å¼€æ–‡ä»¶ä¸å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œå¾ªç¯æ— æ³•ç»“æŸï¼Œå› æ­¤æ–‡ä»¶æè¿°ç¬¦ä¹Ÿæ— æ³•è¢«åŠæ—¶é‡Šæ”¾ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>readFiles</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>f</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>file</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>defer</span><span class=w> </span><span class=nx>file</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do something with file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=ä¸¥è‚ƒå¯¹å¾…ç”Ÿäº§ç¯å¢ƒ>ä¸¥è‚ƒå¯¹å¾…ç”Ÿäº§ç¯å¢ƒğŸ‘¨âœˆï¸<a hidden class=anchor aria-hidden=true href=#ä¸¥è‚ƒå¯¹å¾…ç”Ÿäº§ç¯å¢ƒ>#</a></h3><h4 id=jsonåºåˆ—åŒ–ä¸ååºåˆ—åŒ–>JSONåºåˆ—åŒ–ä¸ååºåˆ—åŒ–<a hidden class=anchor aria-hidden=true href=#jsonåºåˆ—åŒ–ä¸ååºåˆ—åŒ–>#</a></h4><p>ä¸€ä¸ªå®Œæ•´çš„çº¿ä¸ŠæœåŠ¡å¯èƒ½åŒ…å«ä½¿ç”¨ä¸åŒç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç»„ä»¶ï¼Œç»„ä»¶ä¹‹é—´çš„æ•°æ®äº¤æ¢æœ‰æ—¶ä¼šç”¨åˆ°JSONï¼Œå¯¹äºå¼ºç±»å‹çš„Goè¯­è¨€ä¸å¼±ç±»å‹çš„ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚luaï¼‰ä¹‹é—´ä¼ é€’JSONæ—¶éœ€è¦æ ¼å¤–å°å¿ƒã€‚è¯¦è§ï¼š<a href=https://moonbingbing.gitbooks.io/openresty-best-practices/content/json/array_or_object.html>ç¼–ç ä¸º array è¿˜æ˜¯ object</a>ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€æ®µç®€å•çš„luaä»£ç ï¼Œå¯¹ç©ºobjectåšencodeæ“ä½œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=o>===</span> <span class=n>TEST</span> <span class=mi>1</span><span class=p>:</span> <span class=n>empty</span> <span class=n>tables</span> <span class=n>as</span> <span class=n>objects</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>cjson</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;cjson&#34;</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>cjson.encode</span><span class=p>({}))</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>cjson.encode</span><span class=p>({</span><span class=n>dogs</span> <span class=o>=</span> <span class=p>{}}))</span>
</span></span></code></pre></div><p>å¯¹äºç©ºçš„objectï¼Œé»˜è®¤encodeç»“æœä¸º<code>{}</code>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>{}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;dogs&#34;</span>:<span class=o>{}}</span>
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥è®¾ç½®å°†ç©ºobjectå½“ä½œarrayå¤„ç†ï¼Œåªéœ€è¦è®¾ç½®ä¸€ä¸‹å³å¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=o>===</span> <span class=n>TEST</span> <span class=mi>2</span><span class=p>:</span> <span class=n>empty</span> <span class=n>tables</span> <span class=n>as</span> <span class=n>arrays</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>cjson</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;cjson&#34;</span>
</span></span><span class=line><span class=cl><span class=n>cjson.encode_empty_table_as_object</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>cjson.encode</span><span class=p>({}))</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>cjson.encode</span><span class=p>({</span><span class=n>dogs</span> <span class=o>=</span> <span class=p>{}}))</span>
</span></span></code></pre></div><p>è¾“å‡ºç»“ä¸ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;dogs&#34;</span>:<span class=o>[]}</span>
</span></span></code></pre></div><p>åœ¨luaä¸­ç©ºå¯¹è±¡ï¼Œæ—¢å¯ä»¥åºåˆ—åŒ–æˆobjectï¼Œä¹Ÿå¯ä»¥åºåˆ—åŒ–æˆarrayï¼Œè¿™ç§åŒä¸€ç§æ•°æ®å¯èƒ½ç”Ÿæˆä¸åŒç»“æœçš„è¡Œä¸ºä¼šè®©å¼ºç±»å‹è¯­è¨€å¾ˆéš¾åšï¼Œå› æ­¤Goè¯­è¨€é‡åˆ°è¿™ç§ä¸æœŸæœ›ç±»å‹ä¸ä¸€è‡´çš„æ•°æ®æ—¶ï¼Œ<code>Unmarshal</code>æ—¶ç›´æ¥è¿”å›é”™è¯¯ã€‚</p><h4 id=http>HTTP<a hidden class=anchor aria-hidden=true href=#http>#</a></h4><h5 id=ç¡®ä¿http-clientçœŸæ­£ç”¨äº†keep-alive>ç¡®ä¿HTTP clientçœŸæ­£ç”¨äº†keep-alive<a hidden class=anchor aria-hidden=true href=#ç¡®ä¿http-clientçœŸæ­£ç”¨äº†keep-alive>#</a></h5><p>ä¸‹é¢è¿™ä¸ªdoRequestä½¿ç”¨GETæ–¹æ³•è¯·æ±‚ç»™å®šçš„urlï¼Œå¦‚æœé¢‘ç¹è¯·æ±‚åŒä¸€ä¸ªurlï¼Œå¹¶ä¸ä¼šä½¿ç”¨HTTPçš„keep- aliveç‰¹æ€§ï¼Œè¦æƒ³ä½¿ç”¨keep-aliveéœ€è¦å°†HTTPçš„å“åº”çš„Bodyè¯»å®Œå¹¶ä¸”å…³é—­ã€‚ï¼ˆå¦‚æœä¸šåŠ¡éå¸¸ç®€å•ï¼Œæ— éœ€å¤„ç†å“åº”çš„Bodyï¼Œä¹Ÿå¿…é¡»æŠŠBodyè¯»å®Œï¼Œå¯ä»¥ç”¨<code>io.Copy(io.Discard, resp.Body)</code>ï¼‰ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå®Œæ•´çš„ä»‹ç»æ¡ˆä¾‹ï¼š<a href=https://golang.cafe/blog/how-to-reuse-http-connections-in-go.html>How To Reuse Http Connections In Go</a>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>doRequest</span><span class=p>(</span><span class=nx>url</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodGet</span><span class=p>,</span><span class=w> </span><span class=nx>url</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultClient</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;status code is not 200, got: %d&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>http.Response.Bodyå­—æ®µçš„<a href=https://github.com/golang/go/blob/db6097f8cbaceaed02051850d2411c88b763a0c3/src/net/http/response.go#L63>æ³¨é‡Š</a>ä¸­æ˜ç¡®è¯´æ˜å¦‚æœè¦å¤ç”¨HTTP1.xçš„keep-aliveåŠŸèƒ½ï¼Œéœ€è¦å°†Bodyè¯»å®Œï¼Œåˆ‡å…³é—­Bodyã€‚</p><blockquote><p>â€‹ // The http Client and Transport guarantee that Body is always</p><p>â€‹ // non-nil, even on responses without a body or responses with</p><p>â€‹ // a zero-length body. It is the caller&rsquo;s responsibility to</p><p>â€‹ // close Body. <strong>The default HTTP client&rsquo;s Transport may not</strong></p><p>â€‹ // <strong>reuse HTTP/1.x &ldquo;keep-alive&rdquo; TCP connections if the Body is</strong></p><p>â€‹ // <strong>not read to completion and closed.</strong></p></blockquote><h5 id=ä¸ä½¿ç”¨httpçš„é»˜è®¤é…ç½®>ä¸ä½¿ç”¨HTTPçš„é»˜è®¤é…ç½®<a hidden class=anchor aria-hidden=true href=#ä¸ä½¿ç”¨httpçš„é»˜è®¤é…ç½®>#</a></h5><p><strong>HTTP client</strong></p><p>httpåº“ä¸­<a href=https://github.com/golang/go/blob/db6097f8cbaceaed02051850d2411c88b763a0c3/src/net/http/client.go#L109>é»˜è®¤çš„HTTP client</a>æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ŒHTTP clientä¸­çš„Timeoutå­—æ®µçš„è¶…æ—¶æ—¶é—´æ˜¯æ•´ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒåº”è¯¥è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ã€‚</p><ul><li>å»ºè¿æ—¶é—´ï¼›<ul><li>DNSè§£æï¼›</li><li>TCPä¸‰æ¬¡æ¡æ‰‹ï¼›</li><li>TLSæ¡æ‰‹ï¼ˆå¦‚æœæ˜¯TLSï¼‰ï¼›</li></ul></li><li>å‘é€è¯·æ±‚ï¼›</li><li>é‡å®šå‘ï¼ˆå¦‚æœæœ‰ï¼‰ï¼›</li><li>è¯»å“åº”ï¼›</li></ul><p>http.Clientçš„<a href=https://github.com/golang/go/blob/db6097f8cbaceaed02051850d2411c88b763a0c3/src/net/http/client.go#L105>Timeoutå­—æ®µæºç </a>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Client</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Timeout specifies a time limit for requests made by this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Client. The timeout includes connection time, any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// redirects, and reading the response body. The timer remains</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// running after Get, Head, Post, or Do return and will</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// interrupt reading of the Response.Body.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>        // A Timeout of zero means no timeout.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>        // The Client cancels requests to the underlying Transport</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// as if the Request&#39;s Context ended.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>        // For compatibility, the Client will also use the deprecated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// CancelRequest method on Transport if found. New</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// RoundTripper implementations should use the Request&#39;s Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// for cancellation instead of implementing CancelRequest.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Timeout</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><img alt=http-timeline loading=lazy src=/images/posts/go-pitfall-guide/http-timeline.png></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„HTTP clientçš„ç¤ºä¾‹ï¼Œè®¾ç½®äº†å„ç§è¶…æ—¶æ—¶é—´ï¼ˆå…·ä½“å‚æ•°æ ¹æ®å®é™…æƒ…å†µç¡®å®šï¼‰ï¼Œè¿˜è®¾ç½®äº†æœ€å¤§ç©ºé—²è¿æ¥æ•°ç­‰ï¼ŒHTTP clientä¸­è¿˜æœ‰å¾ˆå¤šå‚æ•°ï¼Œåœ¨ç¨‹åºè°ƒä¼˜æ—¶å¯èƒ½ä¼šç”¨åˆ°ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=nx>client</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Transport</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Transport</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>DialContext</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=o>&amp;</span><span class=nx>net</span><span class=p>.</span><span class=nx>Dialer</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Timeout</span><span class=p>:</span><span class=w>   </span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w>  </span><span class=c1>// TCP å»ºè”æ—¶é—´ï¼Œé»˜è®¤3min</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>KeepAlive</span><span class=p>:</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w> </span><span class=c1>// keep alive æ¢æµ‹æ—¶é—´é—´éš”ï¼Œé»˜è®¤15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}).</span><span class=nx>DialContext</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>MaxIdleConns</span><span class=p>:</span><span class=w>          </span><span class=mi>100</span><span class=p>,</span><span class=w>              </span><span class=c1>// æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼ˆå¤„äºkeep aliveï¼‰,é»˜è®¤å€¼ä¸º2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>IdleConnTimeout</span><span class=p>:</span><span class=w>       </span><span class=mi>90</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w> </span><span class=c1>// keep aliveä¿æŒæœ€é•¿æ—¶é—´ï¼Œé»˜è®¤ä¸º0ï¼ˆæ— é™åˆ¶ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>TLSHandshakeTimeout</span><span class=p>:</span><span class=w>   </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w>  </span><span class=c1>// TLSæ¡æ‰‹è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸è®¾ç½®è¶…æ—¶æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ResponseHeaderTimeout</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w>  </span><span class=c1>// å‘é€å®Œè¯·æ±‚åˆ°æ”¶åˆ°å“åº”å¤´æ—¶é—´é—´éš”ï¼Œé»˜è®¤å€¼ä¸º0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Timeout</span><span class=p>:</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w> </span><span class=c1>// HTTPè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ŒåŒ…æ‹¬å»ºè¿ã€å‘é€è¯·æ±‚ã€æ¥æ”¶è¯·æ±‚ç­‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>HTTP server</strong></p><p>å’ŒHTTP clientç±»ä¼¼ï¼Œé»˜è®¤çš„HTTP serverå¾ˆå¤šé»˜è®¤çš„å‚æ•°ä¹Ÿä¸é€‚åˆåœ¨çº¿ä¸Šç¯å¢ƒè¿è¡Œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„http.Serverçš„å®šä¹‰ï¼ˆå…·ä½“å‚æ•°æ ¹æ®å®é™…æƒ…å†µç¡®å®šï¼‰ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=nx>server</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Addr</span><span class=p>:</span><span class=w>           </span><span class=s>&#34;8080&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ReadTimeout</span><span class=p>:</span><span class=w>    </span><span class=mi>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>WriteTimeout</span><span class=p>:</span><span class=w>   </span><span class=mi>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>MaxHeaderBytes</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>20</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=ç±»å‹æ–­è¨€>ç±»å‹æ–­è¨€<a hidden class=anchor aria-hidden=true href=#ç±»å‹æ–­è¨€>#</a></h4><p>å¯¹interfaceè¿›è¡Œç±»å‹æ–­è¨€æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…å°±ä¼šè§¦å‘panicã€‚å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ç¬¬äºŒæ¬¡è°ƒç”¨<code>foo</code>æ—¶ä¼ é€’ä¸€ä¸ªstringç±»å‹çš„å‚æ•°å°±ä¼šå¯¼è‡´ç¨‹åºPanicã€‚ï¼ˆåˆ°<a href=https://go.dev/play/p/w9llVn9j_R9>Go Playgroundè¿è¡Œ</a>ï¼‰</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>a</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>i</span><span class=p>.(</span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>println</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>foo</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=c1>// ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>foo</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// panic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>å› æ­¤å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œåœ¨åšç±»å‹æ–­è¨€æ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨<em>common ok</em>çš„æ–¹å¼æ¥æ¥æ”¶è¿”å›å€¼ï¼Œé€šè¿‡ç¬¬äºŒä¸ªå‚æ•°æ¥åˆ¤æ–­ç±»å‹æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ä¸‹é¢æ˜¯è°ƒæ•´è¿‡çš„<code>foo</code>å‡½æ•°ï¼Œæ— è®ºä¼ é€’ä»€ä¹ˆç±»å‹ï¼Œ<code>foo</code>éƒ½ä¸ä¼šPanicã€‚ï¼ˆåˆ°<a href=https://go.dev/play/p/CG8N_VgWe7H>Go Playgroundè¿è¡Œ</a>ï¼‰</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>foo</span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>a</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>i</span><span class=p>.(</span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;want type of int, got %T, %q\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>println</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>åŒæ ·æ˜¯ç±»å‹æ–­è¨€ï¼Œæ—¢å¯ä»¥ç”¨ä¸€ä¸ªå˜é‡æ¥æ”¶ï¼Œä¹Ÿå¯ä»¥ç”¨ä¸¤ä¸ªå˜é‡æ¥æ”¶ã€‚è¿™å…¶å®æ˜¯Goæœ¬èº«æä¾›çš„è¯­æ³•ç³–ï¼Œç±»å‹æ–­è¨€æœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>runtime.getitab</code>ï¼Œ<code>runtime.getitab</code>çš„åŸå‹å¦‚ä¸‹ï¼ŒGoç¼–è¯‘å™¨åœ¨ç¼–è¯‘æºç æ—¶æ ¹æ®æ¥æ”¶è¿”å›å€¼çš„å˜é‡æ•°é‡å†³å®šè°ƒç”¨<code>runtime.getitab</code>æ—¶ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯<em>true</em>è¿˜æ˜¯<em>false</em>ï¼Œå¦‚æœç”¨ä¸€ä¸ªå‚æ•°æ¥æ”¶è¿”å›å€¼ï¼Œåˆ™<code>canfail</code>ä¸º<em>true</em>ï¼Œå¦‚æœç±»å‹ä¸ç¬¦åˆé¢„æœŸå°±ä¼šPanicã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>getitab</span><span class=p>(</span><span class=nx>inter</span><span class=w> </span><span class=o>*</span><span class=nx>interfacetype</span><span class=p>,</span><span class=w> </span><span class=nx>typ</span><span class=w> </span><span class=o>*</span><span class=nx>_type</span><span class=p>,</span><span class=w> </span><span class=nx>canfail</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>itab</span><span class=w>
</span></span></span></code></pre></div><h4 id=ç¦ç”¨ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•>ç¦ç”¨ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•<a hidden class=anchor aria-hidden=true href=#ç¦ç”¨ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•>#</a></h4><p>Goçš„TLSä½¿ç”¨çš„<a href=https://github.com/golang/go/blob/de4748c47c67392a57f250714509f590f68ad395/src/crypto/tls/cipher_suites.go#L339>é»˜è®¤å¯†ç å¥—ä»¶</a>ï¼ˆcipher suitesï¼‰åŒ…å«äº†å·²ç»è¢«è®¤ä¸ºä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•ï¼ˆä½¿ç”¨äº†<code>DES</code>å’Œ<code>3DES</code>ï¼Œå…·ä½“å½±å“è§<a href=https://nvd.nist.gov/vuln/detail/CVE-2016-2183>CVE-2016-2183è¯¦æƒ…</a>ï¼‰ï¼Œå¦‚æœå¯¹å®‰å…¨è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®åŠ å¯†ç®—æ³•ç™½åå•ï¼Œç¦ç”¨åŠ å¯†ç®—æ³•<code>DES</code>å’Œ<code>3DES</code>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// disable DES encrypt algorithm to avoid CVE-2016-2183</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>var</span><span class=w> </span><span class=nx>CipherSuites</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>uint16</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_RSA_WITH_RC4_128_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// tls.TLS_RSA_WITH_3DES_EDE_CBC_SHA,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_RSA_WITH_AES_128_CBC_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_RSA_WITH_AES_256_CBC_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_RSA_WITH_AES_128_CBC_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_RSA_WITH_AES_128_GCM_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_RSA_WITH_AES_256_GCM_SHA384</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_RC4_128_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// tls.TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// TLS 1.3 cipher suites.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_AES_128_GCM_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_AES_256_GCM_SHA384</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>tls</span><span class=p>.</span><span class=nx>TLS_CHACHA20_POLY1305_SHA256</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=ç‰ˆæœ¬ä¿¡æ¯>ç‰ˆæœ¬ä¿¡æ¯<a hidden class=anchor aria-hidden=true href=#ç‰ˆæœ¬ä¿¡æ¯>#</a></h4><p>åœ¨ä¸šåŠ¡å‘å±•çš„åˆæœŸé˜¶æ®µï¼Œè½¯ä»¶çš„CI/CDå¯èƒ½ä¸å®Œå–„ï¼Œæœ‰æ—¶å€™éœ€è¦é¢‘ç¹çš„äººå·¥æ“ä½œã€‚ä¸ºäº†èƒ½åŒºåˆ†åŒä¸€ä¸ªç¨‹åºçš„ä¸åŒç‰ˆæœ¬ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·æ¥åŒºåˆ†ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä»…ä»…å‡­ç‰ˆæœ¬å·å¹¶ä¸å®¹æ˜“åŒºåˆ†ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘å°†<code>commit id</code>ã€<code>build time</code>ç­‰ä¿¡æ¯å’Œ<code>version</code>ä¸€èµ·æ”¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œåœ¨ç¨‹åºçš„<code>main</code>åŒ…ä¸­å®šä¹‰äº†<code>version</code>ã€<code>commitID</code>ã€<code>buildTime</code>ï¼Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;flag&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>var</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>version</span><span class=w>   </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>commitID</span><span class=w>  </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>buildTime</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>printVerbose</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;version: %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>version</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;commit_id: %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>commitID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;build_time: %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>buildTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>flag</span><span class=p>.</span><span class=nf>Bool</span><span class=p>(</span><span class=s>&#34;version&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=s>&#34;print version&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=o>*</span><span class=nx>v</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nf>printVerbose</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ç¼–è¯‘çš„å‘½ä»¤å†™åœ¨Makefileä¸­ï¼Œåœ¨éœ€è¦ç¼–è¯‘çš„æ—¶å€™åªéœ€è¦makeä¸€ä¸‹å³å¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Makefile data-lang=Makefile><span class=line><span class=cl><span class=nv>VERSION</span> <span class=o>:=</span> dev
</span></span><span class=line><span class=cl><span class=nv>DATE</span> <span class=o>:=</span> <span class=k>$(</span>shell date -u <span class=s1>&#39;+%Y-%m-%d-%H%M UTC&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>COMMITID</span> <span class=o>:=</span> <span class=k>$(</span>shell git rev-parse --short HEAD<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>VERSION_FLAGS</span> <span class=o>:=</span> -X <span class=s2>&#34;main.version=</span><span class=k>$(</span>VERSION<span class=k>)</span><span class=s2>&#34;</span> -X <span class=s2>&#34;main.buildTime=</span><span class=k>$(</span>DATE<span class=k>)</span><span class=s2>&#34;</span> -X <span class=s2>&#34;main.commitID=</span><span class=k>$(</span>COMMITID<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    go build -buildvcs<span class=o>=</span><span class=nb>false</span> -ldflags<span class=o>=</span><span class=s1>&#39;$(VERSION_FLAGS)&#39;</span> -o demo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm demo
</span></span></code></pre></div><h2 id=å¸¸è¯†>å¸¸è¯†ğŸ’â™‚ï¸<a hidden class=anchor aria-hidden=true href=#å¸¸è¯†>#</a></h2><h3 id=å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’>å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’<a hidden class=anchor aria-hidden=true href=#å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’>#</a></h3><p>Goçš„dataå¯ä»¥åˆ†ä¸ºå››ä¸ªç±»å‹ï¼š<strong>åŸºæœ¬ç±»å‹</strong>ã€<strong>ç¬¦åˆç±»å‹</strong>ã€<strong>å¼•ç”¨ç±»å‹</strong>å’Œ<strong>æ¥å£</strong>ã€‚å¸¸è¯†å‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œé€šè¿‡æŒ‡é’ˆä¼ é€’å‚æ•°çš„æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Œä½†æ˜¯å¯¹äºstringã€sliceã€mapã€functionè€Œè¨€ï¼Œæ²¡æœ‰å¿…è¦ä½¿ç”¨æŒ‡é’ˆä¼ é€’ã€‚ä¼ é€’structå’Œarrayå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨æŒ‡é’ˆã€‚</p><p><img alt=go_data_type loading=lazy src=/images/posts/go-pitfall-guide/go_data_type.png>
<img alt=go_data_memory loading=lazy src=/images/posts/go-pitfall-guide/go_data_memory.png></p><h3 id=stringå’Œbyteç›¸äº’è½¬æ¢>stringå’Œ[]byteç›¸äº’è½¬æ¢<a hidden class=anchor aria-hidden=true href=#stringå’Œbyteç›¸äº’è½¬æ¢>#</a></h3><p>stringå’Œsliceå¯ä»¥ç›¸äº’è½¬æ¢ï¼Œä½†æ˜¯stringå’Œsliceä¹‹é—´çš„è½¬æ¢å¹¶ä¸æ˜¯ç®€å•çš„æŒ‡é’ˆä¹‹é—´çš„èµ‹å€¼ï¼Œè€Œæ˜¯è¦å°†åŸæ•°æ®å¤åˆ¶ä¸€ä»½åˆ°æ–°çš„å†…å­˜åœ°å€ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=nx>str</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;hello world&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nx>bs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nx>str2</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>bs</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><strong>string è½¬ slice</strong></p><p>string è½¬ sliceçš„æºç å¦‚ä¸‹ï¼Œå¦‚æœé¢„å…ˆåˆ†é…çš„å†…å­˜å¤§å°å¤§äºæºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ™ä¼šè°ƒç”¨<code>rawbyteslice</code>ç”³è¯·å†…å­˜ï¼Œæœ€ç»ˆå°†æºæ•°æ®å¤åˆ¶ï¼ˆ<code>copy</code>ï¼‰åˆ°æ–°çš„å†…å­˜åœ°å€ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>stringtoslicebyte</span><span class=p>(</span><span class=nx>buf</span><span class=w> </span><span class=o>*</span><span class=nx>tmpBuf</span><span class=p>,</span><span class=w> </span><span class=nx>s</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>b</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>buf</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=nx>buf</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>tmpBuf</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>b</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>buf</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>b</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>rawbyteslice</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>copy</span><span class=p>(</span><span class=nx>b</span><span class=p>,</span><span class=w> </span><span class=nx>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// rawbyteslice allocates a new byte slice. The byte slice is not zeroed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>rawbyteslice</span><span class=p>(</span><span class=nx>size</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>cap</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>roundupsize</span><span class=p>(</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>size</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>p</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>mallocgc</span><span class=p>(</span><span class=nx>cap</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>cap</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nf>memclrNoHeapPointers</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>size</span><span class=p>)),</span><span class=w> </span><span class=nx>cap</span><span class=o>-</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>size</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=nx>slice</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>b</span><span class=p>))</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>slice</span><span class=p>{</span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=nx>size</span><span class=p>,</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>cap</span><span class=p>)}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>slice è½¬ string</strong></p><p><a href=https://github.com/golang/go/blob/f94d82b2c03c756f1d8893dc0282e9608e7d32a1/src/runtime/string.go#L81C6-L81C23>sliceè½¬stringçš„æºç </a>å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¦å¤åˆ¶çš„stringçš„é•¿åº¦è¶…è¿‡äº†é¢„å…ˆåˆ†é…çš„å†…å­˜å¤§å°nï¼Œåˆ™ä¼šè°ƒç”¨mallocgcç”³è¯·å†…å­˜ã€‚æ— è®ºæ˜¯å¦éœ€è¦ç”³è¯·æ–°çš„å†…å­˜ï¼Œéƒ½ä¼šæ¶‰åŠåˆ°å°†æºæ•°æ®ï¼ˆstringæ‰€æŒ‡çš„å†…å®¹ï¼‰å¤åˆ¶ï¼ˆ<code>memmove</code>ï¼‰åˆ°ä¸ºsliceåˆ†é…çš„å†…å­˜ä¸­ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>slicebytetostring</span><span class=p>(</span><span class=nx>buf</span><span class=w> </span><span class=o>*</span><span class=nx>tmpBuf</span><span class=p>,</span><span class=w> </span><span class=nx>ptr</span><span class=w> </span><span class=o>*</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>p</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>buf</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>n</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>p</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>p</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>mallocgc</span><span class=p>(</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>n</span><span class=p>),</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>memmove</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>ptr</span><span class=p>),</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>n</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>String</span><span class=p>((</span><span class=o>*</span><span class=kt>byte</span><span class=p>)(</span><span class=nx>p</span><span class=p>),</span><span class=w> </span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=slice>Slice<a hidden class=anchor aria-hidden=true href=#slice>#</a></h3><p>ä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªèƒ½ä¿å­˜1000ä¸ª[]byteçš„sliceï¼Œå¹¶ä¸ºæ¯ä¸ªå…ƒç´ ç”³è¯·å¤§å°ä¸º1MBçš„å†…å­˜ï¼Œç„¶åè°ƒç”¨<code>keepFirstTwoElementsOnly</code>è·å–å‰ä¸¤ä¸ªå…ƒç´ ï¼Œï¼ˆåˆ°<a href=https://go.dev/play/p/vZneUA1tI2h>Go playground</a>è¿è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;runtime&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Foo</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>v</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=nx>runtime</span><span class=p>.</span><span class=nx>MemStats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>runtime</span><span class=p>.</span><span class=nf>ReadMemStats</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Alloc = %v KB\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>Alloc</span><span class=o>/</span><span class=mi>1024</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>keepFirstTwoElementsOnly</span><span class=p>(</span><span class=nx>foos</span><span class=w> </span><span class=p>[]</span><span class=nx>Foo</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=nx>Foo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>foos</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>foos</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=nx>Foo</span><span class=p>,</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>foos</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>Foo</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nx>v</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>two</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>keepFirstTwoElementsOnly</span><span class=p>(</span><span class=nx>foos</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>runtime</span><span class=p>.</span><span class=nf>GC</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>runtime</span><span class=p>.</span><span class=nf>KeepAlive</span><span class=p>(</span><span class=nx>two</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>è§£å†³æ–¹æ³•</strong></p><p>é‡æ–°åˆ›å»ºlenå’Œcapå‡ä¸º2çš„sliceï¼ŒæŠŠå‰ä¸¤ä¸ªå…ƒç´ æ‹·è´åˆ°æ–°çš„sliceä¸­ï¼Œï¼ˆåˆ°<a href=https://go.dev/play/p/yRnIcz7C3yl>Go Playground</a>è¿è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>keepFirstTwoElementsOnly</span><span class=p>(</span><span class=nx>foos</span><span class=w> </span><span class=p>[]</span><span class=nx>Foo</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=nx>Foo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>res</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=nx>Foo</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>copy</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=nx>foos</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=map>Map<a hidden class=anchor aria-hidden=true href=#map>#</a></h3><p>ä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªkeyä¸ºintï¼Œvalueä¸º[128]çš„mapï¼Œsizeä¸º1024<em>1024çš„mapï¼Œç„¶åç»™[0ï½1024</em>1024)å†…çš„æ¯ä¸ªkeyåˆ›å»ºä¸€ä¸ªvalueï¼Œç„¶ååˆ é™¤æ‰€æœ‰çš„å…ƒç´ ã€‚ï¼ˆæ­¤ä»£ç ç”³è¯·çš„å†…å­˜è¾ƒå¤šï¼Œ<a href=https://go.dev/play/p/e3w15P7e5vl>Go Playground</a>æ— æ³•æ­£å¸¸æ‰§è¡Œå®ŒğŸ˜…ï¼Œå¦‚æƒ³æŸ¥çœ‹ç»“æœï¼Œéœ€åœ¨æœ¬åœ°æ‰§è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;runtime&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=nx>runtime</span><span class=p>.</span><span class=nx>MemStats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>runtime</span><span class=p>.</span><span class=nf>ReadMemStats</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Alloc = %v KB\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>Alloc</span><span class=o>/</span><span class=mi>1024</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// create a map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>m</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>][</span><span class=mi>128</span><span class=p>]</span><span class=kt>byte</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// print the memory usage before filling the map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// fill the map with 1024 * 1024 elements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>n</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>m</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=mi>128</span><span class=p>]</span><span class=kt>byte</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// print the memory usage after filling the map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>n</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>delete</span><span class=p>(</span><span class=nx>m</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// force GC to clear the map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>runtime</span><span class=p>.</span><span class=nf>GC</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// print the memory usage after deleting the map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>printAlloc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// keep the program running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>runtime</span><span class=p>.</span><span class=nf>KeepAlive</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>è¿è¡Œç»“æœ</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>Alloc = 127 KB
</span></span><span class=line><span class=cl>Alloc = 464373 KB
</span></span><span class=line><span class=cl>Alloc = 300477 KB
</span></span></code></pre></div><p>å¦‚æœå°†mapçš„valueç±»å‹ä¿®æ”¹ä¸ºæŒ‡é’ˆç±»å‹ï¼Œéœ€è¦çš„å†…å­˜ä¼šå°‘å¾ˆå¤šï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// ....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// create a map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// m := make(map[int][128]byte)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>m</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=o>*</span><span class=p>[</span><span class=mi>128</span><span class=p>]</span><span class=kt>byte</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// fill the map with 1024 * 1024 elements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>n</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// m[i] = [128]byte{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>m</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=p>[</span><span class=mi>128</span><span class=p>]</span><span class=kt>byte</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>è¿è¡Œç»“æœï¼š</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>Alloc = 127 KB
</span></span><span class=line><span class=cl>Alloc = 191634 KB
</span></span><span class=line><span class=cl>Alloc = 39305 KB
</span></span></code></pre></div><h3 id=ä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚>ä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#ä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚>#</a></h3><p>Goè¯­è¨€ä½¿ç”¨<code>UTF-8</code>ç¼–ç ï¼Œç»å¤§éƒ¨åˆ†æ±‰å­—çš„UTF-8ç¼–ç ä¸º3ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå› æ­¤ä¸èƒ½é»˜è®¤æ‰€æœ‰æ±‰å­—çš„UTF-8ç¼–ç éƒ½æ˜¯3ä¸ªå­—èŠ‚ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±èƒ½è¯´æ˜é—®é¢˜ï¼ˆåˆ°<a href="https://go.dev/play/p/b4-TwyEfUJj?v=goprev">Go Playround</a>è¿è¡Œï¼‰ï¼Œ<code>ä¸–</code>å’Œ<code>ç•Œ</code>çš„å¤§å°éƒ½ä¸º3å­—èŠ‚ï¼Œè€Œ<code>ğ œ</code>ï¼ˆxiÃ nï¼‰çš„å¤§å°ä¸º4å­—èŠ‚ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>str</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;ä¸–&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>str</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>str</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;ç•Œ&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>str</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>str</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;ğ œ&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>println</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>str</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>PSï¼š</strong></p><p><code>UTF-8</code>å…¨ç§°ä¸º<strong>Unicode Transformation Format - 8-bit</strong>ï¼Œ<code>Unicode</code> æ˜¯ä¸€ç§å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œç”¨äºè¡¨ç¤ºæ–‡å­—åœ¨è®¡ç®—æœºä¸­çš„å­—ç¬¦é›†ï¼Œå®ƒä¸ºä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰çš„ä¹¦å†™ç³»ç»Ÿä¸­çš„æ¯ä¸ªå­—ç¬¦åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„æ•°å€¼æ ‡è¯†ï¼Œç§°ä¸ºç ç‚¹ã€‚å¯ä»¥ç†è§£ä¸º<code>Unicode</code>ä¸ºæ¯ä¸ªç¬¦å·åˆ†é…äº†ä¸€ä¸ªç¼–å·ã€‚è€Œ<code>UTF-8</code>æ˜¯<code>Unicode</code>çš„ä¸€ç§å…·ä½“å®ç°æ–¹æ¡ˆï¼Œæ­¤å¤–è¿˜æœ‰<code>UTF-16</code>å’Œ<code>UTF-32</code>ç­‰å®ç°æ–¹æ¡ˆã€‚å’Œå…¶ä»–çš„ç¼–ç æ–¹å¼ç›¸æ¯”ï¼Œ<code>UTF-8</code>æ˜¯ä¸€ç§å…¼å®¹<code>ASCII</code>ï¼Œå¤„ç†æ•ˆç‡é«˜çš„ç¼–ç æ–¹å¼ï¼Œå› æ­¤åœ¨è®¡ç®—æœºç³»ç»Ÿå’Œç½‘ç»œç¯å¢ƒä¸­å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚ï¼ˆå»¶ä¼¸ï¼š<a href=https://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html>ASCIIï¼ŒUnicode å’Œ UTF-8</a>ï¼‰ã€‚</p><h3 id=æ‘†è„±ä¸äº†çš„å†…å­˜å¯¹é½>æ‘†è„±ä¸äº†çš„å†…å­˜å¯¹é½<a hidden class=anchor aria-hidden=true href=#æ‘†è„±ä¸äº†çš„å†…å­˜å¯¹é½>#</a></h3><p>ä¸‹é¢<code>S1</code>å’Œ<code>S2</code>ä¸¤ä¸ªstructçš„æˆå‘˜ç±»å‹ä¸€æ ·ï¼Œä½†æ˜¯é¡ºåºä¸ä¸€æ ·ã€‚è¿™ä¼šå¯¼è‡´ä¸¤ä¸ªç»“æ„ä½“å ç”¨çš„å†…å­˜å¤§å°å·®ä¸€å€ã€‚å¦‚æœåœ¨å¯¹èµ„æºæ¯”è¾ƒæ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼ˆå¦‚åˆ¶å®šåè®®å­—æ®µã€å­˜å‚¨ï¼‰ï¼Œéœ€è¦è€ƒè™‘å†…å­˜å¯¹é½ã€‚ï¼ˆåˆ°<a href="https://go.dev/play/p/fJbumYbvZGC?v=goprev">Go Playground</a>è¿è¡Œï¼‰ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// 32 bytes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>S1</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>a</span><span class=w> </span><span class=kt>int8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>b</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=w> </span><span class=kt>int8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=w> </span><span class=kt>int32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>e</span><span class=w> </span><span class=kt>int16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 16 bytes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>S2</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>a</span><span class=w> </span><span class=kt>int8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=w> </span><span class=kt>int8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>e</span><span class=w> </span><span class=kt>int16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=w> </span><span class=kt>int32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>b</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=å–„ç”¨åº“>å–„ç”¨åº“<a hidden class=anchor aria-hidden=true href=#å–„ç”¨åº“>#</a></h3><p>ä¸°å¯Œçš„åº“èµ„æºæ˜¯Goè¯­è¨€çš„ä¸€å¤§ä¼˜ç‚¹ï¼Œå¾ˆå¤šäº‹æƒ…å¯ä»¥ä½¿ç”¨æ ‡å‡†åº“æˆ–è€…ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“æ¥å®ç°å®Œæˆï¼Œæ²¡æœ‰å¿…è¦è‡ªå·±é‡æ–°é€ è½®å­ã€‚</p><h4 id=ä½¿ç”¨åº“ä¸­çš„å¸¸é‡å˜é‡>ä½¿ç”¨åº“ä¸­çš„å¸¸é‡ã€å˜é‡<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨åº“ä¸­çš„å¸¸é‡å˜é‡>#</a></h4><p>ä½¿ç”¨åº“ä¸­çš„å¸¸é‡ã€å˜é‡å¯ä»¥æé«˜ä»£ç çš„å¯é˜…è¯»æ€§ï¼Œå¦‚ï¼š</p><table><thead><tr><th><strong>ä¸ä½¿ç”¨åº“</strong></th><th><strong>ä½¿ç”¨åº“</strong></th></tr></thead><tbody><tr><td>200</td><td>http.StatusOK</td></tr><tr><td>&ldquo;2006-01-02 15:04:05&rdquo;</td><td>time.DateTime</td></tr><tr><td></td><td></td></tr></tbody></table><h4 id=ä½¿ç”¨æ ‡å‡†åº“å‡½æ•°>ä½¿ç”¨æ ‡å‡†åº“å‡½æ•°<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨æ ‡å‡†åº“å‡½æ•°>#</a></h4><p>åœ¨è¿›è¡Œ<em>æ–‡ä»¶è·¯å¾„æ“ä½œ</em>ï¼ˆå¦‚æ‹¼æ¥è·¯å¾„ï¼Œè·å–ç›®å½•ï¼Œè·å–æ–‡ä»¶åç­‰ï¼‰ã€<em>ç½‘ç»œåœ°å€æ“ä½œ</em>ï¼ˆæ‹¼æ¥IP+Portï¼Œæ‹†åˆ†IPã€Portï¼Œåˆ¤æ–­IPæ˜¯å¦ä¸ºIPv4ç­‰ï¼‰å¯ä»¥è°ƒç”¨æ ‡å‡†åº“ï¼Œå³å®‰å…¨åˆé«˜æ•ˆã€‚</p><h4 id=æ¨èçš„ç¬¬ä¸‰æ–¹åº“>æ¨èçš„ç¬¬ä¸‰æ–¹åº“<a hidden class=anchor aria-hidden=true href=#æ¨èçš„ç¬¬ä¸‰æ–¹åº“>#</a></h4><p>ä¸‹é¢åˆ—ä¸¾ä¸€äº›æˆ‘è‡ªå·±ç»å¸¸ç”¨åˆ°çš„ä¸€äº›å‡†æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ï¼š</p><table><thead><tr><th><strong>åº“å</strong></th><th><strong>åŠŸèƒ½</strong></th><th><strong>åº”ç”¨åœºæ™¯</strong></th></tr></thead><tbody><tr><td><a href=https://pkg.go.dev/github.com/sirupsen/logrus>logrus</a></td><td>æ ¼å¼åŒ–æ—¥å¿—åº“ï¼ˆå…·æœ‰æ—¥å¿—ç­‰çº§ï¼Œæ”¯æŒå¹¶å‘è®°å½•æ—¥å¿—ï¼Œæ”¯æŒHookç­‰ï¼‰</td><td>è®°å½•æ—¥å¿—</td></tr><tr><td><a href=https://pkg.go.dev/golang.org/x/sync/singleflight>singlefly</a></td><td>ç”¨äºåœ¨å¹¶å‘ç¯å¢ƒä¸­æ‰§è¡Œå¹‚ç­‰å‡½æ•°ã€‚</td><td>å¹¶å‘æŸ¥è¯¢æ•°æ®åº“ã€DNSè§£æ</td></tr><tr><td><a href=https://pkg.go.dev/github.com/cloudflare/tableflip>tableflip</a></td><td>è®©è¿›ç¨‹ä¼˜é›…åœ°é‡å¯ã€‚</td><td>ç½‘ç»œç¨‹åºå¹³æ»‘å‡çº§</td></tr><tr><td><a href=https://pkg.go.dev/github.com/jellydator/ttlcache/v3>ttlcache</a></td><td>å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„å†…å­˜ç¼“å­˜ã€‚</td><td>DNSç¼“å­˜</td></tr><tr><td><a href=https://pkg.go.dev/golang.org/x/sync/errgroup>errorgroup</a></td><td>ç”¨äºåœ¨å¹¶å‘ç¯å¢ƒä¸­å¤„ç†é”™è¯¯ã€‚å®ƒå¯ä»¥å°†å¤šä¸ªå¹¶å‘ä»»åŠ¡çš„ç»“æœèšåˆæˆä¸€ä¸ªç»“æœï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªé‡åˆ°çš„é”™è¯¯ã€‚</td><td>å¹¶å‘æ‰§è¡Œå¤šä¸ªç›¸äº’æœ‰å…³è”çš„ä»»åŠ¡çš„åœºæ™¯</td></tr></tbody></table><h1 id=å‚è€ƒ>å‚è€ƒ<a hidden class=anchor aria-hidden=true href=#å‚è€ƒ>#</a></h1><ul><li><a href=https://100go.co/>100 Go Mistakes and How to Avoid Them</a> (website)</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://rand0m42195.github.io/tags/go/>Go</a></li><li><a href=https://rand0m42195.github.io/tags/bug/>Bug</a></li></ul><nav class=paginav><a class=prev href=https://rand0m42195.github.io/posts/go-channel/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Go Channelæºç è§£è¯»</span>
</a><a class=next href=https://rand0m42195.github.io/posts/go-testing/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>è¯¦è§£Go Testing</span></a></nav></footer><div id=comments><script src=https://giscus.app/client.js data-repo=rand0m42195/rand0m42195.github.io data-repo-id=R_kgDOPzDcOw data-category=Announcements data-category-id=DIC_kwDOPzDcO84CvpUm data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://rand0m42195.github.io/>rand0m's blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>