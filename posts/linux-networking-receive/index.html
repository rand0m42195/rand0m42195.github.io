<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰ | rand0m's blog</title><meta name=keywords content="Networking,Linux,C"><meta name=description content="å¼•è¨€
ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ socket()ã€recv() å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚
æœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚
ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹
å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡
ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚
DMA å†™å…¥å†…å­˜
ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚
ä¸­æ–­é€šçŸ¥ CPU
ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚
é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰
é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ __napi_schedule()ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚
è½¯ä¸­æ–­è°ƒåº¦ NAPI poll
CPU æ‰§è¡Œ do_softirq() â†’ net_rx_action() â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚
poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb
é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› sk_buff ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚
åè®®æ ˆå¤„ç†
skb è¢«é€åˆ° IP å±‚ï¼Œè¿›ä¸€æ­¥äº¤ç»™ TCP/UDPï¼Œæœ€ç»ˆåˆ°è¾¾ socketï¼Œä¾›åº”ç”¨ç¨‹åºè¯»å–ã€‚

"><meta name=author content="rand0m"><link rel=canonical href=https://rand0m42195.github.io/posts/linux-networking-receive/><link crossorigin=anonymous href=/assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://rand0m42195.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rand0m42195.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rand0m42195.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://rand0m42195.github.io/apple-touch-icon.png><link rel=mask-icon href=https://rand0m42195.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rand0m42195.github.io/posts/linux-networking-receive/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://rand0m42195.github.io/posts/linux-networking-receive/"><meta property="og:site_name" content="rand0m's blog"><meta property="og:title" content="ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰"><meta property="og:description" content="å¼•è¨€ ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ socket()ã€recv() å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚
æœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚
ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹ å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š
æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡ ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚ DMA å†™å…¥å†…å­˜ ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚ ä¸­æ–­é€šçŸ¥ CPU ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚ é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰ é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ __napi_schedule()ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚ è½¯ä¸­æ–­è°ƒåº¦ NAPI poll CPU æ‰§è¡Œ do_softirq() â†’ net_rx_action() â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚ poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› sk_buff ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚ åè®®æ ˆå¤„ç† skb è¢«é€åˆ° IP å±‚ï¼Œè¿›ä¸€æ­¥äº¤ç»™ TCP/UDPï¼Œæœ€ç»ˆåˆ°è¾¾ socketï¼Œä¾›åº”ç”¨ç¨‹åºè¯»å–ã€‚ "><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-22T20:43:51+08:00"><meta property="article:modified_time" content="2025-09-22T20:43:51+08:00"><meta property="article:tag" content="Networking"><meta property="article:tag" content="Linux"><meta property="article:tag" content="C"><meta name=twitter:card content="summary"><meta name=twitter:title content="ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰"><meta name=twitter:description content="å¼•è¨€
ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ socket()ã€recv() å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚
æœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚
ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹
å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡
ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚
DMA å†™å…¥å†…å­˜
ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚
ä¸­æ–­é€šçŸ¥ CPU
ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚
é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰
é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ __napi_schedule()ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚
è½¯ä¸­æ–­è°ƒåº¦ NAPI poll
CPU æ‰§è¡Œ do_softirq() â†’ net_rx_action() â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚
poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb
é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› sk_buff ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚
åè®®æ ˆå¤„ç†
skb è¢«é€åˆ° IP å±‚ï¼Œè¿›ä¸€æ­¥äº¤ç»™ TCP/UDPï¼Œæœ€ç»ˆåˆ°è¾¾ socketï¼Œä¾›åº”ç”¨ç¨‹åºè¯»å–ã€‚

"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rand0m42195.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰","item":"https://rand0m42195.github.io/posts/linux-networking-receive/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰","name":"ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 \u002b Linux 4.4ä¸ºä¾‹ï¼‰","description":"å¼•è¨€ ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ socket()ã€recv() å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚\næœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚\nç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹ å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š\næ•°æ®åŒ…åˆ°è¾¾ç½‘å¡ ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚ DMA å†™å…¥å†…å­˜ ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚ ä¸­æ–­é€šçŸ¥ CPU ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚ é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰ é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ __napi_schedule()ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚ è½¯ä¸­æ–­è°ƒåº¦ NAPI poll CPU æ‰§è¡Œ do_softirq() â†’ net_rx_action() â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚ poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› sk_buff ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚ åè®®æ ˆå¤„ç† skb è¢«é€åˆ° IP å±‚ï¼Œè¿›ä¸€æ­¥äº¤ç»™ TCP/UDPï¼Œæœ€ç»ˆåˆ°è¾¾ socketï¼Œä¾›åº”ç”¨ç¨‹åºè¯»å–ã€‚ ","keywords":["Networking","Linux","C"],"articleBody":"å¼•è¨€ ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ socket()ã€recv() å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚\næœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚\nç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹ å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š\næ•°æ®åŒ…åˆ°è¾¾ç½‘å¡ ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚ DMA å†™å…¥å†…å­˜ ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚ ä¸­æ–­é€šçŸ¥ CPU ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚ é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰ é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ __napi_schedule()ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚ è½¯ä¸­æ–­è°ƒåº¦ NAPI poll CPU æ‰§è¡Œ do_softirq() â†’ net_rx_action() â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚ poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› sk_buff ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚ åè®®æ ˆå¤„ç† skb è¢«é€åˆ° IP å±‚ï¼Œè¿›ä¸€æ­¥äº¤ç»™ TCP/UDPï¼Œæœ€ç»ˆåˆ°è¾¾ socketï¼Œä¾›åº”ç”¨ç¨‹åºè¯»å–ã€‚ åœ¨å¼€å§‹å…·ä½“åˆ†æä¹‹å‰ï¼Œå…ˆè¯´ä»¥ä¸‹ç›¸å…³æºç çš„ä½ç½®ã€‚å’Œç½‘å¡ç›¸å…³çš„ä»£ç åœ¨é©±åŠ¨ç›®å½•ä¸‹ï¼ˆ/drivers/net/ethernetï¼‰ï¼Œç”±äºæˆ‘ä»¬åˆ†æçš„æ˜¯Intelçš„e1000ç½‘å¡ï¼Œæ‰€ä»¥å…·ä½“ä½ç½®å°±æ˜¯/drivers/net/ethernet/intel/e1000ï¼Œå†…æ ¸ç½‘ç»œåè®®æ ˆä½äºç½‘ç»œå­ç³»ç»Ÿç›®å½•ä¸‹/netï¼Œä¸»è¦æ˜¯/net/core/ç›®å½•ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†æIPv4ï¼Œæ‰€ä»¥è¿˜ä¼šæ¶‰åŠ/net/ipv4/ä¸­çš„å°‘é‡ä»£ç ã€‚\næ¥ä¸‹æ¥å°±ä»¥Intel e1000ç½‘å¡ä¸ºä¾‹ï¼Œæ¥ä¸€èµ·æ¢ç©¶ç½‘å¡æ”¶åŒ…è¿‡ç¨‹å§ğŸ˜€\ne1000 ç½‘å¡ DMA æ”¶åŒ…æœºåˆ¶ e1000 ç½‘å¡ä½¿ç”¨äº† DMAï¼ˆDirect Memory Accessï¼‰ï¼šç½‘å¡ç¡¬ä»¶è‡ªå·±æŠŠæ•°æ®å†™å…¥å†…å­˜ä¸­çš„æ¥æ”¶ç¼“å†²åŒºã€‚é‚£ä¹ˆLinuxå†…æ ¸å°±è¦å‘Šè¯‰ç½‘å¡åœ¨DMAæ“ä½œçš„æ—¶å€™æŠŠç½‘ç»œæ•°æ®åŒ…copyåˆ°å†…å­˜çš„å“ªä¸ªä½ç½®ï¼Ÿè¿™å°±éœ€è¦ç½‘å¡çš„é©±åŠ¨æå‰ä¸ºç½‘å¡åˆ†é…å¥½ä¸“é—¨ä¿å­˜æ•°æ®åŒ…çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ring bufferã€‚\nRing Buffer ä¸æè¿°ç¬¦é˜Ÿåˆ— é©±åŠ¨åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šä¸ºæ¥æ”¶æ•°æ®åˆ†é…ä¸€å—ç¯å½¢é˜Ÿåˆ—ï¼ˆRx Ring Bufferï¼‰ã€‚\né˜Ÿåˆ—ä¸­åŒ…å«å¤šä¸ª æ¥æ”¶æè¿°ç¬¦ï¼ˆRx Descriptorï¼‰ã€‚ æ¯ä¸ªæè¿°ç¬¦é‡Œæœ‰ï¼š Buffer åœ°å€ï¼ˆç‰©ç†åœ°å€ï¼Œå‘Šè¯‰ç½‘å¡æ•°æ®è¯¥å†™åˆ°å“ªï¼‰ Status æ ‡å¿—ä½ï¼ˆå¦‚ DD=1 è¡¨ç¤ºæ•°æ®å·²ç»å†™å¥½ï¼‰ ç½‘å¡åœ¨æ”¶åŒ…æ—¶ï¼Œå°±ä¼šï¼š\nè¯»å–ä¸‹ä¸€ä¸ªæè¿°ç¬¦é‡Œçš„ç¼“å†²åŒºåœ°å€ æŠŠæ•°æ®åŒ…é€šè¿‡ DMA å†™å…¥è¿™å—å†…å­˜ è®¾ç½®æè¿°ç¬¦çŠ¶æ€ï¼ˆDD=1ï¼‰ ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæè¿°ç¬¦ è¿™æ · CPU å®Œå…¨ä¸ç”¨å‚ä¸æ¬è¿ï¼Œåªéœ€åœ¨åˆé€‚çš„æ—¶æœºè¯»å–æè¿°ç¬¦å³å¯ã€‚\næºç ç‰‡æ®µï¼šRx Ring Buffer åˆå§‹åŒ– ä»¥ Linux 4.4 å†…æ ¸çš„ e1000 é©±åŠ¨ä¸ºä¾‹ï¼Œæ¥æ”¶é˜Ÿåˆ—åˆå§‹åŒ–é€»è¾‘åœ¨ e1000_setup_rx_resources() ä¸­ï¼ˆä½äº drivers/net/ethernet/intel/e1000/e1000_main.cï¼‰ã€‚è¿™æ®µä»£ç å±•ç¤ºäº†ç»™ç®¡ç†ç¼“å†²åŒºçš„e1000_rx_ringç»“æ„ä½“çš„æˆå‘˜èµ‹å€¼æƒ…å†µã€‚\n// file: drivers/net/ethernet/intel/e1000/e1000_main.c /** * e1000_setup_rx_resources - allocate Rx resources (Descriptors) * @adapter: board private structure * @rxdr: rx descriptor ring (for a specific queue) to setup * * Returns 0 on success, negative on failure **/ static int e1000_setup_rx_resources(struct e1000_adapter *adapter, struct e1000_rx_ring *rxdr) { struct pci_dev *pdev = adapter-\u003epdev; int size, desc_len; size = sizeof(struct e1000_rx_buffer) * rxdr-\u003ecount; rxdr-\u003ebuffer_info = vzalloc(size);\t// ä¸ºbuffer_infoåˆ†é…ç©ºé—´ï¼Œbuffer_infoæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æè¿°ä¸€ä¸ªæ¥æ”¶buffer if (!rxdr-\u003ebuffer_info) return -ENOMEM; desc_len = sizeof(struct e1000_rx_desc); /* Round up to nearest 4K */ rxdr-\u003esize = rxdr-\u003ecount * desc_len; rxdr-\u003esize = ALIGN(rxdr-\u003esize, 4096); rxdr-\u003edesc = dma_alloc_coherent(\u0026pdev-\u003edev, rxdr-\u003esize, \u0026rxdr-\u003edma, GFP_KERNEL); // åˆ†é…ä¸€å—è¿ç»­çš„ç‰©ç†å†…å­˜ç”¨äºå­˜æ”¾æè¿°ç¬¦æ•°ç»„ if (!rxdr-\u003edesc) { setup_rx_desc_die: vfree(rxdr-\u003ebuffer_info); return -ENOMEM; } // ... memset(rxdr-\u003edesc, 0, rxdr-\u003esize);\t// æŠŠæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦æ¢æ¸…ç©º rxdr-\u003enext_to_clean = 0;\t// ä¸‹ä¸€ä¸ªé©±åŠ¨è¦æ”¶å›çš„æè¿°ç¬¦ç´¢å¼• rxdr-\u003enext_to_use = 0;\t// ä¸‹ä¸€ä¸ªç¡¬ä»¶å¯ä»¥ç”¨æ¥DMAçš„æè¿°ç¬¦ç´¢å¼• rxdr-\u003erx_skb_top = NULL;\t// ç”¨äºå¤§åŒ…æ¥æ”¶æ—¶ï¼ˆåˆ†æ®µskbï¼‰çš„ä¸´æ—¶ç¼“å­˜ return 0; } çœ‹å®Œè¿™ä¸ªå‡½æ•°ä¸çŸ¥é“ä½ æ˜¯å¦æœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šè¿™ä¸ªå‡½æ•°ç”³è¯·äº†ä¸¤å—å†…å­˜ï¼Œä¸€å—æ˜¯ç”¨æ¥å­˜æ”¾e1000_rx_bufferæ•°ç»„çš„ï¼Œå¦ä¸€å—æ˜¯ç”¨æ¥å­˜æ”¾e1000_rx_descæ•°ç»„çš„ã€‚è¿™ä¸¤ä¸ªæ•°ç»„çš„å…ƒç´ éƒ½æ˜¯ç”¨æ¥æè¿°çœŸæ­£çš„ç¼“å†²åŒºçš„ï¼Œä½†æ˜¯è¿™é‡Œååæ²¡æœ‰åˆ†é…ç¼“å†²åŒºçš„æ“ä½œã€‚ç›¸åï¼Œè¿˜ç»™e1000_rx_descçš„æ‰€æœ‰å…ƒç´ éƒ½åˆå§‹åŒ–ä¸º0äº†ã€‚å…¶å®ç”³è¯·ç¼“å†²åŒºçš„æ“ä½œåœ¨åŒä¸€ä¸ªæ–‡ä»¶çš„å¦ä¸€ä¸ªå‡½æ•°e1000_alloc_rx_buffersä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å·¥ä½œå°±åˆ†é…æŒ‡å®šæ•°é‡çš„bufferï¼Œå¹¶å°†bufferä¸e1000_rx_ringç»“æ„ä½“çš„buffer_infoå’Œdescæˆå‘˜å…³è”èµ·æ¥ã€‚\n// file: drivers/net/ethernet/intel/e1000/e1000_main.c /** * e1000_alloc_rx_buffers - Replace used receive buffers; legacy \u0026 extended * @adapter: address of board private structure **/ static void e1000_alloc_rx_buffers(struct e1000_adapter *adapter, struct e1000_rx_ring *rx_ring, int cleaned_count) { struct e1000_hw *hw = \u0026adapter-\u003ehw; struct pci_dev *pdev = adapter-\u003epdev; struct e1000_rx_desc *rx_desc; struct e1000_rx_buffer *buffer_info; unsigned int i; unsigned int bufsz = adapter-\u003erx_buffer_len; i = rx_ring-\u003enext_to_use; buffer_info = \u0026rx_ring-\u003ebuffer_info[i]; while (cleaned_count--) { void *data; if (buffer_info-\u003erxbuf.data) goto skip; // ä¸ºbufferåˆ†é…å†…å­˜ data = e1000_alloc_frag(adapter);\tif (!data) { /* Better luck next round */ adapter-\u003ealloc_rx_buff_failed++; break; } // ...... // å°†bufferä¸buffer_infoå…³è” buffer_info-\u003edma = dma_map_single(\u0026pdev-\u003edev, data, adapter-\u003erx_buffer_len, DMA_FROM_DEVICE);\tif (dma_mapping_error(\u0026pdev-\u003edev, buffer_info-\u003edma)) { skb_free_frag(data); buffer_info-\u003edma = 0; adapter-\u003ealloc_rx_buff_failed++; break; } buffer_info-\u003erxbuf.data = data; skip: // å°†bufferä¸rx_descå…³è” rx_desc = E1000_RX_DESC(*rx_ring, i); rx_desc-\u003ebuffer_addr = cpu_to_le64(buffer_info-\u003edma); if (unlikely(++i == rx_ring-\u003ecount)) i = 0; buffer_info = \u0026rx_ring-\u003ebuffer_info[i]; } if (likely(rx_ring-\u003enext_to_use != i)) { rx_ring-\u003enext_to_use = i; if (unlikely(i-- == 0)) i = (rx_ring-\u003ecount - 1); /* Force memory writes to complete before letting h/w * know there are new descriptors to fetch. (Only * applicable for weak-ordered memory model archs, * such as IA-64). */ wmb(); writel(i, hw-\u003ehw_addr + rx_ring-\u003erdt); } } è¿™å°±æ˜¯ç½‘å¡çš„æ¥æ”¶ç¯å½¢ç¼“å†²åŒºçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåˆå§‹åŒ–ä¹‹åï¼Œç½‘å¡æ”¶åˆ°æ•°æ®åŒ…ä¹‹åå°±å¯ä»¥ç”¨DMAç›´æ¥å°†æ•°æ®åŒ…copyåˆ°å¯¹åº”çš„bufferä¸­ï¼Œå¹¶æ›´æ–°e1000_rx_ringçš„æˆå‘˜ï¼Œç„¶åå°±ä¼šè§¦å‘ä¸­æ–­ï¼Œé€šçŸ¥CPUæœ‰æ•°æ®åŒ…åˆ°è¾¾ã€‚ä¸‹é¢å°±è¯¥åˆ†æCPUæ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªä¸­æ–­è¯·æ±‚çš„ã€‚\nCPU å¦‚ä½•å¤„ç† e1000 ç½‘å¡ä¸­æ–­ å½“ç½‘å¡æ¥æ”¶åˆ°æ•°æ®åŒ…å¹¶é€šè¿‡ DMA å†™å…¥å†…å­˜åï¼Œä¼šå‘ CPU å‘å‡ºä¸­æ–­è¯·æ±‚ï¼ˆIRQï¼‰ï¼Œé€šçŸ¥æœ‰æ–°æ•°æ®åˆ°è¾¾ã€‚Linux å†…æ ¸ä¸­çš„ e1000 é©±åŠ¨ä¼šåœ¨ä¸­æ–­å‘é‡è¡¨ä¸­æ³¨å†Œè‡ªå·±çš„ä¸­æ–­å¤„ç†å‡½æ•°â€”â€” e1000_intrã€‚\nä¸­æ–­å¤„ç†å‡½æ•°è¿è¡Œåœ¨ ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸»è¦å®Œæˆä¸‰ä»¶äº‹ï¼š\nè¯»å–å¹¶æ¸…é™¤ç½‘å¡çš„ä¸­æ–­çŠ¶æ€å¯„å­˜å™¨ï¼Œç¡®è®¤äº‹ä»¶ç±»å‹ï¼ˆRxã€Txã€é“¾è·¯å˜åŒ–ç­‰ï¼‰ã€‚ ä¸´æ—¶å±è”½ä¸­æ–­ï¼Œé¿å…é‡å¤è§¦å‘ã€‚ è°ƒåº¦ NAPI pollï¼Œè°ƒç”¨ napi_schedule(\u0026adapter-\u003enapi) å°†ç½‘å¡åŠ å…¥è½¯ä¸­æ–­å¤„ç†é˜Ÿåˆ—ã€‚ NAPIï¼ˆNew APIï¼‰æ˜¯ Linux çš„ç½‘ç»œä¸­æ–­å‡è½½æœºåˆ¶ï¼šåœ¨é«˜æµé‡ä¸‹ï¼Œå®ƒé€šè¿‡è½®è¯¢ï¼ˆpollï¼‰æ‰¹é‡å¤„ç†æ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ•°æ®åŒ…è§¦å‘ç¡¬ä¸­æ–­ã€‚\n// file: drivers/net/ethernet/intel/e1000/e1000_main.c /** * e1000_intr - Interrupt Handler * @irq: interrupt number * @data: pointer to a network interface device structure **/ static irqreturn_t e1000_intr(int irq, void *data) { struct net_device *netdev = data; struct e1000_adapter *adapter = netdev_priv(netdev); struct e1000_hw *hw = \u0026adapter-\u003ehw; u32 icr = er32(ICR); if (unlikely((!icr))) return IRQ_NONE; /* Not our interrupt */ /* we might have caused the interrupt, but the above * read cleared it, and just in case the driver is * down there is nothing to do so return handled */ if (unlikely(test_bit(__E1000_DOWN, \u0026adapter-\u003eflags))) return IRQ_HANDLED; if (unlikely(icr \u0026 (E1000_ICR_RXSEQ | E1000_ICR_LSC))) { hw-\u003eget_link_status = 1; /* guard against interrupt when we're going down */ if (!test_bit(__E1000_DOWN, \u0026adapter-\u003eflags)) schedule_delayed_work(\u0026adapter-\u003ewatchdog_task, 1); } /* disable interrupts, without the synchronize_irq bit */ ew32(IMC, ~0);\t// ç¦æ­¢IMCï¼ˆInterrupt Mask Clearï¼‰ä¸­æ–­ E1000_WRITE_FLUSH(); if (likely(napi_schedule_prep(\u0026adapter-\u003enapi))) { adapter-\u003etotal_tx_bytes = 0; adapter-\u003etotal_tx_packets = 0; adapter-\u003etotal_rx_bytes = 0; adapter-\u003etotal_rx_packets = 0; __napi_schedule(\u0026adapter-\u003enapi);\t// è°ƒåº¦napi } else { /* this really should not happen! if it does it is basically a * bug, but not a hard error, so enable ints and continue */ if (!test_bit(__E1000_DOWN, \u0026adapter-\u003eflags)) e1000_irq_enable(adapter); } return IRQ_HANDLED; } e1000_intråšçš„äº‹æƒ…æ˜¯ä¸æ˜¯å¾ˆå°‘ï¼Ÿè¿™å°±å¯¹äº†ï¼Œå› ä¸ºLinuxå†…æ ¸å¤„ç†ç¡¬ä»¶ä¸­æ–­ä½¿ç”¨äº†ä¸ŠåŠéƒ¨/ä¸‹åŠéƒ¨çš„ä¸¤é˜¶æ®µæœºåˆ¶ï¼Œæ ¸å¿ƒç›®çš„æ˜¯æ—¢è¦å°½å¿«å“åº”ç¡¬ä»¶ï¼Œåˆè¦é¿å…é•¿æ—¶é—´å ç”¨CPUã€‚ä¸ŠåŠéƒ¨åªåšç´§æ€¥çš„å·¥ä½œï¼Œå¦‚ç¡®è®¤ä¸­æ–­æ¥æºã€é€šçŸ¥ç¡¬ä»¶å·²æ”¶åˆ°é€šçŸ¥ã€å”¤é†’ä¸‹åŠéƒ¨ç­‰ã€‚e1000_intrå°±å±äºä¸­æ–­çš„ä¸ŠåŠéƒ¨ã€‚\nè½¯ä¸­æ–­ä¸ NAPI è½®è¯¢æœºåˆ¶ åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç½‘å¡è§¦å‘ç¡¬ä¸­æ–­åï¼Œe1000 é©±åŠ¨çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆe1000_intrï¼‰ä¸»è¦å®Œæˆäº† ç¡®è®¤äº‹ä»¶ â†’ ä¸´æ—¶å±è”½ä¸­æ–­ â†’ è°ƒåº¦ NAPIã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼ŒçœŸæ­£çš„æ”¶åŒ…å·¥ä½œæ˜¯å¦‚ä½•å±•å¼€çš„å‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ° Linux ç½‘ç»œå­ç³»ç»Ÿé‡Œçš„ è½¯ä¸­æ–­ å’Œ NAPIã€‚\nç¡¬ä¸­æ–­åˆ°è½¯ä¸­æ–­çš„è¿‡æ¸¡ e1000_intrè°ƒç”¨äº†__napi_scheduleæ¥è°ƒåº¦NAPIã€‚napi_scheduleè¿˜ä¼šè°ƒç”¨____napi_scheduleã€‚__napi_schedule()çš„æ“ä½œå°±æ˜¯ï¼š\næŠŠå½“å‰ç½‘å¡å¯¹åº”çš„ napi_struct å¯¹è±¡åŠ å…¥åˆ°å…¨å±€çš„ NAPI é˜Ÿåˆ—ï¼› è®¾ç½® NET_RX_SOFTIRQ æ ‡å¿—ï¼Œå‘Šè¯‰å†…æ ¸åç»­éœ€è¦æ‰§è¡Œç½‘ç»œæ¥æ”¶çš„è½¯ä¸­æ–­ã€‚ è¿™æ ·ï¼ŒçœŸæ­£çš„æ•°æ®åŒ…å¤„ç†å°±è¢«å»¶è¿Ÿåˆ°äº†è½¯ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œé¿å…åœ¨ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡é‡Œåšå¤§é‡å·¥ä½œã€‚\n// file: net/core/dev.c /* Called with irq disabled */ static inline void ____napi_schedule(struct softnet_data *sd, struct napi_struct *napi) { list_add_tail(\u0026napi-\u003epoll_list, \u0026sd-\u003epoll_list);\t// æŠŠnapi_structå¯¹è±¡åŠ å…¥åˆ°å…¨å±€çš„NAPIé˜Ÿåˆ— __raise_softirq_irqoff(NET_RX_SOFTIRQ);\t// è®¾ç½®NET_RX_SOFTIRQæ ‡å¿—ï¼Œå‘Šè¯‰å†…æ ¸åç»­è¦æ‰§è¡Œç½‘ç»œæ¥æ”¶çš„è½¯ä¸­æ–­ } void __napi_schedule(struct napi_struct *n) { unsigned long flags; local_irq_save(flags); ____napi_schedule(this_cpu_ptr(\u0026softnet_data), n); // è°ƒç”¨____napi_schedule local_irq_restore(flags); } EXPORT_SYMBOL(__napi_schedule); è½¯ä¸­æ–­ç”± do_softirq() æ‰§è¡Œï¼Œå…¶ä¸­ä¼šè°ƒç”¨ net_rx_action()ï¼Œè¿™æ˜¯å› ä¸ºnet_devåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ³¨å†ŒNET_RX_SOFTIRQå’ŒNET_TX_SOFTIRQè½¯ä¸­æ–­ã€‚\n// file: net/core/dev.c /* *\tInitialize the DEV module. At boot time this walks the device list and *\tunhooks any devices that fail to initialise (normally hardware not *\tpresent) and leaves us with a valid list of present and active devices. * */ /* * This is called single threaded during boot, so no need * to take the rtnl semaphore. */ static int __init net_dev_init(void) { int i, rc = -ENOMEM; // ...... open_softirq(NET_TX_SOFTIRQ, net_tx_action);\t// æŒ‡å®šç”± net_tx_action å¤„ç† NET_TX_SOFTIRQ è½¯ä¸­æ–­ open_softirq(NET_RX_SOFTIRQ, net_rx_action);\t// æŒ‡å®šç”± net_rx_action å¤„ç† NET_RX_SOFTIRQ è½¯ä¸­æ–­ // ...... return rc; } subsys_initcall(net_dev_init); net_rx_action() çš„èŒè´£æ˜¯è½®è¯¢ NAPI é˜Ÿåˆ—ï¼Œé€ä¸ªè°ƒç”¨è®¾å¤‡é©±åŠ¨æ³¨å†Œçš„ poll æ–¹æ³•ã€‚ å¯¹ e1000 é©±åŠ¨æ¥è¯´ï¼Œè¿™ä¸ª poll å‡½æ•°å°±æ˜¯ e1000_clean()ã€‚\n// file: net/core/dev.c static void net_rx_action(struct softirq_action *h) { // ...... for (;;) { struct napi_struct *n; // ...... n = list_first_entry(\u0026list, struct napi_struct, poll_list);\t// ä»napi structé˜Ÿåˆ—ä¸­å–å‡ºnapiå¯¹è±¡ budget -= napi_poll(n, \u0026repoll);\t// å°†å¯¹è±¡äº¤ç»™ napi_poll å¤„ç†ï¼Œå¯¹äºe1000é©±åŠ¨æ¥è¯´ï¼Œpollå°±æ˜¯e1000_clean // ...... } // ...... } static int napi_poll(struct napi_struct *n, struct list_head *repoll) { void *have; int work, weight; // ...... work = 0; if (test_bit(NAPI_STATE_SCHED, \u0026n-\u003estate)) { work = n-\u003epoll(n, weight);\t// è°ƒç”¨ napi struct å¯¹è±¡çš„ poll å‡½æ•°å¤„ç† trace_napi_poll(n); } // ...... return work; } æœ€ç»ˆè½¯ä¸­æ–­è¿˜æ˜¯è°ƒç”¨äº†e1000ç½‘å¡çš„é©±åŠ¨å‡½æ•°e1000_cleanã€‚e1000_cleançš„èŒè´£æ˜¯ï¼šåœ¨è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­å¤„ç†æ”¶åŒ…ä¸å‘åŒ…çš„å®Œæˆé€»è¾‘ã€‚è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨æ”¶åŒ…ï¼Œå¿½ç•¥å‘åŒ…ã€‚å‘åŒ…çš„é€»è¾‘å®é™…æ˜¯è°ƒç”¨adapter-\u003eclean_rxæ¥å®Œæˆçš„ã€‚\n// file: drivers/net/ethernet/intel/e1000/e1000_main.c /** * e1000_clean - NAPI Rx polling callback * @adapter: board private structure **/ static int e1000_clean(struct napi_struct *napi, int budget) { struct e1000_adapter *adapter = container_of(napi, struct e1000_adapter, napi); int tx_clean_complete = 0, work_done = 0; /* 1. å›æ”¶å‘é€é˜Ÿåˆ— */ tx_clean_complete = e1000_clean_tx_irq(adapter, \u0026adapter-\u003etx_ring[0]); /* 2. å¤„ç†æ¥æ”¶é˜Ÿåˆ— */ adapter-\u003eclean_rx(adapter, \u0026adapter-\u003erx_ring[0], \u0026work_done, budget); /* 3. å¦‚æœå‘é€é˜Ÿåˆ—æ²¡æ¸…ç†å¹²å‡€ï¼Œå¼ºåˆ¶è®¤ä¸ºæ”¶åŒ…å·²ç»è¾¾åˆ° budget */ if (!tx_clean_complete) work_done = budget; /* 4. å¦‚æœæ”¶å‘å·¥ä½œæ²¡ç”¨å®Œ budgetï¼Œè¯´æ˜ä»»åŠ¡å®Œæˆï¼Œå¯ä»¥é€€å‡º NAPI è½®è¯¢ */ /* If budget not fully consumed, exit the polling mode */ if (work_done \u003c budget) { if (likely(adapter-\u003eitr_setting \u0026 3)) e1000_set_itr(adapter);\t// åŠ¨æ€è°ƒæ•´ä¸­æ–­é¢‘ç‡ napi_complete_done(napi, work_done);\t// æ ‡è®° NAPI å¤„ç†å®Œæˆ if (!test_bit(__E1000_DOWN, \u0026adapter-\u003eflags)) e1000_irq_enable(adapter);\t// é‡æ–°å¼€å¯ä¸­æ–­ } return work_done; } ä¸ºä»€ä¹ˆå‘åŒ…ç›´æ¥è°ƒç”¨e1000_clean_tx_irqï¼Œè€Œæ”¶æŠ¥ä¸æ˜¯ç›´æ¥è°ƒç”¨e1000_clean_rx_irqå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå¤„ç†æ”¶åŒ…çš„å‡½æ•°æœ‰å¤šä¸ªï¼Œå…·ä½“ä½¿ç”¨å“ªä¸ªæ˜¯ç”±é…ç½®å†³å®šçš„ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ï¼Œå¦‚æœMTUå¤§äºæ ‡å‡†ä»¥å¤ªç½‘æ•°æ®é•¿åº¦ETH_DATA_LENï¼ˆ1500 å­—èŠ‚ï¼‰å°±ä½¿ç”¨ä¸“é—¨å¤„ç†å·¨å¸§çš„å‡½æ•°ï¼Œå¦åˆ™å°±ä½¿ç”¨æ™®é€šçš„æ”¶åŒ…å‡½æ•°ã€‚åé¢æˆ‘ä»¬ä»¥æ™®é€šæ”¶åŒ…å‡½æ•°ï¼ˆe1000_clean_rx_irqï¼‰ä¸ºä¾‹è¿›è¡Œåˆ†æã€‚\n// file: drivers/net/ethernet/intel/e1000/e1000_main.c static void e1000_configure_rx(struct e1000_adapter *adapter) { // ...... if (adapter-\u003enetdev-\u003emtu \u003e ETH_DATA_LEN) { // æ£€æŸ¥ mtu æ˜¯å¦å¤§äº ETH_DATA_LEN(1500) rdlen = adapter-\u003erx_ring[0].count * sizeof(struct e1000_rx_desc); adapter-\u003eclean_rx = e1000_clean_jumbo_rx_irq;\t// ä½¿ç”¨ä¸“é—¨å¤„ç†jumbo frameçš„æ”¶åŒ…å‡½æ•° adapter-\u003ealloc_rx_buf = e1000_alloc_jumbo_rx_buffers; } else { rdlen = adapter-\u003erx_ring[0].count * sizeof(struct e1000_rx_desc); adapter-\u003eclean_rx = e1000_clean_rx_irq;\t// ä½¿ç”¨æ™®é€šæ”¶åŒ…å‡½æ•° adapter-\u003ealloc_rx_buf = e1000_alloc_rx_buffers; } // ...... } æ¦‚æ‹¬æ¥è¯´e1000_clean_rx_irqä»DMA ringå–å‡ºæŠ¥æ–‡ï¼Œå°è£…æˆskbï¼Œç„¶åäº¤ç»™e1000_receive_skbå¤„ç†ã€‚å…·ä½“åŒ…æ‹¬ï¼š\næ£€æŸ¥ DMA å®Œæˆæ ‡å¿—\næ¯ä¸ª rx_descï¼ˆæ¥æ”¶æè¿°ç¬¦ï¼‰åœ¨ç½‘å¡å†™å®Œæ•°æ®åï¼Œä¼šè®¾ç½® E1000_RXD_STAT_DDã€‚ é©±åŠ¨åªå¤„ç†å·²ç» DMA å®Œæˆçš„ bufferã€‚ æ„é€  skb\nå°åŒ…ï¼šè°ƒç”¨ e1000_copybreak()ï¼Œå¤åˆ¶æ•°æ®åˆ°æ–°å»ºçš„ skbã€‚ å¤§åŒ…ï¼šç›´æ¥ç”¨ build_skb()ï¼Œé¿å…å¤åˆ¶å¼€é”€ï¼Œç›´æ¥å¤ç”¨ DMA bufferã€‚ ä¸¢å¼ƒéæ³•æ•°æ®åŒ…\nå¦‚æœåŒ…è·¨è¶Šå¤šä¸ª bufferï¼ˆEOP æœªç½®ä½ï¼‰ï¼Œç›´æ¥ä¸¢å¼ƒã€‚ ç¡¬ä»¶å‘ç°çš„é”™è¯¯å¸§ï¼ˆCRC é”™è¯¯ç­‰ï¼‰ä¹Ÿä¼šä¸¢å¼ƒã€‚ åˆæ³•æ•°æ®åŒ…å¤„ç†\nè°ƒæ•´ skb é•¿åº¦ï¼Œå»æ‰ä»¥å¤ªç½‘ CRCã€‚ è°ƒç”¨ e1000_rx_checksum() åšç¡¬ä»¶æ ¡éªŒå’Œ offloadã€‚ è°ƒç”¨ e1000_receive_skb() æŠŠæŠ¥æ–‡äº¤ç»™ Linux ç½‘ç»œåè®®æ ˆï¼ˆä»è¿™ä¸€åˆ»å¼€å§‹ï¼Œæ•°æ®åŒ…å°±è¿›å…¥äº† TCP/IP æ ˆï¼‰ã€‚ å›æ”¶å’Œè¡¥å…… buffer\næ¸…ç©º rx_desc-\u003estatusï¼Œè¡¨ç¤ºè¿™ä¸ªæè¿°ç¬¦å¯ä»¥å†æ¬¡è¢«ç½‘å¡ä½¿ç”¨ã€‚ å®šæœŸè°ƒç”¨ alloc_rx_buf() ç»™ç½‘å¡è¡¥å……æ–°çš„ç©º bufferï¼Œé¿å… ring buffer è¢«è€—å°½ã€‚ // file: drivers/net/ethernet/intel/e1000/e1000_main.c /** * e1000_clean_rx_irq - Send received data up the network stack; legacy * @adapter: board private structure * @rx_ring: ring to clean * @work_done: amount of napi work completed this call * @work_to_do: max amount of work allowed for this call to do */ static bool e1000_clean_rx_irq(struct e1000_adapter *adapter, struct e1000_rx_ring *rx_ring, int *work_done, int work_to_do) { struct net_device *netdev = adapter-\u003enetdev; struct pci_dev *pdev = adapter-\u003epdev; struct e1000_rx_desc *rx_desc, *next_rxd; struct e1000_rx_buffer *buffer_info, *next_buffer; u32 length; unsigned int i; int cleaned_count = 0; bool cleaned = false; unsigned int total_rx_bytes=0, total_rx_packets=0; i = rx_ring-\u003enext_to_clean; rx_desc = E1000_RX_DESC(*rx_ring, i); buffer_info = \u0026rx_ring-\u003ebuffer_info[i]; while (rx_desc-\u003estatus \u0026 E1000_RXD_STAT_DD) {\t// æ£€æŸ¥DMAæ˜¯å¦å®Œæˆï¼ŒDD = Descriptor Done struct sk_buff *skb; u8 *data; u8 status; if (*work_done \u003e= work_to_do) break; (*work_done)++; dma_rmb(); /* read descriptor and rx_buffer_info after status DD */ status = rx_desc-\u003estatus; length = le16_to_cpu(rx_desc-\u003elength); data = buffer_info-\u003erxbuf.data;\t// dataå°±æ˜¯çœŸæ­£çš„buffer prefetch(data); // æ„é€ skbï¼Œå¦‚æœæ˜¯å°åŒ…ï¼Œç›´æ¥æŠŠæ•°æ®åŒ…å†…ä»ä»bufferä¸­copyä¸€ä»½ï¼Œå¦åˆ™ç›´æ¥ä½¿ç”¨buffer skb = e1000_copybreak(adapter, buffer_info, length, data); // ä¸ºå°åŒ…åˆ†é…skbï¼Œå¦‚æœæ˜¯å¤§åŒ…ï¼Œè¿”å›NULL if (!skb) {\t// å¤„ç†å¤§åŒ… unsigned int frag_len = e1000_frag_len(adapter); skb = build_skb(data - E1000_HEADROOM, frag_len); // ä¸ºå¤§åŒ…æ„é€ skb // ...... } // ...... process_skb: total_rx_bytes += (length - 4); /* don't count FCS */ total_rx_packets++; if (likely(!(netdev-\u003efeatures \u0026 NETIF_F_RXFCS))) /* adjust length to remove Ethernet CRC, this must be * done after the TBI_ACCEPT workaround above */ length -= 4; // è°ƒæ•´skb if (buffer_info-\u003erxbuf.data == NULL) skb_put(skb, length); else /* copybreak skb */ skb_trim(skb, length); // /* Receive Checksum Offload */ e1000_rx_checksum(adapter, (u32)(status) | ((u32)(rx_desc-\u003eerrors) \u003c\u003c 24), le16_to_cpu(rx_desc-\u003ecsum), skb); // äº¤ç»™e1000_receive_skbå¤„ç† e1000_receive_skb(adapter, status, rx_desc-\u003especial, skb); // ...... } // ...... // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ adapter-\u003etotal_rx_packets += total_rx_packets; adapter-\u003etotal_rx_bytes += total_rx_bytes; netdev-\u003estats.rx_bytes += total_rx_bytes; netdev-\u003estats.rx_packets += total_rx_packets; return cleaned; } e1000_receive_skbæ ¹æ®åè®®ï¼ˆå¯¹äºe1000ç½‘å¡æ¥è¯´ï¼Œå°±æ˜¯ä»¥å¤ªç½‘åè®®ï¼‰è°ƒæ•´skbçš„ç›¸å…³å­—æ®µï¼ˆå¦‚mac_headerã€dataç­‰ï¼‰ï¼Œç„¶åå°†skbäº¤ç»™napi_gro_receiveå¤„ç†ã€‚\n// file: drivers/net/ethernet/intel/e1000/e1000_main.c /** * e1000_receive_skb - helper function to handle rx indications * @adapter: board private structure * @status: descriptor status field as written by hardware * @vlan: descriptor vlan field as written by hardware (no le/be conversion) * @skb: pointer to sk_buff to be indicated to stack */ static void e1000_receive_skb(struct e1000_adapter *adapter, u8 status, __le16 vlan, struct sk_buff *skb) { skb-\u003eprotocol = eth_type_trans(skb, adapter-\u003enetdev);\t// è°ƒæ•´skbçš„mac_headerï¼Œæ ¹æ®L2 headeråˆ¤æ–­åè®®ç±»å‹ï¼Œå¹¶å°†skb-\u003edataæŒ‡å‘ä¸‹ä¸€å±‚åè®®å¤´ if (status \u0026 E1000_RXD_STAT_VP) { u16 vid = le16_to_cpu(vlan) \u0026 E1000_RXD_SPC_VLAN_MASK; __vlan_hwaccel_put_tag(skb, htons(ETH_P_8021Q), vid); } napi_gro_receive(\u0026adapter-\u003enapi, skb);\t// äº¤ç»™ä¸Šå±‚åè®®æ ˆå¤„ç† } napi_gro_receiveæ˜¯Linuxå†…æ ¸GROï¼ˆGeneric Receive Offloadï¼‰æ¥æ”¶è·¯å¾„çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ç°äº†å¯¹æ¥æ”¶åˆ°çš„skbè¿›è¡Œèšåˆå¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬ä¸å…³å¿ƒå…·ä½“çš„èšåˆæ“ä½œç»†èŠ‚ï¼ˆåªéœ€è¦çŸ¥é“dev_gro_receiveä¼šç»™napi_skb_finishè¿”å›èšåˆçš„ç»“æœå³å¯ï¼‰ï¼Œç›´æ¥çœ‹napi_skb_finishæ˜¯å¦‚ä½•å¤„ç†skbçš„ã€‚napi_skb_finishæ ¹æ®èšåˆç»“æœåˆ¤æ–­æ˜¯å¦ç»§ç»­å¤„ç†skbï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šå°†skbäº¤ç»™å…¶ä»–å‡½æ•°å¤„ç†ï¼Œæœ€ç»ˆskbä¼šè¢«__netif_receive_skb_coreå¤„ç†ã€‚\n// file: net/core/dev.c gro_result_t napi_gro_receive(struct napi_struct *napi, struct sk_buff *skb) { trace_napi_gro_receive_entry(skb);\t// è¿½è¸ªè°ƒè¯•å…¥å£ï¼Œå¯ç”¨äºftraceç­‰è·Ÿè¸ªå·¥å…· skb_gro_reset_offset(skb);\t// é‡ç½® skb çš„ GRO çŠ¶æ€ï¼Œè®© skb å¯ä»¥å‚ä¸èšåˆ // è°ƒç”¨ dev_gro_receive å°† skb äº¤ç»™è®¾å¤‡å±‚çš„ GROï¼Œ // dev_gro_receive ä¼šå°è¯•å°†å¤šä¸ªå°åŒ…èšåˆæˆå¤§åŒ…ï¼Œæé«˜å¤„ç†æ•ˆç‡ // napi_skb_finish æ ¹æ® dev_gro_receive çš„è¿”å›ç»“æœåšåç»­å¤„ç† return napi_skb_finish(dev_gro_receive(napi, skb), skb); } EXPORT_SYMBOL(napi_gro_receive); __netif_receive_skb_coreæ¯”è¾ƒé•¿ï¼Œä»¥ä¸‹æ˜¯ä¿ç•™äº†skbåˆ†å‘é€»è¾‘çš„ç®€åŒ–ç‰ˆæœ¬ã€‚ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š\nå…ˆåˆ†å‘ç»™å…¨å±€é“¾è¡¨ ptype_allï¼ˆtcpdump ç­‰ç›‘å¬å·¥å…·ä¼šåœ¨è¿™é‡Œæ”¶åˆ°æ•°æ®åŒ…ï¼‰ã€‚\nå†åˆ†å‘ç»™ç½‘å¡ä¸“å±é“¾è¡¨ dev-\u003eptype_allï¼ˆç½‘å¡åŠŸèƒ½ç›¸å…³ï¼‰ã€‚\nè°ƒç”¨ç½‘å¡ rx_handlerï¼ˆé©±åŠ¨è‡ªå®šä¹‰çš„æ¥æ”¶å›è°ƒï¼‰ã€‚\næ ¹æ®åè®®ç±»å‹åˆ†å‘ç»™ IPv4/IPv6/ARPç­‰å¤„ç†ã€‚\næœ€åè°ƒç”¨æœ€åä¸€ä¸ª packet_type çš„å¤„ç†å‡½æ•°æˆ–ä¸¢å¼ƒã€‚\nå¯¹äºIPæ•°æ®åŒ…ï¼Œå°±ä¼šåˆ†å‘ç»™ip_rcvå‡½æ•°å¤„ç†ã€‚è‡³æ­¤ç½‘ç»œæ•°æ®åŒ…å°±ä»ç½‘å¡åˆ°è¾¾åˆ°äº†ç½‘ç»œåè®®æ ˆçš„å…¥å£ã€‚\n// file: net/core/dev.c static int __netif_receive_skb_core(struct sk_buff *skb) { struct packet_type *ptype, *pt_prev; rx_handler_func_t *rx_handler; struct net_device *orig_dev; int ret = NET_RX_DROP; __be16 type; orig_dev = skb-\u003edev; pt_prev = NULL; // 1. åˆ†å‘ç»™å…¨å±€ packet_type é“¾è¡¨ï¼ˆæ‰€æœ‰ç½‘å¡å…±äº«ï¼‰ list_for_each_entry_rcu(ptype, \u0026ptype_all, list) { if (pt_prev) deliver_skb(skb, pt_prev, orig_dev); pt_prev = ptype; } // 2. åˆ†å‘ç»™å½“å‰ç½‘å¡ä¸“å± packet_type é“¾è¡¨ list_for_each_entry_rcu(ptype, \u0026skb-\u003edev-\u003eptype_all, list) { if (pt_prev) deliver_skb(skb, pt_prev, orig_dev); pt_prev = ptype; } // 3. è°ƒç”¨ç½‘å¡é©±åŠ¨å¯èƒ½è®¾ç½®çš„ rx_handler rx_handler = rcu_dereference(skb-\u003edev-\u003erx_handler); if (rx_handler) { if (pt_prev) { deliver_skb(skb, pt_prev, orig_dev); pt_prev = NULL; } switch (rx_handler(\u0026skb)) { case RX_HANDLER_CONSUMED: return NET_RX_SUCCESS; case RX_HANDLER_ANOTHER: // skb è¢«é‡å®šå‘ï¼Œéœ€è¦å†æ¬¡åˆ†å‘ pt_prev = NULL; break; case RX_HANDLER_EXACT: case RX_HANDLER_PASS: break; } } // 4. æŒ‰åè®®ç±»å‹åˆ†å‘ç»™å¯¹åº”é“¾è¡¨ï¼ˆIPv4/IPv6/ARPï¼‰ type = skb-\u003eprotocol; deliver_ptype_list_skb(skb, \u0026pt_prev, orig_dev, type, \u0026ptype_base[ntohs(type) \u0026 PTYPE_HASH_MASK]);\t// å¯¹äºTCP/UDPï¼Œå°±æ˜¯åœ¨è¿™é‡Œåˆ†å‘ç»™IPv4å¤„ç†çš„ deliver_ptype_list_skb(skb, \u0026pt_prev, orig_dev, type, \u0026orig_dev-\u003eptype_specific); // 5. æœ€ç»ˆè°ƒç”¨æœ€åä¸€ä¸ª packet_type çš„å¤„ç†å‡½æ•°ï¼Œæˆ–è€…ä¸¢å¼ƒ if (pt_prev) ret = pt_prev-\u003efunc(skb, skb-\u003edev, pt_prev, orig_dev); else { kfree_skb(skb); ret = NET_RX_DROP; } return ret; } è¿™é‡Œæ’æ’­ä¸€æ®µå†…å®¹ï¼štcpdumpçš„æŠ“åŒ…çš„å®ç°åŸç†å…¶å®å°±æ˜¯åˆ›å»ºPF_PACKETç±»å‹çš„socketå¹¶æ·»åŠ åˆ°ptype_allæˆ–è€…dev-\u003eptype_allï¼Œè€Œæ¯ä¸€ä¸ªæ•°æ®åŒ…éƒ½ä¼šç»å†å‰é¢çš„1ã€2ä¸¤ä¸ªåˆ†å‘è¿‡ç¨‹ã€‚å¯ä»¥çœ‹åˆ°tcpdumpçš„æŠ“åŒ…ä½ç½®åœ¨æ•°æ®åŒ…å¤„ç†çš„æ—©æœŸï¼ˆå…¥å‘æµé‡ï¼‰ï¼Œæ‰€ä»¥å³ä½¿æ•°æ®åŒ…ä¼šè¢«ä¸¢å¼ƒï¼Œtcpdumpä¹Ÿèƒ½æŠ“åˆ°å®Œæ•´çš„æ•°æ®åŒ…ã€‚\nå¦‚ä½•ç¡®å®šæŠŠæ•°æ®åŒ…åˆ†å‘ç»™è°å¤„ç†å‘¢ï¼Ÿå¯¹äºIPv4æ•°æ®åŒ…è€Œè¨€ï¼Œe1000ç½‘å¡åœ¨å°†skbäº¤ç»™napi_gro_receiveå‰ï¼Œä¼šè®¾ç½®skb-\u003eprotocolï¼Œ__netif_receive_skb_coreåœ¨åˆ†å‘çš„æ—¶å€™ä¼šåœ¨ptype_baseä¸­æŸ¥æ‰¾åŒ¹é…çš„å¤„ç†å‡½æ•°ï¼Œå¯¹äºIPv4è€Œè¨€ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°†ip_packet_typeæ·»åŠ åˆ°ptype_baseä¸­ã€‚\n// file: net/ipv4/af_inet.c static struct packet_type ip_packet_type __read_mostly = { .type = cpu_to_be16(ETH_P_IP), .func = ip_rcv,\t// å¤„ç†IPæ•°æ®åŒ…çš„å‡½æ•° }; static int __init inet_init(void) { // ...... dev_add_pack(\u0026ip_packet_type); // ...... } æ€»ç»“ ç»è¿‡ä¸€é€šåˆ†æï¼Œç»ˆäºæŠŠæ•°æ®åŒ…ä»ç½‘å¡é€åˆ°äº†å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œè¿˜æ„å¤–çš„å‘ç°äº†tcpdumpæŠ“åŒ…çš„ä½ç½®ï¼ˆå…¥å‘åŒ…ï¼‰ï¼ŒçœŸä¸å®¹æ˜“ã€‚å›è¿‡å¤´æ¥å†çœ‹è¿™ä¸ªè¿‡ç¨‹ï¼š\næ•°æ®åŒ…è¾¾åˆ°ç½‘å¡ï¼› ç½‘å¡é€šè¿‡DMAå°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼› ç½‘å¡é€šè¿‡IRQå‘Šè¯‰CPUæœ‰æ–°çš„ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ï¼› CPUå¿«é€Ÿå“åº”ç½‘å¡çš„IRQè¯·æ±‚ï¼Œç®€å•è°ƒç”¨__napi_schedule()ï¼ŒæŠŠNAPI pollåŠ å…¥è°ƒåº¦é˜Ÿåˆ—ï¼› è½¯ä¸­æ–­è°ƒåº¦NAPI pollï¼Œæœ€ç»ˆè°ƒç”¨e1000ç½‘å¡çš„pollå‡½æ•°ï¼ˆe1000_cleanï¼‰ï¼› ç½‘å¡çš„pollå‡½è¯»å–DMA ringæè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿›sk_buffç»“æ„ä½“ï¼ˆå³skbï¼‰ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿï¼› å†…æ ¸ç½‘ç»œå­ç³»ç»ŸæŒ‰ç…§åè®®ç±»å‹å°†skbåˆ†å‘ç»™å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¯¹äºIPæ•°æ®åŒ…è€Œè¨€ï¼Œå¤„ç†å‡½æ•°å°±æ˜¯ip_rcvï¼› åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°äº†åœ¨åˆ†å‘skbæ—¶ä¼šéå†ptype_allï¼Œå¦‚æœä½¿ç”¨tcpdumpæŠ“åŒ…ï¼Œtcpdumpåˆ›å»ºçš„socketå°±ä¼šè¢«æ·»åŠ åˆ°ptype_allä¸­ï¼Œæ‰€ä»¥å°±èƒ½æŠ“åˆ°L2~L7çš„å®Œæ•´æ•°æ®åŒ…ã€‚\nip_rcvå¦‚ä½•å¤„ç†æ•°æ®åŒ…çš„å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°è·¯ç”±ä»¥åŠåˆ†å‘ç»™L4å±‚å¤„ç†ï¼ˆå¦‚TCP/UDPï¼‰ã€‚è¿™å—å†…å®¹ç•™åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»ã€‚\n","wordCount":"1780","inLanguage":"zh","datePublished":"2025-09-22T20:43:51+08:00","dateModified":"2025-09-22T20:43:51+08:00","author":{"@type":"Person","name":"rand0m"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rand0m42195.github.io/posts/linux-networking-receive/"},"publisher":{"@type":"Organization","name":"rand0m's blog","logo":{"@type":"ImageObject","url":"https://rand0m42195.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rand0m42195.github.io/ accesskey=h title="rand0m's blog (Alt + H)">rand0m's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rand0m42195.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://rand0m42195.github.io/about/ title=å…³äº><span>å…³äº</span></a></li><li><a href=https://github.com/rand0m42195 title=GitHub><span>GitHub</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rand0m42195.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://rand0m42195.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰</h1><div class=post-meta><span title='2025-09-22 20:43:51 +0800 +0800'>ä¹æœˆ 22, 2025</span>&nbsp;Â·&nbsp;9 åˆ†é’Ÿ&nbsp;Â·&nbsp;rand0m</div></header><div class=post-content><h1 id=å¼•è¨€>å¼•è¨€<a hidden class=anchor aria-hidden=true href=#å¼•è¨€>#</a></h1><p>ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ <code>socket()</code>ã€<code>recv()</code> å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><p>æœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ <strong>ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æ</strong>ï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚</p><h1 id=ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹>ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹<a hidden class=anchor aria-hidden=true href=#ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹>#</a></h1><p>å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li><strong>æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡</strong>
ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚</li><li><strong>DMA å†™å…¥å†…å­˜</strong>
ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚</li><li><strong>ä¸­æ–­é€šçŸ¥ CPU</strong>
ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚</li><li><strong>é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰</strong>
é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ <code>__napi_schedule()</code>ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚</li><li><strong>è½¯ä¸­æ–­è°ƒåº¦ NAPI poll</strong>
CPU æ‰§è¡Œ <code>do_softirq()</code> â†’ <code>net_rx_action()</code> â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚</li><li><strong>poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb</strong>
é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› <code>sk_buff</code> ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚</li><li><strong>åè®®æ ˆå¤„ç†</strong>
skb è¢«é€åˆ° IP å±‚ï¼Œè¿›ä¸€æ­¥äº¤ç»™ TCP/UDPï¼Œæœ€ç»ˆåˆ°è¾¾ socketï¼Œä¾›åº”ç”¨ç¨‹åºè¯»å–ã€‚</li></ol><p><img alt=ç½‘å¡æ”¶åŒ…æµç¨‹ loading=lazy src=/images/posts/linux-networking-receive/nic-networking-stack.png></p><p>åœ¨å¼€å§‹å…·ä½“åˆ†æä¹‹å‰ï¼Œå…ˆè¯´ä»¥ä¸‹ç›¸å…³æºç çš„ä½ç½®ã€‚å’Œç½‘å¡ç›¸å…³çš„ä»£ç åœ¨é©±åŠ¨ç›®å½•ä¸‹ï¼ˆ<code>/drivers/net/ethernet</code>ï¼‰ï¼Œç”±äºæˆ‘ä»¬åˆ†æçš„æ˜¯Intelçš„e1000ç½‘å¡ï¼Œæ‰€ä»¥å…·ä½“ä½ç½®å°±æ˜¯<code>/drivers/net/ethernet/intel/e1000</code>ï¼Œå†…æ ¸ç½‘ç»œåè®®æ ˆä½äºç½‘ç»œå­ç³»ç»Ÿç›®å½•ä¸‹<code>/net</code>ï¼Œä¸»è¦æ˜¯<code>/net/core/</code>ç›®å½•ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†æIPv4ï¼Œæ‰€ä»¥è¿˜ä¼šæ¶‰åŠ<code>/net/ipv4/</code>ä¸­çš„å°‘é‡ä»£ç ã€‚</p><p>æ¥ä¸‹æ¥å°±ä»¥Intel e1000ç½‘å¡ä¸ºä¾‹ï¼Œæ¥ä¸€èµ·æ¢ç©¶ç½‘å¡æ”¶åŒ…è¿‡ç¨‹å§ğŸ˜€</p><h2 id=e1000-ç½‘å¡-dma-æ”¶åŒ…æœºåˆ¶>e1000 ç½‘å¡ DMA æ”¶åŒ…æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#e1000-ç½‘å¡-dma-æ”¶åŒ…æœºåˆ¶>#</a></h2><p>e1000 ç½‘å¡ä½¿ç”¨äº† <strong>DMAï¼ˆDirect Memory Accessï¼‰</strong>ï¼šç½‘å¡ç¡¬ä»¶è‡ªå·±æŠŠæ•°æ®å†™å…¥å†…å­˜ä¸­çš„æ¥æ”¶ç¼“å†²åŒºã€‚é‚£ä¹ˆLinuxå†…æ ¸å°±è¦å‘Šè¯‰ç½‘å¡åœ¨DMAæ“ä½œçš„æ—¶å€™æŠŠç½‘ç»œæ•°æ®åŒ…copyåˆ°å†…å­˜çš„å“ªä¸ªä½ç½®ï¼Ÿè¿™å°±éœ€è¦ç½‘å¡çš„é©±åŠ¨æå‰ä¸ºç½‘å¡åˆ†é…å¥½ä¸“é—¨ä¿å­˜æ•°æ®åŒ…çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ring bufferã€‚</p><h3 id=ring-buffer-ä¸æè¿°ç¬¦é˜Ÿåˆ—>Ring Buffer ä¸æè¿°ç¬¦é˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#ring-buffer-ä¸æè¿°ç¬¦é˜Ÿåˆ—>#</a></h3><p>é©±åŠ¨åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šä¸ºæ¥æ”¶æ•°æ®åˆ†é…ä¸€å—ç¯å½¢é˜Ÿåˆ—ï¼ˆRx Ring Bufferï¼‰ã€‚</p><ul><li>é˜Ÿåˆ—ä¸­åŒ…å«å¤šä¸ª <strong>æ¥æ”¶æè¿°ç¬¦ï¼ˆRx Descriptorï¼‰</strong>ã€‚</li><li>æ¯ä¸ªæè¿°ç¬¦é‡Œæœ‰ï¼š<ul><li><strong>Buffer åœ°å€</strong>ï¼ˆç‰©ç†åœ°å€ï¼Œå‘Šè¯‰ç½‘å¡æ•°æ®è¯¥å†™åˆ°å“ªï¼‰</li><li><strong>Status æ ‡å¿—ä½</strong>ï¼ˆå¦‚ DD=1 è¡¨ç¤ºæ•°æ®å·²ç»å†™å¥½ï¼‰</li></ul></li></ul><p>ç½‘å¡åœ¨æ”¶åŒ…æ—¶ï¼Œå°±ä¼šï¼š</p><ol><li>è¯»å–ä¸‹ä¸€ä¸ªæè¿°ç¬¦é‡Œçš„ç¼“å†²åŒºåœ°å€</li><li>æŠŠæ•°æ®åŒ…é€šè¿‡ DMA å†™å…¥è¿™å—å†…å­˜</li><li>è®¾ç½®æè¿°ç¬¦çŠ¶æ€ï¼ˆDD=1ï¼‰</li><li>ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæè¿°ç¬¦</li></ol><p>è¿™æ · CPU å®Œå…¨ä¸ç”¨å‚ä¸æ¬è¿ï¼Œåªéœ€åœ¨åˆé€‚çš„æ—¶æœºè¯»å–æè¿°ç¬¦å³å¯ã€‚</p><h3 id=æºç ç‰‡æ®µrx-ring-buffer-åˆå§‹åŒ–>æºç ç‰‡æ®µï¼šRx Ring Buffer åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#æºç ç‰‡æ®µrx-ring-buffer-åˆå§‹åŒ–>#</a></h3><p>ä»¥ Linux 4.4 å†…æ ¸çš„ e1000 é©±åŠ¨ä¸ºä¾‹ï¼Œæ¥æ”¶é˜Ÿåˆ—åˆå§‹åŒ–é€»è¾‘åœ¨ <code>e1000_setup_rx_resources()</code> ä¸­ï¼ˆä½äº <code>drivers/net/ethernet/intel/e1000/e1000_main.c</code>ï¼‰ã€‚è¿™æ®µä»£ç å±•ç¤ºäº†ç»™ç®¡ç†ç¼“å†²åŒºçš„<code>e1000_rx_ring</code>ç»“æ„ä½“çš„æˆå‘˜èµ‹å€¼æƒ…å†µã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * e1000_setup_rx_resources - allocate Rx resources (Descriptors)
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @adapter: board private structure
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @rxdr:    rx descriptor ring (for a specific queue) to setup
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Returns 0 on success, negative on failure
</span></span></span><span style=display:flex><span><span style=color:#75715e> **/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>e1000_setup_rx_resources</span>(<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter,
</span></span><span style=display:flex><span>				    <span style=color:#66d9ef>struct</span> e1000_rx_ring <span style=color:#f92672>*</span>rxdr)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> pci_dev <span style=color:#f92672>*</span>pdev <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>pdev;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> size, desc_len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	size <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> e1000_rx_buffer) <span style=color:#f92672>*</span> rxdr<span style=color:#f92672>-&gt;</span>count;
</span></span><span style=display:flex><span>	rxdr<span style=color:#f92672>-&gt;</span>buffer_info <span style=color:#f92672>=</span> <span style=color:#a6e22e>vzalloc</span>(size);	<span style=color:#75715e>// ä¸ºbuffer_infoåˆ†é…ç©ºé—´ï¼Œbuffer_infoæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æè¿°ä¸€ä¸ªæ¥æ”¶buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>rxdr<span style=color:#f92672>-&gt;</span>buffer_info)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>ENOMEM;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	desc_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> e1000_rx_desc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* Round up to nearest 4K */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	rxdr<span style=color:#f92672>-&gt;</span>size <span style=color:#f92672>=</span> rxdr<span style=color:#f92672>-&gt;</span>count <span style=color:#f92672>*</span> desc_len;
</span></span><span style=display:flex><span>	rxdr<span style=color:#f92672>-&gt;</span>size <span style=color:#f92672>=</span> <span style=color:#a6e22e>ALIGN</span>(rxdr<span style=color:#f92672>-&gt;</span>size, <span style=color:#ae81ff>4096</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	rxdr<span style=color:#f92672>-&gt;</span>desc <span style=color:#f92672>=</span> <span style=color:#a6e22e>dma_alloc_coherent</span>(<span style=color:#f92672>&amp;</span>pdev<span style=color:#f92672>-&gt;</span>dev, rxdr<span style=color:#f92672>-&gt;</span>size, <span style=color:#f92672>&amp;</span>rxdr<span style=color:#f92672>-&gt;</span>dma,
</span></span><span style=display:flex><span>					GFP_KERNEL); <span style=color:#75715e>// åˆ†é…ä¸€å—è¿ç»­çš„ç‰©ç†å†…å­˜ç”¨äºå­˜æ”¾æè¿°ç¬¦æ•°ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>rxdr<span style=color:#f92672>-&gt;</span>desc) {
</span></span><span style=display:flex><span>setup_rx_desc_die:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vfree</span>(rxdr<span style=color:#f92672>-&gt;</span>buffer_info);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>ENOMEM;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>memset</span>(rxdr<span style=color:#f92672>-&gt;</span>desc, <span style=color:#ae81ff>0</span>, rxdr<span style=color:#f92672>-&gt;</span>size);	<span style=color:#75715e>// æŠŠæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦æ¢æ¸…ç©º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	rxdr<span style=color:#f92672>-&gt;</span>next_to_clean <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;	<span style=color:#75715e>// ä¸‹ä¸€ä¸ªé©±åŠ¨è¦æ”¶å›çš„æè¿°ç¬¦ç´¢å¼•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	rxdr<span style=color:#f92672>-&gt;</span>next_to_use <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;		<span style=color:#75715e>// ä¸‹ä¸€ä¸ªç¡¬ä»¶å¯ä»¥ç”¨æ¥DMAçš„æè¿°ç¬¦ç´¢å¼•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	rxdr<span style=color:#f92672>-&gt;</span>rx_skb_top <span style=color:#f92672>=</span> NULL;	<span style=color:#75715e>// ç”¨äºå¤§åŒ…æ¥æ”¶æ—¶ï¼ˆåˆ†æ®µskbï¼‰çš„ä¸´æ—¶ç¼“å­˜ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>çœ‹å®Œè¿™ä¸ªå‡½æ•°ä¸çŸ¥é“ä½ æ˜¯å¦æœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šè¿™ä¸ªå‡½æ•°ç”³è¯·äº†ä¸¤å—å†…å­˜ï¼Œä¸€å—æ˜¯ç”¨æ¥å­˜æ”¾<code>e1000_rx_buffer</code>æ•°ç»„çš„ï¼Œå¦ä¸€å—æ˜¯ç”¨æ¥å­˜æ”¾<code>e1000_rx_desc</code>æ•°ç»„çš„ã€‚è¿™ä¸¤ä¸ªæ•°ç»„çš„å…ƒç´ éƒ½æ˜¯ç”¨æ¥æè¿°çœŸæ­£çš„ç¼“å†²åŒºçš„ï¼Œä½†æ˜¯è¿™é‡Œååæ²¡æœ‰åˆ†é…ç¼“å†²åŒºçš„æ“ä½œã€‚ç›¸åï¼Œè¿˜ç»™<code>e1000_rx_desc</code>çš„æ‰€æœ‰å…ƒç´ éƒ½åˆå§‹åŒ–ä¸º0äº†ã€‚å…¶å®ç”³è¯·ç¼“å†²åŒºçš„æ“ä½œåœ¨åŒä¸€ä¸ªæ–‡ä»¶çš„å¦ä¸€ä¸ªå‡½æ•°<code>e1000_alloc_rx_buffers</code>ä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å·¥ä½œå°±åˆ†é…æŒ‡å®šæ•°é‡çš„bufferï¼Œå¹¶å°†bufferä¸<code>e1000_rx_ring</code>ç»“æ„ä½“çš„<code>buffer_info</code>å’Œ<code>desc</code>æˆå‘˜å…³è”èµ·æ¥ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * e1000_alloc_rx_buffers - Replace used receive buffers; legacy &amp; extended
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @adapter: address of board private structure
</span></span></span><span style=display:flex><span><span style=color:#75715e> **/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>e1000_alloc_rx_buffers</span>(<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter,
</span></span><span style=display:flex><span>				   <span style=color:#66d9ef>struct</span> e1000_rx_ring <span style=color:#f92672>*</span>rx_ring,
</span></span><span style=display:flex><span>				   <span style=color:#66d9ef>int</span> cleaned_count)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_hw <span style=color:#f92672>*</span>hw <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>hw;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> pci_dev <span style=color:#f92672>*</span>pdev <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>pdev;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_rx_desc <span style=color:#f92672>*</span>rx_desc;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_rx_buffer <span style=color:#f92672>*</span>buffer_info;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> bufsz <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>rx_buffer_len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	i <span style=color:#f92672>=</span> rx_ring<span style=color:#f92672>-&gt;</span>next_to_use;
</span></span><span style=display:flex><span>	buffer_info <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>rx_ring<span style=color:#f92672>-&gt;</span>buffer_info[i];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (cleaned_count<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>data;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (buffer_info<span style=color:#f92672>-&gt;</span>rxbuf.data)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>goto</span> skip;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä¸ºbufferåˆ†é…å†…å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		data <span style=color:#f92672>=</span> <span style=color:#a6e22e>e1000_alloc_frag</span>(adapter);	
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>data) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* Better luck next round */</span>
</span></span><span style=display:flex><span>			adapter<span style=color:#f92672>-&gt;</span>alloc_rx_buff_failed<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å°†bufferä¸buffer_infoå…³è”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		buffer_info<span style=color:#f92672>-&gt;</span>dma <span style=color:#f92672>=</span> <span style=color:#a6e22e>dma_map_single</span>(<span style=color:#f92672>&amp;</span>pdev<span style=color:#f92672>-&gt;</span>dev,
</span></span><span style=display:flex><span>						  data,
</span></span><span style=display:flex><span>						  adapter<span style=color:#f92672>-&gt;</span>rx_buffer_len,
</span></span><span style=display:flex><span>						  DMA_FROM_DEVICE);	
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>dma_mapping_error</span>(<span style=color:#f92672>&amp;</span>pdev<span style=color:#f92672>-&gt;</span>dev, buffer_info<span style=color:#f92672>-&gt;</span>dma)) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>skb_free_frag</span>(data);
</span></span><span style=display:flex><span>			buffer_info<span style=color:#f92672>-&gt;</span>dma <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>			adapter<span style=color:#f92672>-&gt;</span>alloc_rx_buff_failed<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		buffer_info<span style=color:#f92672>-&gt;</span>rxbuf.data <span style=color:#f92672>=</span> data;
</span></span><span style=display:flex><span> skip:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å°†bufferä¸rx_descå…³è”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		rx_desc <span style=color:#f92672>=</span> <span style=color:#a6e22e>E1000_RX_DESC</span>(<span style=color:#f92672>*</span>rx_ring, i);
</span></span><span style=display:flex><span>		rx_desc<span style=color:#f92672>-&gt;</span>buffer_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>cpu_to_le64</span>(buffer_info<span style=color:#f92672>-&gt;</span>dma);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(<span style=color:#f92672>++</span>i <span style=color:#f92672>==</span> rx_ring<span style=color:#f92672>-&gt;</span>count))
</span></span><span style=display:flex><span>			i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		buffer_info <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>rx_ring<span style=color:#f92672>-&gt;</span>buffer_info[i];
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(rx_ring<span style=color:#f92672>-&gt;</span>next_to_use <span style=color:#f92672>!=</span> i)) {
</span></span><span style=display:flex><span>		rx_ring<span style=color:#f92672>-&gt;</span>next_to_use <span style=color:#f92672>=</span> i;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(i<span style=color:#f92672>--</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>			i <span style=color:#f92672>=</span> (rx_ring<span style=color:#f92672>-&gt;</span>count <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* Force memory writes to complete before letting h/w
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 * know there are new descriptors to fetch.  (Only
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 * applicable for weak-ordered memory model archs,
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 * such as IA-64).
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 */</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wmb</span>();
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>writel</span>(i, hw<span style=color:#f92672>-&gt;</span>hw_addr <span style=color:#f92672>+</span> rx_ring<span style=color:#f92672>-&gt;</span>rdt);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™å°±æ˜¯ç½‘å¡çš„æ¥æ”¶ç¯å½¢ç¼“å†²åŒºçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåˆå§‹åŒ–ä¹‹åï¼Œç½‘å¡æ”¶åˆ°æ•°æ®åŒ…ä¹‹åå°±å¯ä»¥ç”¨DMAç›´æ¥å°†æ•°æ®åŒ…copyåˆ°å¯¹åº”çš„bufferä¸­ï¼Œå¹¶æ›´æ–°<code>e1000_rx_ring</code>çš„æˆå‘˜ï¼Œç„¶åå°±ä¼šè§¦å‘ä¸­æ–­ï¼Œé€šçŸ¥CPUæœ‰æ•°æ®åŒ…åˆ°è¾¾ã€‚ä¸‹é¢å°±è¯¥åˆ†æCPUæ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªä¸­æ–­è¯·æ±‚çš„ã€‚</p><h3 id=cpu-å¦‚ä½•å¤„ç†-e1000-ç½‘å¡ä¸­æ–­>CPU å¦‚ä½•å¤„ç† e1000 ç½‘å¡ä¸­æ–­<a hidden class=anchor aria-hidden=true href=#cpu-å¦‚ä½•å¤„ç†-e1000-ç½‘å¡ä¸­æ–­>#</a></h3><p>å½“ç½‘å¡æ¥æ”¶åˆ°æ•°æ®åŒ…å¹¶é€šè¿‡ DMA å†™å…¥å†…å­˜åï¼Œä¼šå‘ CPU å‘å‡ºä¸­æ–­è¯·æ±‚ï¼ˆIRQï¼‰ï¼Œé€šçŸ¥æœ‰æ–°æ•°æ®åˆ°è¾¾ã€‚Linux å†…æ ¸ä¸­çš„ e1000 é©±åŠ¨ä¼šåœ¨ä¸­æ–­å‘é‡è¡¨ä¸­æ³¨å†Œè‡ªå·±çš„ä¸­æ–­å¤„ç†å‡½æ•°â€”â€” <code>e1000_intr</code>ã€‚</p><p>ä¸­æ–­å¤„ç†å‡½æ•°è¿è¡Œåœ¨ <strong>ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡</strong>ï¼Œä¸»è¦å®Œæˆä¸‰ä»¶äº‹ï¼š</p><ol><li>è¯»å–å¹¶æ¸…é™¤ç½‘å¡çš„ä¸­æ–­çŠ¶æ€å¯„å­˜å™¨ï¼Œç¡®è®¤äº‹ä»¶ç±»å‹ï¼ˆRxã€Txã€é“¾è·¯å˜åŒ–ç­‰ï¼‰ã€‚</li><li>ä¸´æ—¶å±è”½ä¸­æ–­ï¼Œé¿å…é‡å¤è§¦å‘ã€‚</li><li>è°ƒåº¦ NAPI pollï¼Œè°ƒç”¨ <code>napi_schedule(&amp;adapter->napi)</code> å°†ç½‘å¡åŠ å…¥è½¯ä¸­æ–­å¤„ç†é˜Ÿåˆ—ã€‚</li></ol><p>NAPIï¼ˆNew APIï¼‰æ˜¯ Linux çš„ç½‘ç»œä¸­æ–­å‡è½½æœºåˆ¶ï¼šåœ¨é«˜æµé‡ä¸‹ï¼Œå®ƒé€šè¿‡è½®è¯¢ï¼ˆpollï¼‰æ‰¹é‡å¤„ç†æ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ•°æ®åŒ…è§¦å‘ç¡¬ä¸­æ–­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * e1000_intr - Interrupt Handler
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @irq: interrupt number
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @data: pointer to a network interface device structure
</span></span></span><span style=display:flex><span><span style=color:#75715e> **/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>irqreturn_t</span> <span style=color:#a6e22e>e1000_intr</span>(<span style=color:#66d9ef>int</span> irq, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> net_device <span style=color:#f92672>*</span>netdev <span style=color:#f92672>=</span> data;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter <span style=color:#f92672>=</span> <span style=color:#a6e22e>netdev_priv</span>(netdev);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_hw <span style=color:#f92672>*</span>hw <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>hw;
</span></span><span style=display:flex><span>	u32 icr <span style=color:#f92672>=</span> <span style=color:#a6e22e>er32</span>(ICR);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>((<span style=color:#f92672>!</span>icr)))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> IRQ_NONE;  <span style=color:#75715e>/* Not our interrupt */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* we might have caused the interrupt, but the above
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * read cleared it, and just in case the driver is
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * down there is nothing to do so return handled
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(<span style=color:#a6e22e>test_bit</span>(__E1000_DOWN, <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>flags)))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> IRQ_HANDLED;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(icr <span style=color:#f92672>&amp;</span> (E1000_ICR_RXSEQ <span style=color:#f92672>|</span> E1000_ICR_LSC))) {
</span></span><span style=display:flex><span>		hw<span style=color:#f92672>-&gt;</span>get_link_status <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* guard against interrupt when we&#39;re going down */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>test_bit</span>(__E1000_DOWN, <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>flags))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>schedule_delayed_work</span>(<span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>watchdog_task, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* disable interrupts, without the synchronize_irq bit */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ew32</span>(IMC, <span style=color:#f92672>~</span><span style=color:#ae81ff>0</span>);	<span style=color:#75715e>// ç¦æ­¢IMCï¼ˆInterrupt Mask Clearï¼‰ä¸­æ–­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>E1000_WRITE_FLUSH</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(<span style=color:#a6e22e>napi_schedule_prep</span>(<span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>napi))) {
</span></span><span style=display:flex><span>		adapter<span style=color:#f92672>-&gt;</span>total_tx_bytes <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		adapter<span style=color:#f92672>-&gt;</span>total_tx_packets <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		adapter<span style=color:#f92672>-&gt;</span>total_rx_bytes <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		adapter<span style=color:#f92672>-&gt;</span>total_rx_packets <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>__napi_schedule</span>(<span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>napi);	<span style=color:#75715e>// è°ƒåº¦napi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* this really should not happen! if it does it is basically a
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 * bug, but not a hard error, so enable ints and continue
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>test_bit</span>(__E1000_DOWN, <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>flags))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>e1000_irq_enable</span>(adapter);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> IRQ_HANDLED;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>e1000_intr</code>åšçš„äº‹æƒ…æ˜¯ä¸æ˜¯å¾ˆå°‘ï¼Ÿè¿™å°±å¯¹äº†ï¼Œå› ä¸ºLinuxå†…æ ¸å¤„ç†ç¡¬ä»¶ä¸­æ–­ä½¿ç”¨äº†<strong>ä¸ŠåŠéƒ¨/ä¸‹åŠéƒ¨</strong>çš„ä¸¤é˜¶æ®µæœºåˆ¶ï¼Œæ ¸å¿ƒç›®çš„æ˜¯æ—¢è¦å°½å¿«å“åº”ç¡¬ä»¶ï¼Œåˆè¦é¿å…é•¿æ—¶é—´å ç”¨CPUã€‚ä¸ŠåŠéƒ¨åªåš<em>ç´§æ€¥</em>çš„å·¥ä½œï¼Œå¦‚ç¡®è®¤ä¸­æ–­æ¥æºã€é€šçŸ¥ç¡¬ä»¶å·²æ”¶åˆ°é€šçŸ¥ã€å”¤é†’ä¸‹åŠéƒ¨ç­‰ã€‚<code>e1000_intr</code>å°±å±äºä¸­æ–­çš„ä¸ŠåŠéƒ¨ã€‚</p><hr><h3 id=è½¯ä¸­æ–­ä¸-napi-è½®è¯¢æœºåˆ¶>è½¯ä¸­æ–­ä¸ NAPI è½®è¯¢æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#è½¯ä¸­æ–­ä¸-napi-è½®è¯¢æœºåˆ¶>#</a></h3><p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç½‘å¡è§¦å‘ç¡¬ä¸­æ–­åï¼Œe1000 é©±åŠ¨çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆ<code>e1000_intr</code>ï¼‰ä¸»è¦å®Œæˆäº† <strong>ç¡®è®¤äº‹ä»¶ â†’ ä¸´æ—¶å±è”½ä¸­æ–­ â†’ è°ƒåº¦ NAPI</strong>ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼ŒçœŸæ­£çš„æ”¶åŒ…å·¥ä½œæ˜¯å¦‚ä½•å±•å¼€çš„å‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ° Linux ç½‘ç»œå­ç³»ç»Ÿé‡Œçš„ <strong>è½¯ä¸­æ–­</strong> å’Œ <strong>NAPI</strong>ã€‚</p><h4 id=ç¡¬ä¸­æ–­åˆ°è½¯ä¸­æ–­çš„è¿‡æ¸¡>ç¡¬ä¸­æ–­åˆ°è½¯ä¸­æ–­çš„è¿‡æ¸¡<a hidden class=anchor aria-hidden=true href=#ç¡¬ä¸­æ–­åˆ°è½¯ä¸­æ–­çš„è¿‡æ¸¡>#</a></h4><p><code>e1000_intr</code>è°ƒç”¨äº†<code>__napi_schedule</code>æ¥è°ƒåº¦NAPIã€‚<code>napi_schedule</code>è¿˜ä¼šè°ƒç”¨<code>____napi_schedule</code>ã€‚<code>__napi_schedule()</code>çš„æ“ä½œå°±æ˜¯ï¼š</p><ul><li>æŠŠå½“å‰ç½‘å¡å¯¹åº”çš„ <code>napi_struct</code> å¯¹è±¡åŠ å…¥åˆ°å…¨å±€çš„ NAPI é˜Ÿåˆ—ï¼›</li><li>è®¾ç½® <code>NET_RX_SOFTIRQ</code> æ ‡å¿—ï¼Œå‘Šè¯‰å†…æ ¸åç»­éœ€è¦æ‰§è¡Œç½‘ç»œæ¥æ”¶çš„è½¯ä¸­æ–­ã€‚</li></ul><p>è¿™æ ·ï¼ŒçœŸæ­£çš„æ•°æ®åŒ…å¤„ç†å°±è¢«å»¶è¿Ÿåˆ°äº†è½¯ä¸­æ–­ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œé¿å…åœ¨ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡é‡Œåšå¤§é‡å·¥ä½œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: net/core/dev.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/* Called with irq disabled */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>____napi_schedule</span>(<span style=color:#66d9ef>struct</span> softnet_data <span style=color:#f92672>*</span>sd,
</span></span><span style=display:flex><span>				     <span style=color:#66d9ef>struct</span> napi_struct <span style=color:#f92672>*</span>napi)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>list_add_tail</span>(<span style=color:#f92672>&amp;</span>napi<span style=color:#f92672>-&gt;</span>poll_list, <span style=color:#f92672>&amp;</span>sd<span style=color:#f92672>-&gt;</span>poll_list);	<span style=color:#75715e>// æŠŠnapi_structå¯¹è±¡åŠ å…¥åˆ°å…¨å±€çš„NAPIé˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>__raise_softirq_irqoff</span>(NET_RX_SOFTIRQ);				<span style=color:#75715e>// è®¾ç½®NET_RX_SOFTIRQæ ‡å¿—ï¼Œå‘Šè¯‰å†…æ ¸åç»­è¦æ‰§è¡Œç½‘ç»œæ¥æ”¶çš„è½¯ä¸­æ–­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__napi_schedule</span>(<span style=color:#66d9ef>struct</span> napi_struct <span style=color:#f92672>*</span>n)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> flags;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>local_irq_save</span>(flags);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>____napi_schedule</span>(<span style=color:#a6e22e>this_cpu_ptr</span>(<span style=color:#f92672>&amp;</span>softnet_data), n); 	<span style=color:#75715e>// è°ƒç”¨____napi_schedule
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>local_irq_restore</span>(flags);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>EXPORT_SYMBOL</span>(__napi_schedule);
</span></span></code></pre></div><p>è½¯ä¸­æ–­ç”± <code>do_softirq()</code> æ‰§è¡Œï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>net_rx_action()</code>ï¼Œè¿™æ˜¯å› ä¸ºnet_devåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ³¨å†Œ<code>NET_RX_SOFTIRQ</code>å’Œ<code>NET_TX_SOFTIRQ</code>è½¯ä¸­æ–­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: net/core/dev.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> *	Initialize the DEV module. At boot time this walks the device list and
</span></span></span><span style=display:flex><span><span style=color:#75715e> *	unhooks any devices that fail to initialise (normally hardware not
</span></span></span><span style=display:flex><span><span style=color:#75715e> *	present) and leaves us with a valid list of present and active devices.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       This is called single threaded during boot, so no need
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       to take the rtnl semaphore.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>net_dev_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> i, rc <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>ENOMEM;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>open_softirq</span>(NET_TX_SOFTIRQ, net_tx_action);	<span style=color:#75715e>// æŒ‡å®šç”± net_tx_action å¤„ç† NET_TX_SOFTIRQ è½¯ä¸­æ–­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>open_softirq</span>(NET_RX_SOFTIRQ, net_rx_action);	<span style=color:#75715e>// æŒ‡å®šç”± net_rx_action å¤„ç† NET_RX_SOFTIRQ è½¯ä¸­æ–­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> rc;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>subsys_initcall</span>(net_dev_init);
</span></span></code></pre></div><p><code>net_rx_action()</code> çš„èŒè´£æ˜¯è½®è¯¢ NAPI é˜Ÿåˆ—ï¼Œé€ä¸ªè°ƒç”¨è®¾å¤‡é©±åŠ¨æ³¨å†Œçš„ <code>poll</code> æ–¹æ³•ã€‚ å¯¹ e1000 é©±åŠ¨æ¥è¯´ï¼Œè¿™ä¸ª poll å‡½æ•°å°±æ˜¯ <code>e1000_clean()</code>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: net/core/dev.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>net_rx_action</span>(<span style=color:#66d9ef>struct</span> softirq_action <span style=color:#f92672>*</span>h)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> napi_struct <span style=color:#f92672>*</span>n;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		n <span style=color:#f92672>=</span> <span style=color:#a6e22e>list_first_entry</span>(<span style=color:#f92672>&amp;</span>list, <span style=color:#66d9ef>struct</span> napi_struct, poll_list);	<span style=color:#75715e>// ä»napi structé˜Ÿåˆ—ä¸­å–å‡ºnapiå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		budget <span style=color:#f92672>-=</span> <span style=color:#a6e22e>napi_poll</span>(n, <span style=color:#f92672>&amp;</span>repoll);	<span style=color:#75715e>// å°†å¯¹è±¡äº¤ç»™ napi_poll å¤„ç†ï¼Œå¯¹äºe1000é©±åŠ¨æ¥è¯´ï¼Œpollå°±æ˜¯e1000_clean
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>napi_poll</span>(<span style=color:#66d9ef>struct</span> napi_struct <span style=color:#f92672>*</span>n, <span style=color:#66d9ef>struct</span> list_head <span style=color:#f92672>*</span>repoll)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>have;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> work, weight;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	work <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>test_bit</span>(NAPI_STATE_SCHED, <span style=color:#f92672>&amp;</span>n<span style=color:#f92672>-&gt;</span>state)) {
</span></span><span style=display:flex><span>		work <span style=color:#f92672>=</span> n<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>poll</span>(n, weight);	<span style=color:#75715e>// è°ƒç”¨ napi struct å¯¹è±¡çš„ poll å‡½æ•°å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>trace_napi_poll</span>(n);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> work;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æœ€ç»ˆè½¯ä¸­æ–­è¿˜æ˜¯è°ƒç”¨äº†e1000ç½‘å¡çš„é©±åŠ¨å‡½æ•°<code>e1000_clean</code>ã€‚e1000_cleançš„èŒè´£æ˜¯ï¼šåœ¨<em>è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­</em>å¤„ç†æ”¶åŒ…ä¸å‘åŒ…çš„å®Œæˆé€»è¾‘ã€‚è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨æ”¶åŒ…ï¼Œå¿½ç•¥å‘åŒ…ã€‚å‘åŒ…çš„é€»è¾‘å®é™…æ˜¯è°ƒç”¨<code>adapter->clean_rx</code>æ¥å®Œæˆçš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * e1000_clean - NAPI Rx polling callback
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @adapter: board private structure
</span></span></span><span style=display:flex><span><span style=color:#75715e> **/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>e1000_clean</span>(<span style=color:#66d9ef>struct</span> napi_struct <span style=color:#f92672>*</span>napi, <span style=color:#66d9ef>int</span> budget)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter <span style=color:#f92672>=</span> <span style=color:#a6e22e>container_of</span>(napi, <span style=color:#66d9ef>struct</span> e1000_adapter,
</span></span><span style=display:flex><span>						     napi);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> tx_clean_complete <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, work_done <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 1. å›æ”¶å‘é€é˜Ÿåˆ— */</span>
</span></span><span style=display:flex><span>	tx_clean_complete <span style=color:#f92672>=</span> <span style=color:#a6e22e>e1000_clean_tx_irq</span>(adapter, <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>tx_ring[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 2. å¤„ç†æ¥æ”¶é˜Ÿåˆ— */</span>
</span></span><span style=display:flex><span>	adapter<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>clean_rx</span>(adapter, <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>rx_ring[<span style=color:#ae81ff>0</span>], <span style=color:#f92672>&amp;</span>work_done, budget);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 3. å¦‚æœå‘é€é˜Ÿåˆ—æ²¡æ¸…ç†å¹²å‡€ï¼Œå¼ºåˆ¶è®¤ä¸ºæ”¶åŒ…å·²ç»è¾¾åˆ° budget */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>tx_clean_complete)
</span></span><span style=display:flex><span>		work_done <span style=color:#f92672>=</span> budget;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 4. å¦‚æœæ”¶å‘å·¥ä½œæ²¡ç”¨å®Œ budgetï¼Œè¯´æ˜ä»»åŠ¡å®Œæˆï¼Œå¯ä»¥é€€å‡º NAPI è½®è¯¢ */</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* If budget not fully consumed, exit the polling mode */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (work_done <span style=color:#f92672>&lt;</span> budget) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(adapter<span style=color:#f92672>-&gt;</span>itr_setting <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>e1000_set_itr</span>(adapter);				<span style=color:#75715e>// åŠ¨æ€è°ƒæ•´ä¸­æ–­é¢‘ç‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>napi_complete_done</span>(napi, work_done);	<span style=color:#75715e>// æ ‡è®° NAPI å¤„ç†å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>test_bit</span>(__E1000_DOWN, <span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>flags))
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>e1000_irq_enable</span>(adapter);			<span style=color:#75715e>// é‡æ–°å¼€å¯ä¸­æ–­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> work_done;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸ºä»€ä¹ˆå‘åŒ…ç›´æ¥è°ƒç”¨<code>e1000_clean_tx_irq</code>ï¼Œè€Œæ”¶æŠ¥ä¸æ˜¯ç›´æ¥è°ƒç”¨<code>e1000_clean_rx_irq</code>å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå¤„ç†æ”¶åŒ…çš„å‡½æ•°æœ‰å¤šä¸ªï¼Œå…·ä½“ä½¿ç”¨å“ªä¸ªæ˜¯ç”±é…ç½®å†³å®šçš„ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ï¼Œå¦‚æœMTUå¤§äºæ ‡å‡†ä»¥å¤ªç½‘æ•°æ®é•¿åº¦<code>ETH_DATA_LEN</code>ï¼ˆ1500 å­—èŠ‚ï¼‰å°±ä½¿ç”¨ä¸“é—¨å¤„ç†å·¨å¸§çš„å‡½æ•°ï¼Œå¦åˆ™å°±ä½¿ç”¨æ™®é€šçš„æ”¶åŒ…å‡½æ•°ã€‚åé¢æˆ‘ä»¬ä»¥æ™®é€šæ”¶åŒ…å‡½æ•°ï¼ˆ<code>e1000_clean_rx_irq</code>ï¼‰ä¸ºä¾‹è¿›è¡Œåˆ†æã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>e1000_configure_rx</span>(<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (adapter<span style=color:#f92672>-&gt;</span>netdev<span style=color:#f92672>-&gt;</span>mtu <span style=color:#f92672>&gt;</span> ETH_DATA_LEN) { 			<span style=color:#75715e>// æ£€æŸ¥ mtu æ˜¯å¦å¤§äº ETH_DATA_LEN(1500)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		rdlen <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>rx_ring[<span style=color:#ae81ff>0</span>].count <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>		        <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> e1000_rx_desc);
</span></span><span style=display:flex><span>		adapter<span style=color:#f92672>-&gt;</span>clean_rx <span style=color:#f92672>=</span> e1000_clean_jumbo_rx_irq;	<span style=color:#75715e>// ä½¿ç”¨ä¸“é—¨å¤„ç†jumbo frameçš„æ”¶åŒ…å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		adapter<span style=color:#f92672>-&gt;</span>alloc_rx_buf <span style=color:#f92672>=</span> e1000_alloc_jumbo_rx_buffers;
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		rdlen <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>rx_ring[<span style=color:#ae81ff>0</span>].count <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>		        <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> e1000_rx_desc);
</span></span><span style=display:flex><span>		adapter<span style=color:#f92672>-&gt;</span>clean_rx <span style=color:#f92672>=</span> e1000_clean_rx_irq;			<span style=color:#75715e>// ä½¿ç”¨æ™®é€šæ”¶åŒ…å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		adapter<span style=color:#f92672>-&gt;</span>alloc_rx_buf <span style=color:#f92672>=</span> e1000_alloc_rx_buffers;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>æ¦‚æ‹¬æ¥è¯´<code>e1000_clean_rx_irq</code>ä»DMA ringå–å‡ºæŠ¥æ–‡ï¼Œå°è£…æˆskbï¼Œç„¶åäº¤ç»™<code>e1000_receive_skb</code>å¤„ç†ã€‚å…·ä½“åŒ…æ‹¬ï¼š</p><p><strong>æ£€æŸ¥ DMA å®Œæˆæ ‡å¿—</strong></p><ul><li>æ¯ä¸ª <code>rx_desc</code>ï¼ˆæ¥æ”¶æè¿°ç¬¦ï¼‰åœ¨ç½‘å¡å†™å®Œæ•°æ®åï¼Œä¼šè®¾ç½® <code>E1000_RXD_STAT_DD</code>ã€‚</li><li>é©±åŠ¨åªå¤„ç†å·²ç» DMA å®Œæˆçš„ bufferã€‚</li></ul><p><strong>æ„é€  skb</strong></p><ul><li><strong>å°åŒ…</strong>ï¼šè°ƒç”¨ <code>e1000_copybreak()</code>ï¼Œå¤åˆ¶æ•°æ®åˆ°æ–°å»ºçš„ <code>skb</code>ã€‚</li><li><strong>å¤§åŒ…</strong>ï¼šç›´æ¥ç”¨ <code>build_skb()</code>ï¼Œé¿å…å¤åˆ¶å¼€é”€ï¼Œç›´æ¥å¤ç”¨ DMA bufferã€‚</li></ul><p><strong>ä¸¢å¼ƒéæ³•æ•°æ®åŒ…</strong></p><ul><li>å¦‚æœåŒ…è·¨è¶Šå¤šä¸ª bufferï¼ˆ<code>EOP</code> æœªç½®ä½ï¼‰ï¼Œç›´æ¥ä¸¢å¼ƒã€‚</li><li>ç¡¬ä»¶å‘ç°çš„é”™è¯¯å¸§ï¼ˆCRC é”™è¯¯ç­‰ï¼‰ä¹Ÿä¼šä¸¢å¼ƒã€‚</li></ul><p><strong>åˆæ³•æ•°æ®åŒ…å¤„ç†</strong></p><ul><li>è°ƒæ•´ <code>skb</code> é•¿åº¦ï¼Œå»æ‰ä»¥å¤ªç½‘ CRCã€‚</li><li>è°ƒç”¨ <code>e1000_rx_checksum()</code> åšç¡¬ä»¶æ ¡éªŒå’Œ offloadã€‚</li><li>è°ƒç”¨ <code>e1000_receive_skb()</code> æŠŠæŠ¥æ–‡äº¤ç»™ Linux ç½‘ç»œåè®®æ ˆï¼ˆä»è¿™ä¸€åˆ»å¼€å§‹ï¼Œæ•°æ®åŒ…å°±è¿›å…¥äº† TCP/IP æ ˆï¼‰ã€‚</li></ul><p><strong>å›æ”¶å’Œè¡¥å…… buffer</strong></p><ul><li>æ¸…ç©º <code>rx_desc->status</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªæè¿°ç¬¦å¯ä»¥å†æ¬¡è¢«ç½‘å¡ä½¿ç”¨ã€‚</li><li>å®šæœŸè°ƒç”¨ <code>alloc_rx_buf()</code> ç»™ç½‘å¡è¡¥å……æ–°çš„ç©º bufferï¼Œé¿å… ring buffer è¢«è€—å°½ã€‚</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * e1000_clean_rx_irq - Send received data up the network stack; legacy
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @adapter: board private structure
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @rx_ring: ring to clean
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @work_done: amount of napi work completed this call
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @work_to_do: max amount of work allowed for this call to do
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>e1000_clean_rx_irq</span>(<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter,
</span></span><span style=display:flex><span>			       <span style=color:#66d9ef>struct</span> e1000_rx_ring <span style=color:#f92672>*</span>rx_ring,
</span></span><span style=display:flex><span>			       <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>work_done, <span style=color:#66d9ef>int</span> work_to_do)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> net_device <span style=color:#f92672>*</span>netdev <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>netdev;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> pci_dev <span style=color:#f92672>*</span>pdev <span style=color:#f92672>=</span> adapter<span style=color:#f92672>-&gt;</span>pdev;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_rx_desc <span style=color:#f92672>*</span>rx_desc, <span style=color:#f92672>*</span>next_rxd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> e1000_rx_buffer <span style=color:#f92672>*</span>buffer_info, <span style=color:#f92672>*</span>next_buffer;
</span></span><span style=display:flex><span>	u32 length;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> cleaned_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>bool</span> cleaned <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> total_rx_bytes<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, total_rx_packets<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	i <span style=color:#f92672>=</span> rx_ring<span style=color:#f92672>-&gt;</span>next_to_clean;
</span></span><span style=display:flex><span>	rx_desc <span style=color:#f92672>=</span> <span style=color:#a6e22e>E1000_RX_DESC</span>(<span style=color:#f92672>*</span>rx_ring, i);
</span></span><span style=display:flex><span>	buffer_info <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>rx_ring<span style=color:#f92672>-&gt;</span>buffer_info[i];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (rx_desc<span style=color:#f92672>-&gt;</span>status <span style=color:#f92672>&amp;</span> E1000_RXD_STAT_DD) {	<span style=color:#75715e>// æ£€æŸ¥DMAæ˜¯å¦å®Œæˆï¼ŒDD = Descriptor Done
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>struct</span> sk_buff <span style=color:#f92672>*</span>skb;
</span></span><span style=display:flex><span>		u8 <span style=color:#f92672>*</span>data;
</span></span><span style=display:flex><span>		u8 status;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>work_done <span style=color:#f92672>&gt;=</span> work_to_do)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		(<span style=color:#f92672>*</span>work_done)<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dma_rmb</span>(); <span style=color:#75715e>/* read descriptor and rx_buffer_info after status DD */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		status <span style=color:#f92672>=</span> rx_desc<span style=color:#f92672>-&gt;</span>status;
</span></span><span style=display:flex><span>		length <span style=color:#f92672>=</span> <span style=color:#a6e22e>le16_to_cpu</span>(rx_desc<span style=color:#f92672>-&gt;</span>length);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		data <span style=color:#f92672>=</span> buffer_info<span style=color:#f92672>-&gt;</span>rxbuf.data;		<span style=color:#75715e>// dataå°±æ˜¯çœŸæ­£çš„buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>prefetch</span>(data);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ„é€ skbï¼Œå¦‚æœæ˜¯å°åŒ…ï¼Œç›´æ¥æŠŠæ•°æ®åŒ…å†…ä»ä»bufferä¸­copyä¸€ä»½ï¼Œå¦åˆ™ç›´æ¥ä½¿ç”¨buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		skb <span style=color:#f92672>=</span> <span style=color:#a6e22e>e1000_copybreak</span>(adapter, buffer_info, length, data); <span style=color:#75715e>// ä¸ºå°åŒ…åˆ†é…skbï¼Œå¦‚æœæ˜¯å¤§åŒ…ï¼Œè¿”å›NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>skb) {	<span style=color:#75715e>// å¤„ç†å¤§åŒ…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> frag_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>e1000_frag_len</span>(adapter);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			skb <span style=color:#f92672>=</span> <span style=color:#a6e22e>build_skb</span>(data <span style=color:#f92672>-</span> E1000_HEADROOM, frag_len); <span style=color:#75715e>// ä¸ºå¤§åŒ…æ„é€ skb
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>process_skb:
</span></span><span style=display:flex><span>		total_rx_bytes <span style=color:#f92672>+=</span> (length <span style=color:#f92672>-</span> <span style=color:#ae81ff>4</span>); <span style=color:#75715e>/* don&#39;t count FCS */</span>
</span></span><span style=display:flex><span>		total_rx_packets<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(<span style=color:#f92672>!</span>(netdev<span style=color:#f92672>-&gt;</span>features <span style=color:#f92672>&amp;</span> NETIF_F_RXFCS)))
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* adjust length to remove Ethernet CRC, this must be
</span></span></span><span style=display:flex><span><span style=color:#75715e>			 * done after the TBI_ACCEPT workaround above
</span></span></span><span style=display:flex><span><span style=color:#75715e>			 */</span>
</span></span><span style=display:flex><span>			length <span style=color:#f92672>-=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è°ƒæ•´skb
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (buffer_info<span style=color:#f92672>-&gt;</span>rxbuf.data <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>skb_put</span>(skb, length);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span> <span style=color:#75715e>/* copybreak skb */</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>skb_trim</span>(skb, length);
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>/* Receive Checksum Offload */</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>e1000_rx_checksum</span>(adapter,
</span></span><span style=display:flex><span>				  (u32)(status) <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>				  ((u32)(rx_desc<span style=color:#f92672>-&gt;</span>errors) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>24</span>),
</span></span><span style=display:flex><span>				  <span style=color:#a6e22e>le16_to_cpu</span>(rx_desc<span style=color:#f92672>-&gt;</span>csum), skb);
</span></span><span style=display:flex><span>		<span style=color:#75715e>// äº¤ç»™e1000_receive_skbå¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>e1000_receive_skb</span>(adapter, status, rx_desc<span style=color:#f92672>-&gt;</span>special, skb);
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	adapter<span style=color:#f92672>-&gt;</span>total_rx_packets <span style=color:#f92672>+=</span> total_rx_packets;
</span></span><span style=display:flex><span>	adapter<span style=color:#f92672>-&gt;</span>total_rx_bytes <span style=color:#f92672>+=</span> total_rx_bytes;
</span></span><span style=display:flex><span>	netdev<span style=color:#f92672>-&gt;</span>stats.rx_bytes <span style=color:#f92672>+=</span> total_rx_bytes;
</span></span><span style=display:flex><span>	netdev<span style=color:#f92672>-&gt;</span>stats.rx_packets <span style=color:#f92672>+=</span> total_rx_packets;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> cleaned;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>e1000_receive_skb</code>æ ¹æ®åè®®ï¼ˆå¯¹äºe1000ç½‘å¡æ¥è¯´ï¼Œå°±æ˜¯ä»¥å¤ªç½‘åè®®ï¼‰è°ƒæ•´skbçš„ç›¸å…³å­—æ®µï¼ˆå¦‚mac_headerã€dataç­‰ï¼‰ï¼Œç„¶åå°†skbäº¤ç»™<code>napi_gro_receive</code>å¤„ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: drivers/net/ethernet/intel/e1000/e1000_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * e1000_receive_skb - helper function to handle rx indications
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @adapter: board private structure
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @status: descriptor status field as written by hardware
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @vlan: descriptor vlan field as written by hardware (no le/be conversion)
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @skb: pointer to sk_buff to be indicated to stack
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>e1000_receive_skb</span>(<span style=color:#66d9ef>struct</span> e1000_adapter <span style=color:#f92672>*</span>adapter, u8 status,
</span></span><span style=display:flex><span>			      __le16 vlan, <span style=color:#66d9ef>struct</span> sk_buff <span style=color:#f92672>*</span>skb)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	skb<span style=color:#f92672>-&gt;</span>protocol <span style=color:#f92672>=</span> <span style=color:#a6e22e>eth_type_trans</span>(skb, adapter<span style=color:#f92672>-&gt;</span>netdev);	<span style=color:#75715e>// è°ƒæ•´skbçš„mac_headerï¼Œæ ¹æ®L2 headeråˆ¤æ–­åè®®ç±»å‹ï¼Œå¹¶å°†skb-&gt;dataæŒ‡å‘ä¸‹ä¸€å±‚åè®®å¤´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (status <span style=color:#f92672>&amp;</span> E1000_RXD_STAT_VP) {
</span></span><span style=display:flex><span>		u16 vid <span style=color:#f92672>=</span> <span style=color:#a6e22e>le16_to_cpu</span>(vlan) <span style=color:#f92672>&amp;</span> E1000_RXD_SPC_VLAN_MASK;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>__vlan_hwaccel_put_tag</span>(skb, <span style=color:#a6e22e>htons</span>(ETH_P_8021Q), vid);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>napi_gro_receive</span>(<span style=color:#f92672>&amp;</span>adapter<span style=color:#f92672>-&gt;</span>napi, skb);	<span style=color:#75715e>// äº¤ç»™ä¸Šå±‚åè®®æ ˆå¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><code>napi_gro_receive</code>æ˜¯Linuxå†…æ ¸<strong>GRO</strong>ï¼ˆGeneric Receive Offloadï¼‰æ¥æ”¶è·¯å¾„çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ç°äº†å¯¹æ¥æ”¶åˆ°çš„skbè¿›è¡Œèšåˆå¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬ä¸å…³å¿ƒå…·ä½“çš„èšåˆæ“ä½œç»†èŠ‚ï¼ˆåªéœ€è¦çŸ¥é“<code>dev_gro_receive</code>ä¼šç»™<code>napi_skb_finish</code>è¿”å›èšåˆçš„ç»“æœå³å¯ï¼‰ï¼Œç›´æ¥çœ‹<code>napi_skb_finish</code>æ˜¯å¦‚ä½•å¤„ç†skbçš„ã€‚<code>napi_skb_finish</code>æ ¹æ®èšåˆç»“æœåˆ¤æ–­æ˜¯å¦ç»§ç»­å¤„ç†skbï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šå°†skbäº¤ç»™å…¶ä»–å‡½æ•°å¤„ç†ï¼Œæœ€ç»ˆskbä¼šè¢«<code>__netif_receive_skb_core</code>å¤„ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: net/core/dev.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>gro_result_t</span> <span style=color:#a6e22e>napi_gro_receive</span>(<span style=color:#66d9ef>struct</span> napi_struct <span style=color:#f92672>*</span>napi, <span style=color:#66d9ef>struct</span> sk_buff <span style=color:#f92672>*</span>skb)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>trace_napi_gro_receive_entry</span>(skb);	<span style=color:#75715e>// è¿½è¸ªè°ƒè¯•å…¥å£ï¼Œå¯ç”¨äºftraceç­‰è·Ÿè¸ªå·¥å…·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>skb_gro_reset_offset</span>(skb);			<span style=color:#75715e>// é‡ç½® skb çš„ GRO çŠ¶æ€ï¼Œè®© skb å¯ä»¥å‚ä¸èšåˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è°ƒç”¨ dev_gro_receive å°† skb äº¤ç»™è®¾å¤‡å±‚çš„ GROï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// dev_gro_receive ä¼šå°è¯•å°†å¤šä¸ªå°åŒ…èšåˆæˆå¤§åŒ…ï¼Œæé«˜å¤„ç†æ•ˆç‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// napi_skb_finish æ ¹æ® dev_gro_receive çš„è¿”å›ç»“æœåšåç»­å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>napi_skb_finish</span>(<span style=color:#a6e22e>dev_gro_receive</span>(napi, skb), skb);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>EXPORT_SYMBOL</span>(napi_gro_receive);
</span></span></code></pre></div><p><code>__netif_receive_skb_core</code>æ¯”è¾ƒé•¿ï¼Œä»¥ä¸‹æ˜¯ä¿ç•™äº†skbåˆ†å‘é€»è¾‘çš„ç®€åŒ–ç‰ˆæœ¬ã€‚ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>å…ˆåˆ†å‘ç»™å…¨å±€é“¾è¡¨ <code>ptype_all</code>ï¼ˆtcpdump ç­‰ç›‘å¬å·¥å…·ä¼šåœ¨è¿™é‡Œæ”¶åˆ°æ•°æ®åŒ…ï¼‰ã€‚</p></li><li><p>å†åˆ†å‘ç»™ç½‘å¡ä¸“å±é“¾è¡¨ <code>dev->ptype_all</code>ï¼ˆç½‘å¡åŠŸèƒ½ç›¸å…³ï¼‰ã€‚</p></li><li><p>è°ƒç”¨ç½‘å¡ <code>rx_handler</code>ï¼ˆé©±åŠ¨è‡ªå®šä¹‰çš„æ¥æ”¶å›è°ƒï¼‰ã€‚</p></li><li><p>æ ¹æ®åè®®ç±»å‹åˆ†å‘ç»™ IPv4/IPv6/ARPç­‰å¤„ç†ã€‚</p></li><li><p>æœ€åè°ƒç”¨æœ€åä¸€ä¸ª packet_type çš„å¤„ç†å‡½æ•°æˆ–ä¸¢å¼ƒã€‚</p></li></ol><p>å¯¹äºIPæ•°æ®åŒ…ï¼Œå°±ä¼šåˆ†å‘ç»™<code>ip_rcv</code>å‡½æ•°å¤„ç†ã€‚è‡³æ­¤ç½‘ç»œæ•°æ®åŒ…å°±ä»ç½‘å¡åˆ°è¾¾åˆ°äº†ç½‘ç»œåè®®æ ˆçš„å…¥å£ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: net/core/dev.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>__netif_receive_skb_core</span>(<span style=color:#66d9ef>struct</span> sk_buff <span style=color:#f92672>*</span>skb)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> packet_type <span style=color:#f92672>*</span>ptype, <span style=color:#f92672>*</span>pt_prev;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>rx_handler_func_t</span> <span style=color:#f92672>*</span>rx_handler;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> net_device <span style=color:#f92672>*</span>orig_dev;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> NET_RX_DROP;
</span></span><span style=display:flex><span>    __be16 type;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    orig_dev <span style=color:#f92672>=</span> skb<span style=color:#f92672>-&gt;</span>dev;
</span></span><span style=display:flex><span>    pt_prev <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. åˆ†å‘ç»™å…¨å±€ packet_type é“¾è¡¨ï¼ˆæ‰€æœ‰ç½‘å¡å…±äº«ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>list_for_each_entry_rcu</span>(ptype, <span style=color:#f92672>&amp;</span>ptype_all, list) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pt_prev)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>deliver_skb</span>(skb, pt_prev, orig_dev);
</span></span><span style=display:flex><span>        pt_prev <span style=color:#f92672>=</span> ptype;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. åˆ†å‘ç»™å½“å‰ç½‘å¡ä¸“å± packet_type é“¾è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>list_for_each_entry_rcu</span>(ptype, <span style=color:#f92672>&amp;</span>skb<span style=color:#f92672>-&gt;</span>dev<span style=color:#f92672>-&gt;</span>ptype_all, list) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pt_prev)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>deliver_skb</span>(skb, pt_prev, orig_dev);
</span></span><span style=display:flex><span>        pt_prev <span style=color:#f92672>=</span> ptype;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. è°ƒç”¨ç½‘å¡é©±åŠ¨å¯èƒ½è®¾ç½®çš„ rx_handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rx_handler <span style=color:#f92672>=</span> <span style=color:#a6e22e>rcu_dereference</span>(skb<span style=color:#f92672>-&gt;</span>dev<span style=color:#f92672>-&gt;</span>rx_handler);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (rx_handler) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pt_prev) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>deliver_skb</span>(skb, pt_prev, orig_dev);
</span></span><span style=display:flex><span>            pt_prev <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>rx_handler</span>(<span style=color:#f92672>&amp;</span>skb)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> RX_HANDLER_CONSUMED:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> NET_RX_SUCCESS;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> RX_HANDLER_ANOTHER:
</span></span><span style=display:flex><span>            <span style=color:#75715e>// skb è¢«é‡å®šå‘ï¼Œéœ€è¦å†æ¬¡åˆ†å‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            pt_prev <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> RX_HANDLER_EXACT:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> RX_HANDLER_PASS:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. æŒ‰åè®®ç±»å‹åˆ†å‘ç»™å¯¹åº”é“¾è¡¨ï¼ˆIPv4/IPv6/ARPï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    type <span style=color:#f92672>=</span> skb<span style=color:#f92672>-&gt;</span>protocol;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>deliver_ptype_list_skb</span>(skb, <span style=color:#f92672>&amp;</span>pt_prev, orig_dev, type,
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&amp;</span>ptype_base[<span style=color:#a6e22e>ntohs</span>(type) <span style=color:#f92672>&amp;</span> PTYPE_HASH_MASK]);	<span style=color:#75715e>// å¯¹äºTCP/UDPï¼Œå°±æ˜¯åœ¨è¿™é‡Œåˆ†å‘ç»™IPv4å¤„ç†çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>deliver_ptype_list_skb</span>(skb, <span style=color:#f92672>&amp;</span>pt_prev, orig_dev, type,
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&amp;</span>orig_dev<span style=color:#f92672>-&gt;</span>ptype_specific);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. æœ€ç»ˆè°ƒç”¨æœ€åä¸€ä¸ª packet_type çš„å¤„ç†å‡½æ•°ï¼Œæˆ–è€…ä¸¢å¼ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (pt_prev)
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> pt_prev<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>func</span>(skb, skb<span style=color:#f92672>-&gt;</span>dev, pt_prev, orig_dev);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kfree_skb</span>(skb);
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> NET_RX_DROP;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œæ’æ’­ä¸€æ®µå†…å®¹ï¼štcpdumpçš„æŠ“åŒ…çš„å®ç°åŸç†å…¶å®å°±æ˜¯åˆ›å»º<code>PF_PACKET</code>ç±»å‹çš„socketå¹¶æ·»åŠ åˆ°<code>ptype_all</code>æˆ–è€…<code>dev->ptype_all</code>ï¼Œè€Œæ¯ä¸€ä¸ªæ•°æ®åŒ…éƒ½ä¼šç»å†å‰é¢çš„1ã€2ä¸¤ä¸ªåˆ†å‘è¿‡ç¨‹ã€‚å¯ä»¥çœ‹åˆ°tcpdumpçš„æŠ“åŒ…ä½ç½®åœ¨æ•°æ®åŒ…å¤„ç†çš„æ—©æœŸï¼ˆå…¥å‘æµé‡ï¼‰ï¼Œæ‰€ä»¥å³ä½¿æ•°æ®åŒ…ä¼šè¢«ä¸¢å¼ƒï¼Œtcpdumpä¹Ÿèƒ½æŠ“åˆ°å®Œæ•´çš„æ•°æ®åŒ…ã€‚</p><p>å¦‚ä½•ç¡®å®šæŠŠæ•°æ®åŒ…åˆ†å‘ç»™è°å¤„ç†å‘¢ï¼Ÿå¯¹äºIPv4æ•°æ®åŒ…è€Œè¨€ï¼Œe1000ç½‘å¡åœ¨å°†skbäº¤ç»™<code>napi_gro_receive</code>å‰ï¼Œä¼šè®¾ç½®<code>skb->protocol</code>ï¼Œ<code>__netif_receive_skb_core</code>åœ¨åˆ†å‘çš„æ—¶å€™ä¼šåœ¨ptype_baseä¸­æŸ¥æ‰¾åŒ¹é…çš„å¤„ç†å‡½æ•°ï¼Œå¯¹äºIPv4è€Œè¨€ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šå°†<code>ip_packet_type</code>æ·»åŠ åˆ°<code>ptype_base</code>ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// file: net/ipv4/af_inet.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> packet_type ip_packet_type __read_mostly <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	.type <span style=color:#f92672>=</span> <span style=color:#a6e22e>cpu_to_be16</span>(ETH_P_IP),
</span></span><span style=display:flex><span>	.func <span style=color:#f92672>=</span> ip_rcv,		<span style=color:#75715e>// å¤„ç†IPæ•°æ®åŒ…çš„å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>inet_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dev_add_pack</span>(<span style=color:#f92672>&amp;</span>ip_packet_type);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h1 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h1><p>ç»è¿‡ä¸€é€šåˆ†æï¼Œç»ˆäºæŠŠæ•°æ®åŒ…ä»ç½‘å¡é€åˆ°äº†å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œè¿˜æ„å¤–çš„å‘ç°äº†tcpdumpæŠ“åŒ…çš„ä½ç½®ï¼ˆå…¥å‘åŒ…ï¼‰ï¼ŒçœŸä¸å®¹æ˜“ã€‚å›è¿‡å¤´æ¥å†çœ‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>æ•°æ®åŒ…è¾¾åˆ°ç½‘å¡ï¼›</li><li>ç½‘å¡é€šè¿‡DMAå°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼›</li><li>ç½‘å¡é€šè¿‡IRQå‘Šè¯‰CPUæœ‰æ–°çš„ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ï¼›</li><li>CPUå¿«é€Ÿå“åº”ç½‘å¡çš„IRQè¯·æ±‚ï¼Œç®€å•è°ƒç”¨<code>__napi_schedule()</code>ï¼ŒæŠŠNAPI pollåŠ å…¥è°ƒåº¦é˜Ÿåˆ—ï¼›</li><li>è½¯ä¸­æ–­è°ƒåº¦NAPI pollï¼Œæœ€ç»ˆè°ƒç”¨e1000ç½‘å¡çš„pollå‡½æ•°ï¼ˆ<code>e1000_clean</code>ï¼‰ï¼›</li><li>ç½‘å¡çš„pollå‡½è¯»å–DMA ringæè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿›sk_buffç»“æ„ä½“ï¼ˆå³skbï¼‰ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿï¼›</li><li>å†…æ ¸ç½‘ç»œå­ç³»ç»ŸæŒ‰ç…§åè®®ç±»å‹å°†skbåˆ†å‘ç»™å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¯¹äºIPæ•°æ®åŒ…è€Œè¨€ï¼Œå¤„ç†å‡½æ•°å°±æ˜¯<code>ip_rcv</code>ï¼›</li></ol><p>åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°äº†åœ¨åˆ†å‘skbæ—¶ä¼šéå†ptype_allï¼Œå¦‚æœä½¿ç”¨tcpdumpæŠ“åŒ…ï¼Œtcpdumpåˆ›å»ºçš„socketå°±ä¼šè¢«æ·»åŠ åˆ°ptype_allä¸­ï¼Œæ‰€ä»¥å°±èƒ½æŠ“åˆ°L2~L7çš„å®Œæ•´æ•°æ®åŒ…ã€‚</p><p>ip_rcvå¦‚ä½•å¤„ç†æ•°æ®åŒ…çš„å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°è·¯ç”±ä»¥åŠåˆ†å‘ç»™L4å±‚å¤„ç†ï¼ˆå¦‚TCP/UDPï¼‰ã€‚è¿™å—å†…å®¹ç•™åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://rand0m42195.github.io/tags/networking/>Networking</a></li><li><a href=https://rand0m42195.github.io/tags/linux/>Linux</a></li><li><a href=https://rand0m42195.github.io/tags/c/>C</a></li></ul><nav class=paginav><a class=next href=https://rand0m42195.github.io/posts/first-blog/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>First Blog</span></a></nav></footer><div id=comments><script src=https://giscus.app/client.js data-repo=rand0m42195/rand0m42195.github.io data-repo-id=R_kgDOPzDcOw data-category=Announcements data-category-id=DIC_kwDOPzDcO84CvpUm data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://rand0m42195.github.io/>rand0m's blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>