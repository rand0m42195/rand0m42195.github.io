<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>C on rand0m's blog</title><link>https://rand0m42195.github.io/tags/c/</link><description>Recent content in C on rand0m's blog</description><generator>Hugo -- 0.152.2</generator><language>zh</language><lastBuildDate>Thu, 27 Nov 2025 19:16:56 +0800</lastBuildDate><atom:link href="https://rand0m42195.github.io/tags/c/index.xml" rel="self" type="application/rss+xml"/><item><title>ä½¿ç”¨eBPFè§‚æµ‹Goç¨‹åºçš„goroutineçŠ¶æ€å˜åŒ–</title><link>https://rand0m42195.github.io/posts/ebpf-uprobe/</link><pubDate>Thu, 27 Nov 2025 19:16:56 +0800</pubDate><guid>https://rand0m42195.github.io/posts/ebpf-uprobe/</guid><description>&lt;p&gt;&lt;a href="https://ebpf.io/"&gt;eBPF&lt;/a&gt;å·ç§°èƒ½åŠ¨æ€åœ°å¯¹å†…æ ¸è¿›è¡Œç¼–ç¨‹ï¼Œå¯ä»¥å®ç°é«˜æ•ˆçš„ç½‘ç»œå¤„ç†ã€è§‚æµ‹ã€è¿½è¸ªå’Œå®‰å…¨åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Dynamically program the kernel for efficient networking, observability, tracing, and security&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™ç¯‡åšå®¢å°±æ¥ä½“éªŒä¸€ä¸‹ç”¨eBPFè§‚æµ‹Goçš„goroutineè°ƒåº¦ï¼Œä¼šæ¶‰åŠåˆ°uprobeåŸç†ã€eBPFå¼€å‘æ¡†æ¶é€‰æ‹©ã€eBPFç¨‹åºçš„ç¼–å†™ã€ç”¨æˆ·æ€ç¨‹åºåŠ è½½eBPFç¨‹åºä»¥åŠç”¨æˆ·æ€ç¨‹åºå’ŒeBPFç¨‹åºé€šè¿‡mapäº¤äº’ç­‰å†…å®¹ã€‚&lt;/p&gt;
&lt;h2 id="uprobeåŸç†"&gt;uprobeåŸç†&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;uprobe&lt;/code&gt;ï¼ˆuser-space probeï¼‰æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨æ¥åœ¨ ç”¨æˆ·æ€ç¨‹åºçš„ç‰¹å®šæŒ‡ä»¤å¤„ æ’å…¥åŠ¨æ€æ¢é’ˆï¼ˆprobeï¼‰ã€‚&lt;code&gt;uprobe&lt;/code&gt; é€šè¿‡åœ¨ç”¨æˆ·æ€ç¨‹åºä»£ç æ®µæŒ‡å®šä½ç½®å†™å…¥ä¸€ä¸ª 1 å­—èŠ‚çš„æ–­ç‚¹æŒ‡ä»¤ï¼ˆINT3, 0xCCï¼‰ï¼Œè§¦å‘å†…æ ¸é™·å…¥ï¼ˆtrapï¼‰è¿›å…¥ uprobe handlerï¼Œå†è¿è¡Œhookçš„ä»£ç ã€‚ç”±äºeBPFå…·æœ‰å¾ˆå¥½çš„å®‰å…¨æ€§ï¼Œæ‰€ä»¥å¯ä»¥ç”¨eBPFæ¥ç¼–å†™hookä»£ç ï¼Œä¿è¯å®‰å…¨ã€‚&lt;/p&gt;
&lt;h2 id="ebpfå¼€å‘æ¡†æ¶é€‰æ‹©"&gt;eBPFå¼€å‘æ¡†æ¶é€‰æ‹©&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘å‡ å¹´eBPFå‘å±•çš„éå¸¸è¿…é€Ÿï¼Œå‡ºç°äº†ä¼˜ç§€çš„å¼€æºeBPFå¼€å‘æ¡†æ¶ï¼Œä½¿å¾—eBPFçš„å¼€å‘éš¾åº¦å¤§å¤§é™ä½ã€‚ä¸‹é¢é€‰å–ä¸€äº›æˆ‘çŸ¥é“çš„eBPFå¼€å‘æ¡†æ¶åšä»‹ç»ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;é¡¹ç›®&lt;/th&gt;
&lt;th&gt;ç‰¹ç‚¹&lt;/th&gt;
&lt;th&gt;è¯­è¨€&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="https://github.com/iovisor/bcc"&gt;bcc&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;eBPFå¼€å‘å·¥å…·ç®±ï¼Œé€‚åˆæ•™å­¦&amp;amp;è¿ç»´ï¼Œä¾èµ–LLVMï¼Œè¾ƒé‡ã€‚&lt;/td&gt;
&lt;td&gt;Cã€Python&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="https://github.com/libbpf/libbpf-bootstrap/tree/master?tab=readme-ov-file"&gt;libbpf-bootstrap&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;ç”¨Cå¼€å‘eBPFçš„æ¨¡ç‰ˆ/æ¡†æ¶ï¼Œå®˜æ–¹æ¨èã€‚&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="https://github.com/libbpf/libbpf-bootstrap/tree/master?tab=readme-ov-file"&gt;cilium/ebpf&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;ç”¨Goå¼€å‘eBPFçš„é¦–é€‰ï¼Œeiliumå¼€æºï¼Œèƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæ— LLVMä¾èµ–&lt;/td&gt;
&lt;td&gt;Cã€Go&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="https://github.com/bpftrace/bpftrace"&gt;bpftrace&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;ç”¨ç±»ä¼¼awkçš„è„šæœ¬è¯­è¨€å¼€å‘eBPFï¼Œé€‚åˆå¿«é€Ÿè°ƒè¯•ã€éªŒè¯ã€‚&lt;/td&gt;
&lt;td&gt;ä¸“ç”¨è¯­æ³•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href="https://github.com/eunomia-bpf/eunomia-bpf"&gt;eunomia-bpf&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;é¢å‘äº‘åŸç”Ÿçš„eBPF WASMåŒ–&lt;/td&gt;
&lt;td&gt;Rust&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ç»è¿‡å¯¹æ¯”æœ€ç»ˆé€‰æ‹©äº†ä½¿ç”¨cilium/ebpfæ¥å®ç°è§‚æµ‹goroutineçŠ¶æ€å˜åŒ–ï¼ŒåŸå› æœ‰ï¼šbccæ˜¯ä¸€ä¸ªå¾ˆé‡çš„é¡¹ç›®ï¼Œæœ‰å¾ˆå¤šä¾èµ–ç¯å¢ƒã€‚libbpf-bootstrapå¼€å‘ç”¨æˆ·æ€ç¨‹åºç›¸å¯¹éº»çƒ¦ä¸€äº›ã€‚ä½¿ç”¨bpftraceå¼€å‘éœ€è¦äº†è§£ä»–çš„è„šæœ¬è¯­è¨€çš„è¯­æ³•ï¼ˆå¹¶ä¸æ˜¯é€šç”¨çš„è„šæœ¬è¯­è¨€ï¼‰ï¼Œæœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬ï¼Œè€Œä¸”å¼€å‘å¤æ‚çš„eBPFç¨‹åºä¹Ÿä¸å¤ªçµæ´»ã€‚eunomia-bpfè¿˜æ²¡ä»”ç»†ç ”ç©¶è¿‡ï¼Œä»¥åä¼šå°è¯•ã€‚ç»è¿‡å¯¹æ¯”ï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº†å¯¹æˆ‘æ¥è¯´æœ€ç®€å•çš„cilium/ebpfï¼Œè€Œä¸”è¿™ä¸ªé¡¹ç›®é‡Œæœ‰ç°æˆçš„&lt;a href="https://github.com/cilium/ebpf/tree/main/examples"&gt;examples&lt;/a&gt;ï¼Œå¯ä»¥ç…§çŒ«ç”»è™ï¼Œå¾ˆå¿«å°±èƒ½å®ç°ä¸€ä¸ªç®€å•uprobeåŠŸèƒ½ã€‚&lt;/p&gt;
&lt;h2 id="ç”¨ebpfè§‚æµ‹goroutineçŠ¶æ€å˜åŒ–"&gt;ç”¨eBPFè§‚æµ‹goroutineçŠ¶æ€å˜åŒ–&lt;/h2&gt;
&lt;h3 id="ebpfç¨‹åº"&gt;eBPFç¨‹åº&lt;/h3&gt;
&lt;p&gt;Goæ”¯æŒé«˜å¹¶å‘çš„åˆ©å™¨å°±æ˜¯goroutineï¼Œè€Œgoroutineä¹‹æ‰€ä»¥èƒ½è½»è€Œæ˜“ä¸¾çš„å®ç°ä¸Šä¸‡çš„å¹¶å‘ï¼Œè¦å½’åŠŸäºGoçš„è°ƒåº¦ç­–ç•¥ï¼ŒGoä½¿ç”¨GMPè°ƒåº¦æ¨¡å‹ã€‚æ ¸å¿ƒå°±æ˜¯åœ¨ç”¨æˆ·æ€å®ç°è°ƒåº¦é€»è¾‘ï¼Œé¿å…ç³»ç»Ÿçº§çº¿ç¨‹è°ƒåº¦æ—¶ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢å¼€é”€ã€‚&lt;/p&gt;
&lt;p&gt;Goçš„è°ƒåº¦é€»è¾‘åœ¨æºç çš„src/runtime/proc.goä¸­ï¼Œå½“scheduleråˆ‡æ¢goroutineçŠ¶æ€æ—¶ä¼šè°ƒç”¨&lt;code&gt;runtime.casgstatus&lt;/code&gt;ï¼Œruntime.casgstatusçš„åŸå‹å¦‚ä¸‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼šæ£€æŸ¥å½“å‰goroutineçš„çŠ¶æ€æ˜¯å¦oldï¼Œå¦‚æœæ˜¯å°±æŠŠçŠ¶æ€åŸå­çš„æ›´æ–°ä¸ºnewï¼Œå¦‚æœä¸æ˜¯ï¼Œä¸åšæ›´æ–°ã€‚&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-Go" data-lang="Go"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kd"&gt;func&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nf"&gt;casgstatus&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;gp&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="nx"&gt;g&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;oldval&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;newval&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;uint32&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¦è§‚æµ‹goroutineçš„çŠ¶æ€åˆ‡æ¢ï¼Œåªéœ€è¦æŠŠeBPFå‡½æ•°hookåˆ°è¿™ä¸ªå‡½æ•°çš„å…¥å£å¤„ï¼Œæ‹¿åˆ°è¿™ä¸‰ä¸ªå‚æ•°å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæŠŠ&lt;a href="https://github.com/cilium/ebpf"&gt;cilium/ebpf&lt;/a&gt;æ‹‰åˆ°æœ¬åœ°ï¼Œè¿›å…¥examplesç›®å½•ï¼Œåœ¨åˆ›å»ºä¸€ä¸ªuprobe_schedç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ªuprobe_sched.cæ–‡ä»¶ã€‚&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$ &lt;span class="nb"&gt;cd&lt;/span&gt; ebpf/examples
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$ mkdir uprobe_sched
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$ &lt;span class="nb"&gt;cd&lt;/span&gt; uprobe_sched
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;$ touch uprobe_sched.c
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç„¶åå‚è€ƒéš”å£çš„&lt;a href="https://github.com/cilium/ebpf/blob/main/examples/uretprobe/uretprobe.c"&gt;examples/uretprobe/uretprobe.c&lt;/a&gt;ï¼Œç¼–å†™eBPFç¨‹åºï¼Œä¸»è¦é€»è¾‘å°±æ˜¯ï¼Œè·å–ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘gç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯oldï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯newã€‚å…¶ä¸­goidåœ¨gç»“æ„ä½“åç§»0xA0ï¼ˆè¿™ä¸ªåç§»å’ŒGoçš„ç‰ˆæœ¬ç›¸å…³ï¼Œå…·ä½“è®¡ç®—æ–¹æ³•åé¢ä»‹ç»ï¼‰ï¼Œéœ€è¦å€ŸåŠ©&lt;code&gt;bpf_probe_read_user&lt;/code&gt;å‡½æ•°è¯»å–ï¼Œè¯»åˆ°goidä¹‹åå°†data_tç»“æ„ä½“å†™å…¥mapä¸­ã€‚&lt;/p&gt;</description></item><item><title>XDP æŒ‚è½½æ¨¡å¼å‰–æ</title><link>https://rand0m42195.github.io/posts/linux-ebpf-xdp-models/</link><pubDate>Thu, 25 Sep 2025 11:12:40 +0800</pubDate><guid>https://rand0m42195.github.io/posts/linux-ebpf-xdp-models/</guid><description>&lt;h2 id="xdpæŒ‚è½½æ¨¡å¼å¯¹æ¯”"&gt;XDPæŒ‚è½½æ¨¡å¼å¯¹æ¯”&lt;/h2&gt;
&lt;p&gt;äº†è§£&lt;code&gt;XDP&lt;/code&gt;çš„è¯»è€…åº”è¯¥çŸ¥é“ï¼š&lt;code&gt;XDP&lt;/code&gt;æ˜¯åŸºäº&lt;code&gt;eBPF&lt;/code&gt;çš„ä¸€ä¸ªé«˜æ€§èƒ½ç½‘ç»œè·¯å¾„æŠ€æœ¯ï¼Œå®ƒçš„åŸç†å°±æ˜¯åœ¨æ•°æ®åŒ…å¤„ç†çš„æ—©æœŸé˜¶æ®µï¼ˆåœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¹‹å‰ï¼‰æŒ‚è½½&lt;code&gt;eBPF&lt;/code&gt;ç¨‹åºå¯¹æ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„ç½‘ç»œæ•°æ®åŒ…å¤„ç†ã€‚å¦‚æœä½ å†™è¿‡&lt;code&gt;XDP&lt;/code&gt;ç¨‹åºï¼Œé‚£ä¹ˆä¸€å®šçŸ¥é“æŒ‚è½½&lt;code&gt;XDP&lt;/code&gt;çš„æ—¶å€™æœ‰å¤šç§æ¨¡å¼å¯é€‰ï¼Œä¸åŒæ¨¡å¼ä¹‹é—´çš„æ•ˆç‡ä¸åŒã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±æ¥æ·±å…¥å‰–æä¸€ä¸‹&lt;code&gt;XDP&lt;/code&gt;çš„é›†ä¸­æ¨¡å¼ä¹‹é—´åˆ°åº•æœ‰å“ªäº›åŒºåˆ«ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆçœ‹çœ‹&lt;code&gt;XDP&lt;/code&gt;æŒ‚è½½æ¨¡å¼æœ‰å“ªå‡ ç§ï¼Ÿä¸åŒçš„æŒ‚è½½æ¨¡å¼æœ‰å’ŒåŒºåˆ«ï¼Ÿ&lt;/p&gt;
&lt;p&gt;&lt;code&gt;XDP&lt;/code&gt;æŒ‚è½½æ¨¡å¼å¯ä»¥ä»¥ä¸‰ç§æ–¹å¼æŒ‚åœ¨åˆ°ç½‘å¡ä¸Šï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;Generic&lt;/th&gt;
&lt;th&gt;Native&lt;/th&gt;
&lt;th&gt;Offloaded&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å…¼å®¹æ€§&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å…¼å®¹æ‰€æœ‰ç½‘ç»œè®¾å¤‡&lt;/td&gt;
&lt;td&gt;éœ€è¦ç½‘å¡é©±åŠ¨æ˜¾ç¤ºæ”¯æŒXDP&lt;/td&gt;
&lt;td&gt;ç‰¹å®šçš„å¯ç¼–ç¨‹ç½‘å¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ‰§è¡Œé˜¶æ®µ&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨ç½‘ç»œæ ¸å¿ƒä»£ç ä¸­æ‰§è¡Œï¼ˆæ­¤æ—¶å·²ç»åˆ†é…äº†SKBï¼‰&lt;/td&gt;
&lt;td&gt;åœ¨ç½‘å¡é©±åŠ¨ä¸­æ‰§è¡Œï¼ˆè¿˜æœªåˆ†é…SKBï¼‰&lt;/td&gt;
&lt;td&gt;ç½‘å¡æ‰§è¡Œï¼ŒCPUé›¶å¼€é”€&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ€§èƒ½&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è¾ƒä½&lt;/td&gt;
&lt;td&gt;é«˜&lt;/td&gt;
&lt;td&gt;æœ€é«˜&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id="xdp-æŒ‚è½½åŸç†"&gt;XDP æŒ‚è½½åŸç†&lt;/h2&gt;
&lt;p&gt;XDPç¨‹åºæ˜¯æŒ‚è½½åœ¨ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†è·¯å¾„ä¸Šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦å…ˆå¯¹ç½‘ç»œæ•°æ®åŒ…çš„å¤„ç†è·¯å¾„æœ‰ä¸€ä¸ªæ•´ä½“çš„æŒæ¡ï¼ˆè¿™é‡Œæ’æ’­ä¸€æ¡å°å¹¿å‘Šï¼Œæˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡åˆ†æ&lt;a href="https://rand0m42195.github.io/posts/linux-networking-receive/"&gt;æ•°æ®åŒ…ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆ&lt;/a&gt;çš„åšå®¢ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;æ•°æ®åŒ…ä»ç½‘å¡åˆ°å†…æ ¸ç½‘ç»œåè®®æ ˆçš„æµç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡&lt;/strong&gt; ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;DMA å†™å…¥å†…å­˜&lt;/strong&gt; ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¸­æ–­é€šçŸ¥ CPU&lt;/strong&gt; ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰&lt;/strong&gt; é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ &lt;code&gt;__napi_schedule()&lt;/code&gt;ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è½¯ä¸­æ–­è°ƒåº¦ NAPI poll&lt;/strong&gt; CPU æ‰§è¡Œ &lt;code&gt;do_softirq()&lt;/code&gt; â†’ &lt;code&gt;net_rx_action()&lt;/code&gt; â†’ è°ƒç”¨ ç½‘å¡çš„çš„ poll å‡½æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb&lt;/strong&gt; é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› &lt;code&gt;sk_buff&lt;/code&gt; ç»“æ„ï¼Œäº¤ç»™ç½‘ç»œæ ¸å¿ƒå±‚ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç½‘ç»œæ ¸å¿ƒå±‚å¤„ç†&lt;/strong&gt; ç½‘ç»œæ ¸å¿ƒå±‚æ ¹æ®æ•°æ®åŒ…æ ¼å¼é€‰æ‹©å¯¹åº”çš„åè®®æ ˆï¼Œç„¶åäº¤ç»™åè®®æ ˆå¤„ç†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;XDPå°±æ˜¯æŒ‚è½½åœ¨ä¸Šé¢çš„æŸä¸ªé˜¶æ®µï¼Œä»è€Œå®ç°é«˜æ•ˆç½‘ç»œæ•°æ®åŒ…å¤„ç†çš„ã€‚å…·ä½“æ¥è¯´&lt;em&gt;Native&lt;/em&gt;æ¨¡å¼çš„&lt;code&gt;XDP&lt;/code&gt;æ˜¯åœ¨ç½‘å¡çš„é©±åŠ¨ç¨‹åºä¸­æ‰§è¡Œçš„ï¼ˆå¯¹åº”æ­¥éª¤6ï¼‰ï¼Œè€ŒGenericæ¨¡å¼çš„XDPæ˜¯åœ¨ç½‘ç»œæ ¸å¿ƒå±‚ä¸­æ‰§è¡Œçš„ï¼ˆå¯¹åº”æ­¥éª¤7ï¼‰ã€‚è¿™ä¹Ÿè¯´æ˜äº†&lt;em&gt;Native&lt;/em&gt;æ¨¡å¼çš„æ€§èƒ½æ¯”&lt;em&gt;Generic&lt;/em&gt;æ¨¡å¼é«˜ã€‚&lt;/p&gt;</description></item><item><title>Linux ç½‘ç»œç¼–ç¨‹â€”â€”socket ç³»ç»Ÿè°ƒç”¨å®ç°å‰–æ</title><link>https://rand0m42195.github.io/posts/linux-networking-socket-syscall/</link><pubDate>Wed, 24 Sep 2025 15:06:05 +0800</pubDate><guid>https://rand0m42195.github.io/posts/linux-networking-socket-syscall/</guid><description>&lt;h1 id="linux-ä¸‹å¤šè¯­è¨€ç½‘ç»œç¼–ç¨‹å¯¹æ¯”"&gt;Linux ä¸‹å¤šè¯­è¨€ç½‘ç»œç¼–ç¨‹å¯¹æ¯”&lt;/h1&gt;
&lt;p&gt;è¿˜è®°å¾—Linuxç½‘ç»œç¼–ç¨‹å§¿åŠ¿å—ï¼Ÿå¦‚æœä¸è®°å¾—äº†ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç”¨Cè¯­è¨€å†™çš„&lt;code&gt;tcp_echo&lt;/code&gt;æœåŠ¡ï¼Œç”¨è¿™æ®µä»£ç èƒ½å¸®æˆ‘ä»¬å›å¿†Linuxçš„ç½‘ç»œç¼–ç¨‹å¥—è·¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è°ƒç”¨socketåˆ›å»ºä¸€ä¸ªç½‘ç»œå¥—æ¥å­—socketï¼›&lt;/li&gt;
&lt;li&gt;è°ƒç”¨bindç»™socketç»‘å®šåœ°å€ï¼›&lt;/li&gt;
&lt;li&gt;listenè®¾ç½®&lt;/li&gt;
&lt;li&gt;è°ƒç”¨acceptæ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-C" data-lang="C"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#include&lt;/span&gt; &lt;span class="cpf"&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;span class="cp"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#include&lt;/span&gt; &lt;span class="cpf"&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;span class="cp"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#include&lt;/span&gt; &lt;span class="cpf"&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;span class="cp"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#include&lt;/span&gt; &lt;span class="cpf"&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;span class="cp"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#include&lt;/span&gt; &lt;span class="cpf"&gt;&amp;lt;arpa/inet.h&amp;gt;&lt;/span&gt;&lt;span class="cp"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;#include&lt;/span&gt; &lt;span class="cpf"&gt;&amp;lt;sys/socket.h&amp;gt;&lt;/span&gt;&lt;span class="cp"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cp"&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;sd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nf"&gt;socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;AF_INET&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;SOCK_STREAM&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;sockaddr_in&lt;/span&gt; &lt;span class="n"&gt;addr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sin_family&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;AF_INET&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sin_port&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nf"&gt;htons&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;12345&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sin_addr&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;s_addr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;INADDR_ANY&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nf"&gt;bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;sockaddr&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;addr&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;sizeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;addr&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nf"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nf"&gt;accept&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;ssize_t&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nf"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;sizeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nf"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// æŠŠè¯»åˆ°çš„å†…å®¹å‘é€å›å»
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="c1"&gt;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sd&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœä½ ç”¨çš„æ˜¯Goã€Pythonã€Rustç­‰é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œå¯èƒ½ä¼šå¯¹è¿™æ®µä»£ç å—¤ä¹‹ä»¥é¼»ï¼Œè¿™ä¹ˆç®€å•ä¸€ä¸ªåŠŸèƒ½ï¼Œè¦åˆ›å»ºä¸€ä¸ªå¯ä»¥é€šä¿¡çš„TCPè¿æ¥å®Œå…¨ä¸å¿…è¿™ä¹ˆå¤æ‚ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯ç”¨&lt;code&gt;Go&lt;/code&gt;å†™çš„ï¼Œå¦‚æœä¸è€ƒè™‘é”™è¯¯å¤„ç†ï¼Œåªéœ€è¦è°ƒç”¨&lt;code&gt;Listen&lt;/code&gt;å’Œ&lt;code&gt;Accept&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-Go" data-lang="Go"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="kn"&gt;package&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;main&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#34;io&amp;#34;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#34;net&amp;#34;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;&lt;/span&gt;&lt;span class="kd"&gt;func&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;ln&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;net&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;Listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;tcp&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;#34;127.0.0.1:12345&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;nil&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;panic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;listen err&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;:=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;ln&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;Accept&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kc"&gt;nil&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;panic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;accept error&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;go&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;net&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Conn&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;defer&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;Close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;io&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;Copy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}(&lt;/span&gt;&lt;span class="nx"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½¿ç”¨&lt;code&gt;Rust&lt;/code&gt;æ ‡å‡†åº“&lt;code&gt;std::net&lt;/code&gt;çš„åŒæ­¥ç‰ˆæœ¬å¦‚ä¸‹ã€‚&lt;/p&gt;</description></item><item><title>ç½‘ç»œæ•°æ®åŒ…æ¥å—è¿‡ç¨‹åˆ†æâ€”â€”ä»ç½‘å¡åˆ°å†…æ ¸åè®®æ ˆï¼ˆä»¥Intel e1000 + Linux 4.4ä¸ºä¾‹ï¼‰</title><link>https://rand0m42195.github.io/posts/linux-networking-receive/</link><pubDate>Mon, 22 Sep 2025 20:43:51 +0800</pubDate><guid>https://rand0m42195.github.io/posts/linux-networking-receive/</guid><description>&lt;h1 id="å¼•è¨€"&gt;å¼•è¨€&lt;/h1&gt;
&lt;p&gt;ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºï¼Œéœ€è¦ç»å†ä¸€æ®µå¤æ‚çš„æ—…ç¨‹ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ &lt;code&gt;socket()&lt;/code&gt;ã€&lt;code&gt;recv()&lt;/code&gt; å°±èƒ½è½»æ¾æ‹¿åˆ°æ•°æ®ï¼Œå´å¾ˆå°‘æ€è€ƒå†…æ ¸èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç³»åˆ—æ–‡ç« å°è¯•ç»“åˆ &lt;strong&gt;ç†è®ºæµç¨‹ + å†…æ ¸æºç åˆ†æ&lt;/strong&gt;ï¼Œé€æ­¥å‰–æ Linux å†…æ ¸ä¸­ç½‘ç»œæ•°æ®åŒ…çš„æ¥æ”¶è¿‡ç¨‹ã€‚è¿™é‡Œé€‰æ‹© Linux 4.4 å†…æ ¸ä½œä¸ºä¾‹å­ï¼ˆä»£ç ç›¸å¯¹ç¨³å®šï¼Œèµ„æ–™ä¸°å¯Œï¼Œé€»è¾‘ä¸Šæ²¡æœ‰è¿‡å¤šæ–°ç‰¹æ€§å¹²æ‰°ï¼‰ï¼Œå¹¶ç»“åˆ Intel e1000 é©±åŠ¨æ¥å…·ä½“å±•ç¤ºæ•°æ®åŒ…æ˜¯å¦‚ä½•ä»ç½‘å¡åˆ°è¾¾å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ã€‚&lt;/p&gt;
&lt;h1 id="ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹"&gt;ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çš„æ€»ä½“æµç¨‹&lt;/h1&gt;
&lt;p&gt;å…ˆç»™å‡ºä¸€ä¸ªå…¨å±€è§†è§’ï¼šæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾å†…å­˜ï¼Œå†åˆ°åè®®æ ˆçš„è·¯å¾„ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡&lt;/strong&gt;
ç½‘å¡ç¡¬ä»¶æ¥æ”¶ä»¥å¤ªå¸§ï¼ŒåšåŸºæœ¬æ ¡éªŒï¼ˆå¦‚ CRCï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;DMA å†™å…¥å†…å­˜&lt;/strong&gt;
ç½‘å¡é€šè¿‡ DMA å°†æ•°æ®åŒ…å†™å…¥é©±åŠ¨é¢„å…ˆåˆ†é…å¥½çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆDescriptor Ringï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¸­æ–­é€šçŸ¥ CPU&lt;/strong&gt;
ç½‘å¡é€šè¿‡ IRQ å‘Šè¯‰ CPUï¼šâ€œæˆ‘æ”¶åˆ°äº†æ–°æ•°æ®åŒ…â€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é©±åŠ¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆISRï¼‰&lt;/strong&gt;
é©±åŠ¨å¿«é€Ÿå¤„ç†ä¸­æ–­ï¼Œé€šå¸¸åªæ˜¯è°ƒç”¨ &lt;code&gt;__napi_schedule()&lt;/code&gt;ï¼ŒæŠŠ NAPI poll åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è½¯ä¸­æ–­è°ƒåº¦ NAPI poll&lt;/strong&gt;
CPU æ‰§è¡Œ &lt;code&gt;do_softirq()&lt;/code&gt; â†’ &lt;code&gt;net_rx_action()&lt;/code&gt; â†’ è°ƒç”¨ e1000 çš„ poll å‡½æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;poll å‡½æ•°æå–æ•°æ®åŒ…å¹¶æ„é€  skb&lt;/strong&gt;
é©±åŠ¨åœ¨ poll ä¸­è¯»å– DMA ring çš„æè¿°ç¬¦ï¼ŒæŠŠæ•°æ®åŒ…å°è£…è¿› &lt;code&gt;sk_buff&lt;/code&gt; ç»“æ„ï¼Œäº¤ç»™å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç½‘ç»œæ ¸å¿ƒå±‚å¤„ç†&lt;/strong&gt;
skb è¢«é€åˆ°ç½‘ç»œæ ¸å¿ƒå±‚ï¼Œæ ¸å¿ƒå±‚é€šè¿‡æ•°æ®åŒ…çš„åè®®ç±»å‹é€‰æ‹©å¯¹åº”çš„ç½‘ç»œåè®®æ ˆï¼Œå¦‚IPåè®®æ ˆï¼Œè‡³æ­¤ç½‘ç»œæ•°æ®åŒ…ä»ç½‘å¡åˆ°è¾¾äº†Linuxå†…æ ¸çš„ç½‘ç»œåè®®æ ˆã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="ç½‘å¡æ”¶åŒ…æµç¨‹" loading="lazy" src="https://rand0m42195.github.io/images/posts/linux-networking-receive/nic-networking-stack.png"&gt;&lt;/p&gt;
&lt;p&gt;åœ¨å¼€å§‹å…·ä½“åˆ†æä¹‹å‰ï¼Œå…ˆè¯´ä»¥ä¸‹ç›¸å…³æºç çš„ä½ç½®ã€‚å’Œç½‘å¡ç›¸å…³çš„ä»£ç åœ¨é©±åŠ¨ç›®å½•ä¸‹ï¼ˆ&lt;code&gt;/drivers/net/ethernet&lt;/code&gt;ï¼‰ï¼Œç”±äºæˆ‘ä»¬åˆ†æçš„æ˜¯Intelçš„e1000ç½‘å¡ï¼Œæ‰€ä»¥å…·ä½“ä½ç½®å°±æ˜¯&lt;code&gt;/drivers/net/ethernet/intel/e1000&lt;/code&gt;ï¼Œå†…æ ¸ç½‘ç»œåè®®æ ˆä½äºç½‘ç»œå­ç³»ç»Ÿç›®å½•ä¸‹&lt;code&gt;/net&lt;/code&gt;ï¼Œä¸»è¦æ˜¯&lt;code&gt;/net/core/&lt;/code&gt;ç›®å½•ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†æIPv4ï¼Œæ‰€ä»¥è¿˜ä¼šæ¶‰åŠ&lt;code&gt;/net/ipv4/&lt;/code&gt;ä¸­çš„å°‘é‡ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥å°±ä»¥Intel e1000ç½‘å¡ä¸ºä¾‹ï¼Œæ¥ä¸€èµ·æ¢ç©¶ç½‘å¡æ”¶åŒ…è¿‡ç¨‹å§ğŸ˜€&lt;/p&gt;</description></item></channel></rss>